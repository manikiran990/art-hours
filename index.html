<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Art Hours">
<meta name="theme-color" content="#0e0e0f">
<meta name="description" content="Daily art practice tracker">
<title>Art Hours</title>
<link rel="manifest" href="./manifest.json">
<!-- Apple touch icon fallback (inline SVG as data URI) -->
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%230e0e0f'/><text x='50%' y='55%' font-size='100' text-anchor='middle' dominant-baseline='middle'>ðŸŽ¨</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0e0e0f;
  --surface: #17181a;
  --surface2: #1e1f22;
  --border: #2a2b2e;
  --green: #4ade80;
  --red: #f87171;
  --accent: #f5c842;
  --text: #e8e6e0;
  --muted: #6b6a65;
  --nav-h: 68px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-top: env(safe-area-inset-top, 0px);
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow-x: hidden; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Space Mono', monospace;
  padding-bottom: calc(var(--nav-h) + var(--safe-bottom) + 16px);
}

/* â”€â”€ HEADER â”€â”€ */
.header {
  padding: calc(16px + var(--safe-top)) 20px 14px;
  background: var(--bg);
  position: sticky;
  top: 0;
  z-index: 10;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  gap: 12px;
}

.header-left h1 {
  font-family: 'Playfair Display', serif;
  font-size: 1.9rem;
  font-weight: 900;
  color: var(--accent);
  letter-spacing: -0.5px;
  line-height: 1;
}
.header-left .subtitle {
  font-size: 0.58rem;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted);
  margin-top: 4px;
}

.header-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
  flex-shrink: 0;
}

/* Sync status pill */
.sync-pill {
  font-size: 0.55rem;
  letter-spacing: 1px;
  text-transform: uppercase;
  padding: 4px 10px;
  border-radius: 20px;
  border: 1px solid var(--border);
  color: var(--muted);
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.2s;
}
.sync-pill.syncing { border-color: var(--accent); color: var(--accent); }
.sync-pill.synced  { border-color: var(--green);  color: var(--green); }
.sync-pill.offline { border-color: var(--red);    color: var(--red); }
.sync-pill.nosync  { border-color: var(--border);  color: var(--muted); }

/* Install banner */
.install-banner {
  background: var(--surface);
  border: 1px solid var(--accent);
  margin: 12px 20px 0;
  padding: 12px 16px;
  display: none;
  align-items: center;
  gap: 12px;
  border-radius: 2px;
}
.install-banner.show { display: flex; }
.install-banner-text { flex: 1; font-size: 0.65rem; color: var(--text); line-height: 1.5; }
.install-banner-text strong { color: var(--accent); display: block; margin-bottom: 2px; }
.install-btn {
  background: var(--accent);
  color: var(--bg);
  border: none;
  font-family: 'Space Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 1px;
  text-transform: uppercase;
  padding: 8px 14px;
  cursor: pointer;
  border-radius: 2px;
  white-space: nowrap;
  flex-shrink: 0;
}
.install-dismiss {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 1.1rem;
  cursor: pointer;
  padding: 0 4px;
}

/* iOS install hint */
.ios-hint {
  background: var(--surface);
  border: 1px solid var(--border);
  margin: 12px 20px 0;
  padding: 12px 16px;
  display: none;
  border-radius: 2px;
}
.ios-hint.show { display: block; }
.ios-hint p { font-size: 0.62rem; color: var(--muted); line-height: 1.7; }
.ios-hint strong { color: var(--text); }

/* â”€â”€ PAGES â”€â”€ */
.page { display: none; padding: 20px; }
.page.active { display: block; }

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: calc(var(--nav-h) + var(--safe-bottom));
  background: var(--surface);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: flex-start;
  padding-top: 8px;
  z-index: 50;
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 6px 4px;
  cursor: pointer;
  border: none;
  background: none;
  color: var(--muted);
  font-family: 'Space Mono', monospace;
  font-size: 0.5rem;
  letter-spacing: 1px;
  text-transform: uppercase;
  transition: color 0.15s;
}
.nav-item.active { color: var(--accent); }
.nav-item svg { width: 22px; height: 22px; }

/* FAB */
.fab {
  position: fixed;
  bottom: calc(var(--nav-h) + var(--safe-bottom) + 16px);
  right: 20px;
  width: 56px; height: 56px;
  background: var(--accent);
  border-radius: 50%;
  border: none;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 20px rgba(245,200,66,0.4);
  z-index: 49;
  font-size: 1.6rem;
  color: var(--bg);
  transition: transform 0.15s, box-shadow 0.15s;
}
.fab:active { transform: scale(0.92); box-shadow: 0 2px 10px rgba(245,200,66,0.3); }

/* â”€â”€ STATS â”€â”€ */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 24px;
}
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 16px;
}
.stat-val {
  font-family: 'Playfair Display', serif;
  font-size: 2rem;
  font-weight: 700;
  color: var(--accent);
  line-height: 1;
}
.stat-label {
  font-size: 0.55rem;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted);
  margin-top: 6px;
}

/* â”€â”€ SECTION TITLE â”€â”€ */
.section-title {
  font-size: 0.6rem;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 14px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}

/* â”€â”€ CHART â”€â”€ */
.chart-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 24px; }
.chart-wrap { background: var(--surface); border: 1px solid var(--border); padding: 16px 16px 36px; }
.chart-inner { position: relative; height: 180px; min-width: 600px; }
.bars { position: absolute; inset: 0; display: flex; align-items: flex-end; gap: 2px; padding-bottom: 20px; }
.bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; position: relative; }
.bar { width: 100%; border-radius: 2px 2px 0 0; min-height: 4px; }
.bar:active { opacity: 0.7; }
.bar-label { font-size: 6px; color: var(--muted); white-space: nowrap; position: absolute; bottom: -18px; left: 50%; transform: rotate(-55deg); transform-origin: left center; }

/* â”€â”€ CALENDAR â”€â”€ */
.calendar-grid { display: flex; flex-direction: column; gap: 28px; }
.month-title { font-family: 'Playfair Display', serif; font-size: 1.2rem; color: var(--accent); margin-bottom: 10px; }
.week-days { display: grid; grid-template-columns: repeat(7,1fr); gap: 2px; margin-bottom: 2px; }
.wd { text-align:center; font-size:0.5rem; color:var(--muted); padding:3px 0; text-transform:uppercase; }
.cal-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 2px; }
.cal-day {
  background: var(--surface); border: 1px solid var(--border);
  padding: 5px 3px; min-height: 60px;
  display: flex; flex-direction: column; gap: 2px;
  position: relative; cursor: pointer; border-radius: 1px;
}
.cal-day:active { opacity: 0.7; }
.cal-day.empty { background: transparent; border-color: transparent; cursor: default; pointer-events: none; }
.cal-day.green { border-color: var(--green); background: rgba(74,222,128,0.07); }
.cal-day.red   { border-color: var(--red);   background: rgba(248,113,113,0.07); }
.cal-day-num { font-size: 0.58rem; color: var(--muted); }
.cal-day.green .cal-day-num { color: var(--green); }
.cal-day.red   .cal-day-num { color: var(--red); }
.cal-hours { font-family: 'Playfair Display', serif; font-size: 0.9rem; font-weight: 700; line-height: 1; }
.cal-day.green .cal-hours { color: var(--green); }
.cal-day.red   .cal-hours { color: var(--red); }
.cal-target { font-size: 0.5rem; color: var(--muted); }
.cal-weekday { font-size: 0.45rem; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); margin-top: auto; }
.cal-day.green .cal-weekday { color: rgba(74,222,128,0.5); }
.cal-day.red   .cal-weekday { color: rgba(248,113,113,0.4); }
.dot { width: 5px; height: 5px; border-radius: 50%; position: absolute; top: 4px; right: 4px; }
.green .dot { background: var(--green); }
.red   .dot { background: var(--red); }

/* â”€â”€ SLIDE-UP SHEET â”€â”€ */
.sheet-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.6); z-index: 100;
  align-items: flex-end; justify-content: center;
}
.sheet-overlay.open { display: flex; }
.sheet {
  background: var(--surface); border-top: 1px solid var(--border);
  border-radius: 16px 16px 0 0; padding: 0 24px calc(32px + var(--safe-bottom));
  width: 100%; max-width: 600px; max-height: 92vh; overflow-y: auto;
  animation: slideUp 0.25s ease-out;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.sheet-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 14px auto 20px; }
.sheet h2 { font-family: 'Playfair Display', serif; font-size: 1.3rem; color: var(--accent); margin-bottom: 20px; }

/* â”€â”€ FIELDS & BUTTONS â”€â”€ */
.field { margin-bottom: 16px; }
.field label { display: block; font-size: 0.58rem; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
.field input {
  width: 100%; background: var(--surface2); border: 1px solid var(--border);
  color: var(--text); font-family: 'Space Mono', monospace; font-size: 1rem;
  padding: 14px 12px; outline: none; border-radius: 2px; transition: border-color 0.15s; -webkit-appearance: none;
}
.field input:focus { border-color: var(--accent); }
.sheet-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
.btn {
  background: transparent; border: 1px solid var(--border); color: var(--text);
  font-family: 'Space Mono', monospace; font-size: 0.65rem; letter-spacing: 2px;
  text-transform: uppercase; padding: 12px 18px; cursor: pointer; border-radius: 2px;
  transition: all 0.15s; white-space: nowrap; min-height: 44px;
}
.btn:active { opacity: 0.7; }
.btn.primary { border-color: var(--accent); color: var(--accent); }
.btn.danger  { border-color: var(--red);    color: var(--red); }
.btn.green-btn { border-color: var(--green); color: var(--green); }
.btn.full { width: 100%; text-align: center; display: block; }

/* Backup rows */
.backup-row {
  display: flex; align-items: center; gap: 14px;
  background: var(--surface); border: 1px solid var(--border);
  padding: 16px; margin-bottom: 10px; border-radius: 2px; cursor: pointer;
}
.backup-row:active { opacity: 0.7; }
.backup-row-icon { font-size: 1.4rem; width: 32px; text-align: center; }
.backup-row-title { font-size: 0.75rem; color: var(--text); margin-bottom: 3px; }
.backup-row-desc  { font-size: 0.6rem;  color: var(--muted); }

.sheet-status { font-size: 0.65rem; margin-top: 14px; min-height: 18px; }

/* Toast */
.toast {
  position: fixed;
  bottom: calc(var(--nav-h) + var(--safe-bottom) + 20px);
  left: 50%; transform: translateX(-50%) translateY(10px);
  background: var(--surface); border: 1px solid var(--accent);
  color: var(--accent); font-size: 0.65rem; letter-spacing: 2px; text-transform: uppercase;
  padding: 12px 20px; opacity: 0; transition: opacity 0.25s, transform 0.25s;
  pointer-events: none; z-index: 200; white-space: nowrap; border-radius: 2px;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

.legend { display: flex; gap: 16px; margin-bottom: 14px; font-size: 0.6rem; color: var(--muted); align-items: center; }
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; }

@media (min-width: 600px) {
  .page { padding: 28px 32px; }
  .stats-grid { grid-template-columns: repeat(3,1fr); }
  .cal-day { min-height: 72px; }
}
@media (min-width: 900px) {
  .stats-grid { grid-template-columns: repeat(6,1fr); }
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <h1>Art Hours</h1>
    <div class="subtitle" id="dateRange">Daily Practice Logger</div>
  </div>
  <div class="header-right">
    <div class="sync-pill nosync" id="syncPill" onclick="showPage('backup')" title="Tap to manage sync">
      â—‹ no sync
    </div>
  </div>
</div>

<!-- Install prompts -->
<div class="install-banner" id="installBanner">
  <div class="install-banner-text">
    <strong>Add to Home Screen</strong>
    Install Art Hours for quick access & offline use
  </div>
  <button class="install-btn" onclick="triggerInstall()">Install</button>
  <button class="install-dismiss" onclick="dismissInstall()">âœ•</button>
</div>

<div class="ios-hint" id="iosHint">
  <p>To install: tap <strong>Share â†‘</strong> then <strong>"Add to Home Screen"</strong> â€” works offline once installed.</p>
</div>

<!-- PAGE: CALENDAR -->
<div class="page active" id="page-calendar">
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div> Met</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div> Missed</div>
    <span style="font-size:0.55rem;color:var(--muted)">Tap any day to log / edit</span>
  </div>
  <div class="calendar-grid" id="calendar"></div>
</div>

<!-- PAGE: CHART -->
<div class="page" id="page-chart">
  <div class="section-title">Daily Hours</div>
  <div class="chart-scroll">
    <div class="chart-wrap">
      <div class="chart-inner" id="chart"></div>
    </div>
  </div>
  <p style="font-size:0.6rem;color:var(--muted);text-align:center;margin-top:8px;">Grey = unlogged Â· Tap any bar to edit</p>
</div>

<!-- PAGE: ANALYSIS -->
<div class="page" id="page-analysis">
  <div class="section-title">Analysis</div>
  <div class="stats-grid" id="stats"></div>
</div>

<!-- PAGE: BACKUP -->
<div class="page" id="page-backup">
  <div class="section-title">Backup &amp; Restore</div>

  <div class="backup-row" onclick="exportCSV()">
    <div class="backup-row-icon">â†“</div>
    <div class="backup-row-text">
      <div class="backup-row-title">Download CSV</div>
      <div class="backup-row-desc">Save locally â€” open in Google Sheets or Excel</div>
    </div>
  </div>

  <div class="backup-row" onclick="document.getElementById('importFile').click()">
    <div class="backup-row-icon">â†‘</div>
    <div class="backup-row-text">
      <div class="backup-row-title">Restore from CSV</div>
      <div class="backup-row-desc">Import a previously exported file</div>
    </div>
  </div>
  <input type="file" id="importFile" accept=".csv" style="display:none" onchange="importCSV(event)">

  <div class="backup-row" onclick="openSheetSheet()">
    <div class="backup-row-icon">âŸ³</div>
    <div class="backup-row-text">
      <div class="backup-row-title">Google Sheets Sync</div>
      <div class="backup-row-desc">Connect to a live Google Sheet â€” auto-syncs on open</div>
    </div>
  </div>
</div>

<!-- FAB -->
<button class="fab" onclick="openLogSheet()" title="Log today">ï¼‹</button>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-item active" id="nav-calendar" onclick="showPage('calendar')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Calendar
  </button>
  <button class="nav-item" id="nav-chart" onclick="showPage('chart')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="12" width="4" height="9"/><rect x="10" y="6" width="4" height="15"/><rect x="17" y="3" width="4" height="18"/></svg>
    Chart
  </button>
  <button class="nav-item" id="nav-analysis" onclick="showPage('analysis')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="9"/><path d="M12 8v4l3 3"/></svg>
    Analysis
  </button>
  <button class="nav-item" id="nav-backup" onclick="showPage('backup')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="8 17 12 21 16 17"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.88 18.09A5 5 0 0018 9h-1.26A8 8 0 103 16.29"/></svg>
    Backup
  </button>
</nav>

<!-- LOG / EDIT SHEET -->
<div class="sheet-overlay" id="logOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h2 id="logTitle">Log Entry</h2>
    <div class="field"><label>Date</label><input type="date" id="inputDate"></div>
    <div class="field"><label>Hours Completed</label><input type="number" id="inputHours" min="0" max="24" step="0.25" inputmode="decimal" placeholder="e.g. 5"></div>
    <div class="field"><label>Target Hours</label><input type="number" id="inputTarget" min="0" max="24" step="0.25" inputmode="decimal" placeholder="e.g. 5"></div>
    <div class="sheet-actions">
      <button class="btn primary" style="flex:1" onclick="saveEntry()">Save</button>
      <button class="btn" onclick="closeLogSheet()">Cancel</button>
      <button class="btn danger" id="deleteBtn" onclick="deleteEntry()" style="display:none">Delete</button>
    </div>
  </div>
</div>

<!-- GOOGLE SHEETS SHEET -->
<div class="sheet-overlay" id="sheetOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h2>Google Sheets Sync</h2>

    <div style="font-size:0.62rem;color:var(--muted);line-height:1.8;margin-bottom:16px;background:var(--surface2);padding:14px;border-radius:2px;border:1px solid var(--border)">
      <strong style="color:var(--accent);display:block;margin-bottom:6px">Auto-sync is ON once URL is saved</strong>
      The app will sync automatically every time you open it.<br>
      To set up: deploy <strong style="color:var(--text)">ArtHoursSync.gs</strong> in your Google Sheet, then paste the Web App URL below.
    </div>

    <div class="field"><label>Web App URL</label><input type="url" id="sheetUrl" placeholder="https://script.google.com/macros/s/..."></div>

    <div class="sheet-actions" style="flex-direction:column;gap:8px;">
      <button class="btn primary full" onclick="gsheetSync(true)">âŸ³ Sync Now</button>
      <button class="btn full" onclick="gsheetLoad()">â†“ Load from Sheet</button>
      <button class="btn full" onclick="gsheetBackup()">â†‘ Full Backup to Sheet</button>
      <button class="btn danger full" onclick="clearSheetUrl()">âœ• Disconnect Sheet</button>
      <button class="btn full" onclick="closeSheetSheet()">Close</button>
    </div>
    <div class="sheet-status" id="sheetStatus"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ SEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEED = [
  {date:'2025-12-15',hours:1.17,target:5},{date:'2025-12-16',hours:5,target:5},
  {date:'2025-12-17',hours:5,target:5},{date:'2025-12-18',hours:5.5,target:5},
  {date:'2025-12-19',hours:5.5,target:5},{date:'2025-12-20',hours:12,target:12},
  {date:'2025-12-21',hours:12,target:12},{date:'2025-12-22',hours:2.5,target:5},
  {date:'2025-12-23',hours:6,target:5},{date:'2025-12-24',hours:6,target:5},
  {date:'2025-12-25',hours:12,target:12},{date:'2025-12-26',hours:7.17,target:5},
  {date:'2025-12-27',hours:12,target:12},{date:'2025-12-28',hours:1,target:12},
  {date:'2025-12-29',hours:5,target:5},{date:'2025-12-30',hours:5,target:5},
  {date:'2025-12-31',hours:5.6,target:5},{date:'2026-01-01',hours:5.25,target:5},
  {date:'2026-01-02',hours:6,target:5},{date:'2026-01-03',hours:12,target:12},
  {date:'2026-01-04',hours:12,target:12},{date:'2026-01-05',hours:5,target:5},
  {date:'2026-01-06',hours:5,target:5},{date:'2026-01-07',hours:5,target:5},
  {date:'2026-01-08',hours:5,target:5},{date:'2026-01-09',hours:1.5,target:1},
  {date:'2026-01-10',hours:1.5,target:1},{date:'2026-01-11',hours:1,target:1},
  {date:'2026-01-12',hours:1.2,target:1},{date:'2026-01-13',hours:1,target:1},
  {date:'2026-01-14',hours:1.33,target:1},{date:'2026-01-15',hours:1.1,target:1},
  {date:'2026-01-16',hours:1.2,target:1},{date:'2026-01-17',hours:1,target:1},
  {date:'2026-01-18',hours:1,target:1},{date:'2026-01-19',hours:1,target:1},
  {date:'2026-01-20',hours:1,target:1},{date:'2026-01-21',hours:1,target:1},
  {date:'2026-01-22',hours:1,target:1},{date:'2026-01-23',hours:1,target:1},
  {date:'2026-01-24',hours:1,target:1},{date:'2026-01-25',hours:1,target:1},
  {date:'2026-01-26',hours:1,target:1},{date:'2026-01-27',hours:1,target:5},
  {date:'2026-01-28',hours:4,target:5},{date:'2026-01-29',hours:1,target:5},
  {date:'2026-01-30',hours:1,target:5},{date:'2026-01-31',hours:2.75,target:12},
  {date:'2026-02-01',hours:12,target:12},{date:'2026-02-02',hours:1,target:5},
  {date:'2026-02-03',hours:5,target:5},{date:'2026-02-04',hours:5,target:5},
  {date:'2026-02-05',hours:5,target:5},{date:'2026-02-06',hours:2.5,target:5},
  {date:'2026-02-07',hours:8,target:12},{date:'2026-02-08',hours:12,target:12},
  {date:'2026-02-09',hours:5,target:5},{date:'2026-02-24',hours:5,target:5},
];

const STORAGE_KEY  = 'art_hours_v1';
const SHEET_URL_KEY = 'art_hours_sheet_url';
const DAYS   = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

function toISO(dt) { return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`; }
function toDDMMYYYY(s) { const dt=new Date(s+'T00:00:00'); return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`; }
function normalize(e) { const dt=new Date(e.date+'T00:00:00'); return {date:e.date,day:DAYS[dt.getDay()],hours:+e.hours,target:+e.target,result:+e.hours>=+e.target?'ðŸŸ¢':'ðŸ”´'}; }
function loadData() { try{const r=localStorage.getItem(STORAGE_KEY);if(r)return JSON.parse(r);}catch(e){} const d=SEED.map(normalize);localStorage.setItem(STORAGE_KEY,JSON.stringify(d));return d; }
function saveData() { localStorage.setItem(STORAGE_KEY,JSON.stringify(data)); }

let data = loadData();
let currentPage = 'calendar';

// â”€â”€ SERVICE WORKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(reg => {
      console.log('SW registered');
      // Listen for sync success messages from SW
      navigator.serviceWorker.addEventListener('message', e => {
        if (e.data && e.data.type === 'SYNC_SUCCESS') {
          setSyncPill('synced', 'âœ“ synced');
          showToast('Auto-synced to Sheets âœ“');
        }
      });
    }).catch(err => console.warn('SW failed:', err));
  });
}

// â”€â”€ PWA INSTALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredInstallPrompt = e;
  // Show install banner unless dismissed before
  if (!localStorage.getItem('install_dismissed')) {
    document.getElementById('installBanner').classList.add('show');
  }
});

window.addEventListener('appinstalled', () => {
  document.getElementById('installBanner').classList.remove('show');
  showToast('App installed âœ“');
  deferredInstallPrompt = null;
});

function triggerInstall() {
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  deferredInstallPrompt.userChoice.then(choice => {
    if (choice.outcome === 'accepted') showToast('Installingâ€¦');
    deferredInstallPrompt = null;
    document.getElementById('installBanner').classList.remove('show');
  });
}

function dismissInstall() {
  document.getElementById('installBanner').classList.remove('show');
  localStorage.setItem('install_dismissed', '1');
}

// Detect iOS for manual install hint
function isIOS() { return /iphone|ipad|ipod/i.test(navigator.userAgent) && !window.MSStream; }
function isInStandaloneMode() { return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone; }

if (isIOS() && !isInStandaloneMode() && !localStorage.getItem('ios_hint_dismissed')) {
  document.getElementById('iosHint').classList.add('show');
  setTimeout(() => {
    document.getElementById('iosHint').classList.remove('show');
    localStorage.setItem('ios_hint_dismissed', '1');
  }, 8000);
}

// â”€â”€ AUTO-SYNC ON OPEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => {
  const url = localStorage.getItem(SHEET_URL_KEY);
  if (url && navigator.onLine) {
    setSyncPill('syncing', 'âŸ³ syncingâ€¦');
    setTimeout(() => autoSync(url), 1200); // slight delay after paint
  } else if (url && !navigator.onLine) {
    setSyncPill('offline', 'âœ• offline');
  } else {
    setSyncPill('nosync', 'â—‹ no sync');
  }
});

window.addEventListener('online',  () => { const u=localStorage.getItem(SHEET_URL_KEY); if(u){setSyncPill('syncing','âŸ³ syncingâ€¦');autoSync(u);}});
window.addEventListener('offline', () => setSyncPill('offline','âœ• offline'));

async function autoSync(url) {
  try {
    const res = await fetch(url, {
      method: 'POST',
      body: JSON.stringify({ action: 'sync', data }),
      headers: { 'Content-Type': 'application/json' }
    });
    const json = await res.json();
    if (json.error) throw new Error(json.error);
    setSyncPill('synced', `âœ“ synced`);
    // Also queue a background sync for when offline
    if ('serviceWorker' in navigator && 'SyncManager' in window) {
      const reg = await navigator.serviceWorker.ready;
      await queuePendingSync(url);
      await reg.sync.register('sync-sheets');
    }
  } catch(e) {
    setSyncPill('offline', 'âœ• sync failed');
  }
}

async function queuePendingSync(url) {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('art-hours-sw', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('pending', { autoIncrement: true });
    req.onsuccess = e => {
      const db = e.target.result;
      const tx = db.transaction('pending', 'readwrite');
      const store = tx.objectStore('pending');
      store.clear();
      store.add({ url, data });
      tx.oncomplete = resolve;
      tx.onerror = reject;
    };
    req.onerror = reject;
  });
}

function setSyncPill(state, label) {
  const pill = document.getElementById('syncPill');
  pill.className = `sync-pill ${state}`;
  pill.textContent = label;
}

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(name) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
  currentPage = name;
  if (name==='chart') renderChart();
  window.scrollTo(0,0);
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  data.sort((a,b)=>a.date.localeCompare(b.date));
  renderStats(); renderCalendar();
  if (currentPage==='chart') renderChart();
  if (data.length) document.getElementById('dateRange').textContent = `${toDDMMYYYY(data[0].date)} â†’ ${toDDMMYYYY(data[data.length-1].date)}`;
}

function renderStats() {
  const total=data.reduce((s,d)=>s+d.hours,0);
  const green=data.filter(d=>d.result==='ðŸŸ¢').length;
  const red=data.filter(d=>d.result==='ðŸ”´').length;
  let best=0,cur=0;
  for(const d of data){if(d.result==='ðŸŸ¢'){cur++;best=Math.max(best,cur);}else cur=0;}
  let current=0;
  for(let i=data.length-1;i>=0;i--){if(data[i].result==='ðŸŸ¢')current++;else break;}
  const pct=data.length?Math.round(green/data.length*100):0;
  // Art Debt = sum of (target - hours) for all missed days
  const debt=data.filter(d=>d.result==='ðŸ”´').reduce((s,d)=>s+(d.target-d.hours),0);
  document.getElementById('stats').innerHTML=`
    <div class="stat-card"><div class="stat-val">${total.toFixed(1)}h</div><div class="stat-label">Total Hours</div></div>
    <div class="stat-card"><div class="stat-val">${data.length}</div><div class="stat-label">Days Logged</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--green)">${green}</div><div class="stat-label">Days Met</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--red)">${red}</div><div class="stat-label">Days Missed</div></div>
    <div class="stat-card"><div class="stat-val">${best}</div><div class="stat-label">Best Streak</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--green)">${current}</div><div class="stat-label">Current Streak</div></div>
    <div class="stat-card"><div class="stat-val">${pct}%</div><div class="stat-label">Success Rate</div></div>
    <div class="stat-card"><div class="stat-val">${data.length?(total/data.length).toFixed(1):'0'}h</div><div class="stat-label">Daily Avg</div></div>
    <div class="stat-card" style="grid-column:1/-1;border-color:var(--red);background:rgba(248,113,113,0.06)">
      <div class="stat-val" style="color:var(--red);font-size:2.4rem">${debt.toFixed(1)}h</div>
      <div class="stat-label" style="color:var(--red)">ðŸŽ¨ Art Debt â€” total hours missed</div>
    </div>
  `;
}

function renderChart() {
  const el=document.getElementById('chart'); el.innerHTML='';
  if(!data.length) return;
  const sorted=[...data].sort((a,b)=>a.date.localeCompare(b.date));
  const startDt=new Date(sorted[0].date+'T00:00:00');
  const endDt=new Date(sorted[sorted.length-1].date+'T00:00:00');
  const dataMap={}; sorted.forEach(d=>dataMap[d.date]=d);
  const allDays=[];
  for(let dt=new Date(startDt);dt<=endDt;dt.setDate(dt.getDate()+1)){
    const ds=toISO(dt); allDays.push({dateStr:ds,entry:dataMap[ds]||null});
  }
  const maxH=Math.max(...sorted.map(d=>d.hours),1);
  const bars=document.createElement('div'); bars.className='bars';
  allDays.forEach(({dateStr,entry})=>{
    const wrap=document.createElement('div'); wrap.className='bar-wrap';
    const bar=document.createElement('div'); bar.className='bar';
    const ddmm=toDDMMYYYY(dateStr).slice(0,5);
    if(entry){
      bar.style.height=`${(entry.hours/maxH)*100}%`;
      bar.style.background=entry.result==='ðŸŸ¢'?'var(--green)':'var(--red)';
      bar.style.opacity='0.85';
      bar.title=`${toDDMMYYYY(dateStr)}: ${entry.hours}h / ${entry.target}h`;
      bar.onclick=()=>openLogSheet(entry.date);
    } else {
      bar.style.height='6px';
      bar.style.background='var(--border)';
      bar.title=`${toDDMMYYYY(dateStr)}: not logged`;
      bar.onclick=()=>openLogSheet(dateStr,true);
    }
    const label=document.createElement('span'); label.className='bar-label'; label.textContent=ddmm;
    wrap.appendChild(bar); wrap.appendChild(label); bars.appendChild(wrap);
  });
  el.appendChild(bars);
}

function renderCalendar() {
  const calEl=document.getElementById('calendar'); calEl.innerHTML='';
  const months={};
  data.forEach(d=>{
    const dt=new Date(d.date+'T00:00:00');
    const key=`${dt.getFullYear()}-${String(dt.getMonth()).padStart(2,'0')}`;
    if(!months[key]) months[key]={year:dt.getFullYear(),month:dt.getMonth(),days:{}};
    months[key].days[dt.getDate()]=d;
  });
  Object.keys(months).sort().forEach(key=>{
    const m=months[key];
    const block=document.createElement('div');
    const title=document.createElement('div'); title.className='month-title';
    title.textContent=`${MONTHS[m.month]} ${m.year}`; block.appendChild(title);
    const wdRow=document.createElement('div'); wdRow.className='week-days';
    DAYS.forEach(dn=>{const w=document.createElement('div');w.className='wd';w.textContent=dn.slice(0,1);wdRow.appendChild(w);});
    block.appendChild(wdRow);
    const grid=document.createElement('div'); grid.className='cal-grid';
    const firstDay=new Date(m.year,m.month,1).getDay();
    for(let i=0;i<firstDay;i++){const e=document.createElement('div');e.className='cal-day empty';grid.appendChild(e);}
    const total=new Date(m.year,m.month+1,0).getDate();
    for(let d=1;d<=total;d++){
      const cell=document.createElement('div');
      const entry=m.days[d];
      const dateStr=`${m.year}-${String(m.month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      if(entry){
        cell.className=`cal-day ${entry.result==='ðŸŸ¢'?'green':'red'}`;
        cell.innerHTML=`<div class="dot"></div><div class="cal-day-num">${d}</div><div class="cal-hours">${entry.hours}h</div><div class="cal-target">/${entry.target}h</div><div class="cal-weekday">${entry.day}</div>`;
        cell.onclick=()=>openLogSheet(entry.date);
      } else {
        cell.className='cal-day';
        cell.innerHTML=`<div class="cal-day-num">${d}</div>`;
        cell.onclick=()=>openLogSheet(dateStr,true);
      }
      grid.appendChild(cell);
    }
    block.appendChild(grid); calEl.appendChild(block);
  });
}

// â”€â”€ LOG SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let editingDate=null;

function openLogSheet(dateStr=null,blank=false){
  editingDate=null;
  const existing=dateStr?data.find(d=>d.date===dateStr):null;
  if(existing){
    editingDate=existing.date;
    document.getElementById('logTitle').textContent=`Edit â€” ${toDDMMYYYY(existing.date)}`;
    document.getElementById('inputDate').value=existing.date;
    document.getElementById('inputDate').readOnly=true;
    document.getElementById('inputHours').value=existing.hours;
    document.getElementById('inputTarget').value=existing.target;
    document.getElementById('deleteBtn').style.display='block';
  } else {
    const today=new Date(); const todayStr=toISO(today);
    document.getElementById('logTitle').textContent='Log Entry';
    document.getElementById('inputDate').value=dateStr||todayStr;
    document.getElementById('inputDate').readOnly=!!dateStr&&!blank;
    document.getElementById('inputHours').value='';
    document.getElementById('inputTarget').value='';
    document.getElementById('deleteBtn').style.display='none';
  }
  document.getElementById('logOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('inputHours').focus(),100);
}

function closeLogSheet(){
  document.getElementById('logOverlay').classList.remove('open');
  document.getElementById('inputDate').readOnly=false;
}

function saveEntry(){
  const dateVal=document.getElementById('inputDate').value;
  const hoursVal=parseFloat(document.getElementById('inputHours').value);
  const targetVal=parseFloat(document.getElementById('inputTarget').value);
  if(!dateVal||isNaN(hoursVal)||isNaN(targetVal)){showToast('Fill in all fields');return;}
  const entry=normalize({date:dateVal,hours:hoursVal,target:targetVal});
  if(editingDate){const idx=data.findIndex(d=>d.date===editingDate);if(idx>=0)data[idx]=entry;}
  else{const idx=data.findIndex(d=>d.date===dateVal);if(idx>=0)data[idx]=entry;else data.push(entry);}
  saveData(); closeLogSheet(); render();
  showToast(editingDate?'Updated âœ“':'Saved âœ“');
  // Trigger auto-sync after save
  const url=localStorage.getItem(SHEET_URL_KEY);
  if(url&&navigator.onLine){setSyncPill('syncing','âŸ³ syncingâ€¦');autoSync(url);}
}

function deleteEntry(){
  if(!editingDate||!confirm(`Delete ${toDDMMYYYY(editingDate)}?`))return;
  data=data.filter(d=>d.date!==editingDate);
  saveData(); closeLogSheet(); render(); showToast('Deleted');
  const url=localStorage.getItem(SHEET_URL_KEY);
  if(url&&navigator.onLine){setSyncPill('syncing','âŸ³ syncingâ€¦');autoSync(url);}
}

// â”€â”€ CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV(){
  const rows=['Date,Day,Hours,Target,Result'];
  data.forEach(d=>rows.push(`${d.date},${d.day},${d.hours},${d.target},${d.result==='ðŸŸ¢'?'Met':'Missed'}`));
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='art_hours_backup.csv';a.click();
  URL.revokeObjectURL(url);showToast('CSV downloaded âœ“');
}

function importCSV(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const lines=ev.target.result.trim().split('\n');let count=0;
    lines.slice(1).forEach(line=>{
      const p=line.split(',');
      if(p.length>=4){const date=p[0].trim(),hours=parseFloat(p[2]),target=parseFloat(p[3]);
        if(date&&!isNaN(hours)&&!isNaN(target)){const entry=normalize({date,hours,target});
          const idx=data.findIndex(d=>d.date===date);if(idx>=0)data[idx]=entry;else data.push(entry);count++;}}
    });
    if(!count){showToast('No valid rows found');return;}
    saveData();render();showToast(`Imported ${count} entries âœ“`);
  };
  reader.readAsText(file);e.target.value='';
}

// â”€â”€ GOOGLE SHEETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSheetSheet(){
  const saved=localStorage.getItem(SHEET_URL_KEY)||'';
  document.getElementById('sheetUrl').value=saved;
  document.getElementById('sheetStatus').textContent='';
  document.getElementById('sheetOverlay').classList.add('open');
}
function closeSheetSheet(){document.getElementById('sheetOverlay').classList.remove('open');}

function getSheetUrl(){
  const url=document.getElementById('sheetUrl').value.trim();
  if(!url){setSheetStatus('âš  Enter your Web App URL','var(--red)');return null;}
  localStorage.setItem(SHEET_URL_KEY,url);return url;
}
function setSheetStatus(msg,color='var(--muted)'){
  const el=document.getElementById('sheetStatus');el.textContent=msg;el.style.color=color;
}

async function gsheetSync(silent=false){
  const url=getSheetUrl();if(!url)return;
  if(!silent)setSheetStatus('Syncingâ€¦');
  setSyncPill('syncing','âŸ³ syncingâ€¦');
  try{
    const res=await fetch(url,{method:'POST',body:JSON.stringify({action:'sync',data}),headers:{'Content-Type':'application/json'}});
    const json=await res.json();
    if(json.error)throw new Error(json.error);
    setSyncPill('synced','âœ“ synced');
    if(!silent){setSheetStatus(`âœ“ Synced ${json.synced} entries (${json.appended} new, ${json.updated} updated)`,'var(--green)');}
    showToast('Synced to Sheets âœ“');
  }catch(e){setSyncPill('offline','âœ• sync failed');if(!silent)setSheetStatus(`âœ— ${e.message}`,'var(--red)');}
}

async function gsheetLoad(){
  const url=getSheetUrl();if(!url)return;
  setSheetStatus('Loadingâ€¦');
  try{
    const res=await fetch(url,{method:'POST',body:JSON.stringify({action:'load'}),headers:{'Content-Type':'application/json'}});
    const json=await res.json();
    if(json.error)throw new Error(json.error);
    if(!json.data||!json.data.length){setSheetStatus('Sheet is empty','var(--accent)');return;}
    json.data.forEach(imp=>{const idx=data.findIndex(d=>d.date===imp.date);if(idx>=0)data[idx]=normalize(imp);else data.push(normalize(imp));});
    saveData();render();
    setSheetStatus(`âœ“ Loaded ${json.data.length} entries`,'var(--green)');showToast('Loaded from Sheets âœ“');
  }catch(e){setSheetStatus(`âœ— ${e.message}`,'var(--red)');}
}

async function gsheetBackup(){
  const url=getSheetUrl();if(!url)return;
  if(!confirm('Overwrite your Google Sheet with all local data?'))return;
  setSheetStatus('Backing upâ€¦');
  try{
    const res=await fetch(url,{method:'POST',body:JSON.stringify({action:'backup',data}),headers:{'Content-Type':'application/json'}});
    const json=await res.json();
    if(json.error)throw new Error(json.error);
    setSheetStatus(`âœ“ Backup complete â€” ${json.written} rows`,'var(--green)');showToast('Backed up âœ“');
  }catch(e){setSheetStatus(`âœ— ${e.message}`,'var(--red)');}
}

function clearSheetUrl(){
  localStorage.removeItem(SHEET_URL_KEY);
  document.getElementById('sheetUrl').value='';
  setSheetStatus('Disconnected');
  setSyncPill('nosync','â—‹ no sync');
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

// â”€â”€ KEYBOARD & GESTURES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closeLogSheet();closeSheetSheet();}
  if(e.key==='Enter'&&document.getElementById('logOverlay').classList.contains('open'))saveEntry();
});
document.getElementById('logOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeLogSheet();});
document.getElementById('sheetOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeSheetSheet();});

render();
</script>
</body>
</html>
