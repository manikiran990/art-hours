<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Art Hours">
<meta name="theme-color" content="#0e0e0f">
<title>Art Hours</title>
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%230e0e0f'/><text x='50%' y='55%' font-size='100' text-anchor='middle' dominant-baseline='middle'>üé®</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e0e0f;--surface:#17181a;--surface2:#1e1f22;--border:#2a2b2e;
  --green:#4ade80;--red:#f87171;--accent:#f5c842;--text:#e8e6e0;--muted:#6b6a65;
  --nav-h:68px;--safe-bottom:env(safe-area-inset-bottom,0px);--safe-top:env(safe-area-inset-top,0px);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow-x:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Space Mono',monospace;padding-bottom:calc(var(--nav-h) + var(--safe-bottom) + 16px);}

/* HEADER */
.header{padding:calc(16px + var(--safe-top)) 20px 14px;background:var(--bg);position:sticky;top:0;z-index:10;border-bottom:1px solid var(--border);display:flex;align-items:flex-end;justify-content:space-between;gap:12px;}
.header-left h1{font-family:'Playfair Display',serif;font-size:1.9rem;font-weight:900;color:var(--accent);letter-spacing:-0.5px;line-height:1;}
.header-left .subtitle{font-size:0.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:4px;}
.header-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0;}
.sync-pill{font-size:0.55rem;letter-spacing:1px;text-transform:uppercase;padding:4px 10px;border-radius:20px;border:1px solid var(--border);color:var(--muted);white-space:nowrap;cursor:pointer;transition:all 0.2s;}
.sync-pill.syncing{border-color:var(--accent);color:var(--accent);}
.sync-pill.synced{border-color:var(--green);color:var(--green);}
.sync-pill.offline{border-color:var(--red);color:var(--red);}
.sync-pill.nosync{border-color:var(--border);color:var(--muted);}
.level-badge{font-size:0.6rem;letter-spacing:1px;padding:4px 10px;border-radius:20px;border:1px solid var(--accent);color:var(--accent);white-space:nowrap;cursor:pointer;}

/* INSTALL */
.install-banner{background:var(--surface);border:1px solid var(--accent);margin:12px 20px 0;padding:12px 16px;display:none;align-items:center;gap:12px;border-radius:2px;}
.install-banner.show{display:flex;}
.install-banner-text{flex:1;font-size:0.65rem;color:var(--text);line-height:1.5;}
.install-banner-text strong{color:var(--accent);display:block;margin-bottom:2px;}
.install-btn{background:var(--accent);color:var(--bg);border:none;font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:1px;text-transform:uppercase;padding:8px 14px;cursor:pointer;border-radius:2px;white-space:nowrap;flex-shrink:0;}
.install-dismiss{background:none;border:none;color:var(--muted);font-size:1.1rem;cursor:pointer;padding:0 4px;}
.ios-hint{background:var(--surface);border:1px solid var(--border);margin:12px 20px 0;padding:12px 16px;display:none;border-radius:2px;}
.ios-hint.show{display:block;}
.ios-hint p{font-size:0.62rem;color:var(--muted);line-height:1.7;}
.ios-hint strong{color:var(--text);}

/* PAGES */
.page{display:none;padding:20px;}
.page.active{display:block;}

/* NAV */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;height:calc(var(--nav-h) + var(--safe-bottom));background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:flex-start;padding-top:8px;z-index:50;}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 4px;cursor:pointer;border:none;background:none;color:var(--muted);font-family:'Space Mono',monospace;font-size:0.45rem;letter-spacing:1px;text-transform:uppercase;transition:color 0.15s;}
.nav-item.active{color:var(--accent);}
.nav-item svg{width:20px;height:20px;}

/* FAB */
.fab{position:fixed;bottom:calc(var(--nav-h) + var(--safe-bottom) + 16px);right:20px;width:56px;height:56px;background:var(--accent);border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(245,200,66,0.4);z-index:49;font-size:1.6rem;color:var(--bg);transition:transform 0.15s;}
.fab:active{transform:scale(0.92);}

/* SECTION TITLE */
.section-title{font-size:0.6rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);}

/* STATS GRID */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:24px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:2px;padding:16px;}
.stat-val{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;color:var(--accent);line-height:1;}
.stat-label{font-size:0.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:6px;}

/* PROGRESS BARS */
.progress-wrap{margin-bottom:20px;}
.progress-title{font-size:0.6rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.progress-bar-bg{background:var(--surface2);border-radius:2px;height:10px;overflow:hidden;margin-bottom:4px;}
.progress-bar-fill{height:100%;border-radius:2px;transition:width 0.4s ease;}
.progress-meta{display:flex;justify-content:space-between;font-size:0.58rem;color:var(--muted);}

/* LEVEL CARD */
.level-card{background:var(--surface);border:2px solid var(--accent);border-radius:2px;padding:20px;margin-bottom:24px;position:relative;overflow:hidden;}
.level-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--green));}
.level-name{font-family:'Playfair Display',serif;font-size:1.6rem;color:var(--accent);margin-bottom:4px;}
.level-num{font-size:0.6rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);}
.level-progress-bg{background:var(--surface2);border-radius:2px;height:8px;margin:12px 0 6px;}
.level-progress-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--green));}
.level-progress-meta{display:flex;justify-content:space-between;font-size:0.58rem;color:var(--muted);}

/* BADGES */
.badges-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:24px;}
.badge{background:var(--surface);border:1px solid var(--border);border-radius:2px;padding:12px 8px;text-align:center;transition:all 0.2s;cursor:pointer;}
.badge.earned{border-color:var(--accent);background:rgba(245,200,66,0.06);}
.badge-icon{font-size:1.6rem;display:block;margin-bottom:6px;filter:grayscale(1);opacity:0.3;}
.badge.earned .badge-icon{filter:none;opacity:1;}
.badge-name{font-size:0.5rem;letter-spacing:1px;text-transform:uppercase;color:var(--muted);line-height:1.4;}
.badge.earned .badge-name{color:var(--text);}

/* STREAK COMPARE */
.streak-compare{background:var(--surface);border:1px solid var(--border);border-radius:2px;padding:16px;margin-bottom:24px;}
.streak-compare-title{font-size:0.6rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}
.streak-bars{display:flex;gap:16px;align-items:flex-end;height:80px;margin-bottom:8px;}
.streak-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;}
.streak-bar{width:100%;border-radius:2px 2px 0 0;transition:height 0.4s ease;}
.streak-bar-label{font-size:0.55rem;color:var(--muted);text-align:center;}
.streak-bar-val{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--accent);}

/* MONTHLY CARDS */
.monthly-cards{display:flex;flex-direction:column;gap:16px;margin-bottom:24px;}
.month-card{background:var(--surface);border:1px solid var(--border);border-radius:2px;padding:16px;}
.month-card-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:12px;}
.month-card-name{font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--accent);}
.month-card-total{font-size:0.65rem;color:var(--muted);}
.month-card-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;}
.month-stat{text-align:center;}
.month-stat-val{font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--text);}
.month-stat-label{font-size:0.48rem;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
.month-mini-chart{display:flex;align-items:flex-end;gap:1px;height:28px;}
.month-mini-bar{flex:1;border-radius:1px 1px 0 0;min-height:2px;}

/* PIE CHART */
.pie-section{margin-bottom:24px;}
.pie-toggle{display:flex;gap:8px;margin-bottom:14px;}
.pie-tab{flex:1;text-align:center;font-size:0.58rem;letter-spacing:1px;text-transform:uppercase;padding:8px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;border-radius:2px;font-family:'Space Mono',monospace;}
.pie-tab.active{border-color:var(--accent);color:var(--accent);}
.pie-wrap{display:flex;flex-direction:column;align-items:center;gap:16px;}
.pie-legend{width:100%;display:flex;flex-direction:column;gap:8px;}
.pie-legend-item{display:flex;align-items:center;gap:10px;font-size:0.62rem;}
.pie-legend-dot{width:12px;height:12px;border-radius:2px;flex-shrink:0;}
.pie-legend-name{flex:1;color:var(--text);}
.pie-legend-val{color:var(--muted);}
.pie-empty{text-align:center;color:var(--muted);font-size:0.7rem;padding:40px 0;}

/* CHART */
.chart-tabs{display:flex;gap:8px;margin-bottom:14px;}
.chart-tab{flex:1;text-align:center;font-size:0.58rem;letter-spacing:1px;text-transform:uppercase;padding:8px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;border-radius:2px;font-family:'Space Mono',monospace;}
.chart-tab.active{border-color:var(--accent);color:var(--accent);}
.chart-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;margin-bottom:24px;}
.chart-wrap{background:var(--surface);border:1px solid var(--border);padding:16px 16px 36px;}
.chart-inner{position:relative;height:180px;min-width:600px;}
.bars{position:absolute;inset:0;display:flex;align-items:flex-end;gap:2px;padding-bottom:20px;}
.bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%;position:relative;}
.bar{width:100%;border-radius:2px 2px 0 0;min-height:4px;cursor:default;}
.bar-label{font-size:6px;color:var(--muted);white-space:nowrap;position:absolute;bottom:-18px;left:50%;transform:rotate(-55deg);transform-origin:left center;}
.cum-chart{position:relative;height:180px;min-width:600px;}

/* CALENDAR */
.calendar-grid{display:flex;flex-direction:column;gap:28px;}
.month-title{font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--accent);margin-bottom:10px;}
.week-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:2px;}
.wd{text-align:center;font-size:0.5rem;color:var(--muted);padding:3px 0;text-transform:uppercase;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.cal-day{background:var(--surface);border:1px solid var(--border);padding:5px 3px;min-height:60px;display:flex;flex-direction:column;gap:2px;position:relative;cursor:pointer;border-radius:1px;}
.cal-day:active{opacity:0.7;}
.cal-day.empty{background:transparent;border-color:transparent;cursor:default;pointer-events:none;}
.cal-day.green{border-color:var(--green);background:rgba(74,222,128,0.07);}
.cal-day.red{border-color:var(--red);background:rgba(248,113,113,0.07);}
.cal-day-num{font-size:0.58rem;color:var(--muted);}
.cal-day.green .cal-day-num{color:var(--green);}
.cal-day.red .cal-day-num{color:var(--red);}
.cal-hours{font-family:'Playfair Display',serif;font-size:0.9rem;font-weight:700;line-height:1;}
.cal-day.green .cal-hours{color:var(--green);}
.cal-day.red .cal-hours{color:var(--red);}
.cal-target{font-size:0.5rem;color:var(--muted);}
.cal-weekday{font-size:0.45rem;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-top:auto;}
.dot{width:5px;height:5px;border-radius:50%;position:absolute;top:4px;right:4px;}
.green .dot{background:var(--green);}
.red .dot{background:var(--red);}
.legend{display:flex;gap:16px;margin-bottom:14px;font-size:0.6rem;color:var(--muted);align-items:center;}
.legend-item{display:flex;align-items:center;gap:5px;}
.legend-dot{width:8px;height:8px;border-radius:50%;}

/* SETTINGS */
.settings-section{margin-bottom:28px;}
.settings-row{display:flex;align-items:center;justify-content:space-between;background:var(--surface);border:1px solid var(--border);padding:14px 16px;margin-bottom:8px;border-radius:2px;cursor:pointer;gap:12px;}
.settings-row:active{opacity:0.7;}
.settings-row-left{flex:1;}
.settings-row-title{font-size:0.75rem;color:var(--text);margin-bottom:3px;}
.settings-row-desc{font-size:0.6rem;color:var(--muted);}
.settings-row-val{font-size:0.7rem;color:var(--accent);white-space:nowrap;}

/* TARGET GRID */
.target-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:16px;}
.target-day-cell{display:flex;flex-direction:column;align-items:center;gap:4px;}
.target-day-label{font-size:0.5rem;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
.target-day-input{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.7rem;padding:8px 4px;text-align:center;outline:none;border-radius:2px;-webkit-appearance:none;}
.target-day-input:focus{border-color:var(--accent);}
.target-quick{display:flex;gap:8px;margin-bottom:16px;}
.target-quick-btn{flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-family:'Space Mono',monospace;font-size:0.55rem;letter-spacing:1px;text-transform:uppercase;padding:10px 6px;cursor:pointer;border-radius:2px;text-align:center;}
.target-quick-btn:active{border-color:var(--accent);color:var(--accent);}

/* CATEGORY LIST */
.cat-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;}
.cat-item{background:var(--surface);border:1px solid var(--border);border-radius:2px;overflow:hidden;}
.cat-item-header{display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer;}
.cat-color-dot{width:14px;height:14px;border-radius:3px;flex-shrink:0;}
.cat-item-name{flex:1;font-size:0.75rem;color:var(--text);}
.cat-default-badge{font-size:0.48rem;letter-spacing:1px;text-transform:uppercase;color:var(--accent);border:1px solid var(--accent);padding:2px 6px;border-radius:10px;}
.cat-item-actions{display:flex;gap:6px;}
.cat-action-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.75rem;padding:4px;}
.cat-subcats{padding:0 14px 12px 38px;display:none;flex-direction:column;gap:6px;}
.cat-subcats.open{display:flex;}
.cat-subcat-item{display:flex;align-items:center;justify-content:space-between;font-size:0.65rem;color:var(--muted);}
.add-subcat-row{display:flex;gap:6px;margin-top:4px;}

/* SESSIONS IN LOG */
.sessions-list{display:flex;flex-direction:column;gap:10px;margin-bottom:12px;}
.session-row{background:var(--surface2);border:1px solid var(--border);border-radius:2px;padding:10px 12px;position:relative;}
.session-row-top{display:flex;gap:8px;margin-bottom:8px;}
.session-select{flex:1;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.65rem;padding:10px 8px;outline:none;border-radius:2px;-webkit-appearance:none;cursor:pointer;}
.session-hours-input{width:72px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.8rem;padding:10px 8px;text-align:center;outline:none;border-radius:2px;-webkit-appearance:none;}
.session-hours-input:focus,.session-select:focus{border-color:var(--accent);}
.session-remove{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem;line-height:1;padding:2px;}
.session-total{text-align:right;font-size:0.65rem;color:var(--muted);margin-bottom:12px;}
.session-total span{color:var(--accent);font-family:'Playfair Display',serif;font-size:1rem;}
.add-session-btn{width:100%;background:transparent;border:1px dashed var(--border);color:var(--muted);font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:2px;text-transform:uppercase;padding:12px;cursor:pointer;border-radius:2px;margin-bottom:14px;}
.add-session-btn:active{border-color:var(--accent);color:var(--accent);}

/* BACKUP ROWS */
.backup-row{display:flex;align-items:center;gap:14px;background:var(--surface);border:1px solid var(--border);padding:16px;margin-bottom:10px;border-radius:2px;cursor:pointer;}
.backup-row:active{opacity:0.7;}
.backup-row-icon{font-size:1.4rem;width:32px;text-align:center;}
.backup-row-title{font-size:0.75rem;color:var(--text);margin-bottom:3px;}
.backup-row-desc{font-size:0.6rem;color:var(--muted);}

/* SHEET OVERLAY */
.sheet-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:100;align-items:flex-end;justify-content:center;}
.sheet-overlay.open{display:flex;}
.sheet{background:var(--surface);border-top:1px solid var(--border);border-radius:16px 16px 0 0;padding:0 24px calc(32px + var(--safe-bottom));width:100%;max-width:600px;max-height:92vh;overflow-y:auto;animation:slideUp 0.25s ease-out;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:14px auto 20px;}
.sheet h2{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--accent);margin-bottom:20px;}
.field{margin-bottom:16px;}
.field label{display:block;font-size:0.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.field input,.field select,.field textarea{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.9rem;padding:14px 12px;outline:none;border-radius:2px;transition:border-color 0.15s;-webkit-appearance:none;}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--accent);}
.sheet-actions{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;}
.btn{background:transparent;border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.65rem;letter-spacing:2px;text-transform:uppercase;padding:12px 18px;cursor:pointer;border-radius:2px;transition:all 0.15s;white-space:nowrap;min-height:44px;}
.btn:active{opacity:0.7;}
.btn.primary{border-color:var(--accent);color:var(--accent);}
.btn.danger{border-color:var(--red);color:var(--red);}
.btn.full{width:100%;text-align:center;display:block;}
.sheet-status{font-size:0.65rem;margin-top:14px;min-height:18px;}

/* TOAST */
.toast{position:fixed;bottom:calc(var(--nav-h) + var(--safe-bottom) + 20px);left:50%;transform:translateX(-50%) translateY(10px);background:var(--surface);border:1px solid var(--accent);color:var(--accent);font-size:0.65rem;letter-spacing:2px;text-transform:uppercase;padding:12px 20px;opacity:0;transition:opacity 0.25s,transform 0.25s;pointer-events:none;z-index:200;white-space:nowrap;border-radius:2px;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* MIGRATION BANNER */
.migration-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:300;align-items:center;justify-content:center;padding:20px;}
.migration-overlay.open{display:flex;}
.migration-box{background:var(--surface);border:1px solid var(--accent);border-radius:4px;padding:28px 24px;max-width:420px;width:100%;}
.migration-box h2{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--accent);margin-bottom:12px;}
.migration-box p{font-size:0.68rem;color:var(--muted);line-height:1.8;margin-bottom:16px;}
.migration-box ul{font-size:0.65rem;color:var(--text);line-height:2;margin-left:16px;margin-bottom:20px;}

@media(min-width:600px){
  .page{padding:28px 32px;}
  .stats-grid{grid-template-columns:repeat(3,1fr);}
  .cal-day{min-height:72px;}
  .badges-grid{grid-template-columns:repeat(4,1fr);}
}
</style>
</head>
<body>

<!-- MIGRATION PROMPT -->
<div class="migration-overlay" id="migrationOverlay">
  <div class="migration-box">
    <h2>üé® Art Hours v2</h2>
    <p>Welcome to the updated Art Hours! We've added sessions and categories so you can track <em>what</em> you practice, not just how long.</p>
    <ul>
      <li>All existing entries migrated to <strong>General</strong> category</li>
      <li>Log form now supports multiple sessions per day</li>
      <li>New Settings tab for targets &amp; categories</li>
      <li>Pie chart showing time per category</li>
    </ul>
    <button class="btn primary full" onclick="confirmMigration()">Got it ‚Äî let's go!</button>
  </div>
</div>

<div class="header">
  <div class="header-left">
    <h1>Art Hours</h1>
    <div class="subtitle" id="dateRange">Daily Practice Logger</div>
  </div>
  <div class="header-right">
    <div class="level-badge" id="levelBadge" onclick="showPage('analysis')">LVL 1</div>
    <div class="sync-pill nosync" id="syncPill" onclick="showPage('settings')">‚óã no sync</div>
  </div>
</div>

<div class="install-banner" id="installBanner">
  <div class="install-banner-text"><strong>Add to Home Screen</strong>Install Art Hours for quick access &amp; offline use</div>
  <button class="install-btn" onclick="triggerInstall()">Install</button>
  <button class="install-dismiss" onclick="dismissInstall()">‚úï</button>
</div>
<div class="ios-hint" id="iosHint">
  <p>To install: tap <strong>Share ‚Üë</strong> then <strong>"Add to Home Screen"</strong></p>
</div>

<!-- PAGE: CALENDAR -->
<div class="page active" id="page-calendar">
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>Met</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div>Missed</div>
    <span style="font-size:0.55rem;color:var(--muted)">Tap any day to log / edit</span>
  </div>
  <div class="calendar-grid" id="calendar"></div>
</div>

<!-- PAGE: CHART -->
<div class="page" id="page-chart">
  <div class="chart-tabs">
    <button class="chart-tab active" id="tab-daily" onclick="switchChart('daily')">Daily</button>
    <button class="chart-tab" id="tab-cumulative" onclick="switchChart('cumulative')">Cumulative</button>
  </div>
  <div id="chart-daily-wrap">
    <div class="chart-scroll">
      <div class="chart-wrap"><div class="chart-inner" id="chart"></div></div>
    </div>
    <p style="font-size:0.6rem;color:var(--muted);text-align:center;margin-top:8px;">Tap any bar to see hours ¬∑ Green = met ¬∑ Red = missed</p>
  </div>
  <div id="chart-cumulative-wrap" style="display:none">
    <div class="chart-scroll">
      <div class="chart-wrap"><div class="cum-chart" id="cumChart"></div></div>
    </div>
    <p style="font-size:0.6rem;color:var(--muted);text-align:center;margin-top:8px;">Total hours accumulated over time</p>
  </div>
</div>

<!-- PAGE: ANALYSIS -->
<div class="page" id="page-analysis">
  <div class="section-title">Your Level</div>
  <div id="levelCard"></div>

  <div class="section-title">Badges</div>
  <div class="badges-grid" id="badgesGrid"></div>

  <div class="section-title">Progress</div>
  <div id="progressBars"></div>

  <div class="section-title">Category Breakdown</div>
  <div class="pie-section" id="pieSection"></div>

  <div class="section-title">Stats</div>
  <div class="stats-grid" id="stats"></div>

  <div class="section-title">Streak Comparison</div>
  <div id="streakCompare"></div>

  <div class="section-title">Monthly Summary</div>
  <div class="monthly-cards" id="monthlyCards"></div>
</div>

<!-- PAGE: SETTINGS -->
<div class="page" id="page-settings">

  <!-- TARGETS -->
  <div class="settings-section">
    <div class="section-title">Daily Targets</div>
    <p style="font-size:0.62rem;color:var(--muted);margin-bottom:14px;line-height:1.7;">Set your target hours per day. Weekly and monthly targets auto-calculate.</p>

    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <div style="flex:1">
        <div style="font-size:0.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;">Weekday default</div>
        <input type="number" id="targetWeekday" min="0" max="24" step="0.5" value="5" inputmode="decimal" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:1rem;padding:12px;outline:none;border-radius:2px;-webkit-appearance:none;" onchange="applyWeekdayDefault()">
      </div>
      <div style="flex:1">
        <div style="font-size:0.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;">Weekend default</div>
        <input type="number" id="targetWeekend" min="0" max="24" step="0.5" value="12" inputmode="decimal" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:1rem;padding:12px;outline:none;border-radius:2px;-webkit-appearance:none;" onchange="applyWeekendDefault()">
      </div>
    </div>

    <div style="font-size:0.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Override per day</div>
    <div class="target-grid" id="targetGrid"></div>

    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:2px;padding:12px;font-size:0.62rem;color:var(--muted);line-height:1.8;margin-top:8px;" id="targetSummary"></div>
  </div>

  <!-- CATEGORIES -->
  <div class="settings-section">
    <div class="section-title">Categories</div>
    <p style="font-size:0.62rem;color:var(--muted);margin-bottom:14px;line-height:1.7;">Organise your sessions. Tap a category to manage subcategories. One category is the default for quick logging.</p>
    <div class="cat-list" id="catList"></div>
    <button class="btn full" style="margin-bottom:8px;" onclick="openAddCatSheet()">Ôºã Add Category</button>
  </div>

  <!-- BACKUP & SYNC -->
  <div class="settings-section">
    <div class="section-title">Backup &amp; Sync</div>
    <div class="backup-row" onclick="exportCSV()">
      <div class="backup-row-icon">‚Üì</div>
      <div class="backup-row-text"><div class="backup-row-title">Download CSV</div><div class="backup-row-desc">Save locally ‚Äî open in Google Sheets or Excel</div></div>
    </div>
    <div class="backup-row" onclick="openImportSheet()">
      <div class="backup-row-icon">‚Üë</div>
      <div class="backup-row-text"><div class="backup-row-title">Restore from CSV</div><div class="backup-row-desc">Import a previously exported file</div></div>
    </div>
    <input type="file" id="importFile" accept=".csv,text/csv,text/plain,*/*" style="display:none" onchange="importCSV(event)">
    <div class="backup-row" onclick="openSheetSheet()">
      <div class="backup-row-icon">‚ü≥</div>
      <div class="backup-row-text"><div class="backup-row-title">Google Sheets Sync</div><div class="backup-row-desc">Connect to a live Google Sheet ‚Äî auto-syncs on open</div></div>
    </div>
  </div>

</div>

<button class="fab" onclick="openLogSheet()" title="Log today">Ôºã</button>

<nav class="bottom-nav">
  <button class="nav-item active" id="nav-calendar" onclick="showPage('calendar')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Calendar
  </button>
  <button class="nav-item" id="nav-chart" onclick="showPage('chart')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="12" width="4" height="9"/><rect x="10" y="6" width="4" height="15"/><rect x="17" y="3" width="4" height="18"/></svg>
    Chart
  </button>
  <button class="nav-item" id="nav-analysis" onclick="showPage('analysis')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="9"/><path d="M12 8v4l3 3"/></svg>
    Analysis
  </button>
  <button class="nav-item" id="nav-settings" onclick="showPage('settings')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    Settings
  </button>
</nav>

<!-- LOG SHEET -->
<div class="sheet-overlay" id="logOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h2 id="logTitle">Log Entry</h2>
    <div class="field"><label>Date</label><input type="date" id="inputDate" onchange="onDateChange()"></div>
    <div class="field"><label>Target Hours</label><input type="number" id="inputTarget" min="0" max="24" step="0.25" inputmode="decimal" placeholder="e.g. 5"></div>
    <div style="font-size:0.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;">Sessions</div>
    <div class="sessions-list" id="sessionsList"></div>
    <div class="session-total">Total: <span id="sessionTotal">0</span>h</div>
    <button class="add-session-btn" onclick="addSession()">Ôºã Add Session</button>
    <div class="sheet-actions">
      <button class="btn primary" style="flex:1" onclick="saveEntry()">Save</button>
      <button class="btn" onclick="closeLogSheet()">Cancel</button>
      <button class="btn danger" id="deleteBtn" onclick="deleteEntry()" style="display:none">Delete</button>
    </div>
  </div>
</div>

<!-- GOOGLE SHEETS SHEET -->
<div class="sheet-overlay" id="sheetOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h2>Google Sheets Sync</h2>
    <div style="font-size:0.62rem;color:var(--muted);line-height:1.8;margin-bottom:16px;background:var(--surface2);padding:14px;border-radius:2px;border:1px solid var(--border)">
      <strong style="color:var(--accent);display:block;margin-bottom:6px">Auto-sync is ON once URL is saved</strong>
      Syncs automatically on open and after every entry saved or deleted.
    </div>
    <div class="field"><label>Web App URL</label><input type="url" id="sheetUrl" placeholder="https://script.google.com/macros/s/..."></div>
    <div class="sheet-actions" style="flex-direction:column;gap:8px;">
      <button class="btn full" style="border-color:var(--muted);color:var(--muted);font-size:0.55rem" onclick="testConnection()">‚ñ∂ Test Connection</button>
      <button class="btn primary full" onclick="gsheetSync(false)">‚ü≥ Sync Now</button>
      <button class="btn full" onclick="gsheetLoad()">‚Üì Load from Sheet</button>
      <button class="btn full" onclick="gsheetBackup()">‚Üë Full Backup to Sheet</button>
      <button class="btn danger full" onclick="clearSheetUrl()">‚úï Disconnect</button>
      <button class="btn full" onclick="closeSheetSheet()">Close</button>
    </div>
    <div class="sheet-status" id="sheetStatus"></div>
  </div>
</div>

<!-- IMPORT SHEET -->
<div class="sheet-overlay" id="importOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h2>Restore from CSV</h2>
    <div class="backup-row" onclick="document.getElementById('importFile').click()" style="margin-bottom:10px">
      <div class="backup-row-icon">üìÅ</div>
      <div class="backup-row-text"><div class="backup-row-title">Choose File</div><div class="backup-row-desc">Browse and select your CSV file</div></div>
    </div>
    <div class="section-title" style="margin-top:16px">Or paste CSV text</div>
    <textarea id="csvPasteArea" placeholder="Paste CSV here..." style="width:100%;height:120px;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.7rem;padding:12px;outline:none;resize:none;border-radius:2px;line-height:1.6;margin-bottom:12px;"></textarea>
    <div class="sheet-actions" style="flex-direction:column;gap:8px;">
      <button class="btn primary full" onclick="importFromPaste()">‚Üë Import</button>
      <button class="btn full" onclick="closeImportSheet()">Cancel</button>
    </div>
    <div id="importStatus" style="font-size:0.65rem;margin-top:12px;min-height:18px;"></div>
  </div>
</div>

<!-- ADD / EDIT CATEGORY SHEET -->
<div class="sheet-overlay" id="catSheet">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h2 id="catSheetTitle">Add Category</h2>
    <div class="field"><label>Name</label><input type="text" id="catName" placeholder="e.g. Figure Drawing"></div>
    <div class="field">
      <label>Color</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;" id="colorPicker"></div>
    </div>
    <div class="field" id="subcatField">
      <label>Subcategories</label>
      <div id="subcatEditList" style="display:flex;flex-direction:column;gap:6px;margin-bottom:8px;"></div>
      <div style="display:flex;gap:8px;">
        <input type="text" id="newSubcatInput" placeholder="Add subcategory..." style="flex:1">
        <button class="btn" onclick="addSubcatInEditor()" style="padding:10px 14px;">Ôºã</button>
      </div>
    </div>
    <div class="sheet-actions" style="flex-direction:column;gap:8px;">
      <button class="btn primary full" onclick="saveCat()">Save Category</button>
      <button class="btn danger full" id="deleteCatBtn" onclick="deleteCat()" style="display:none">Delete Category</button>
      <button class="btn full" onclick="closeCatSheet()">Cancel</button>
    </div>
  </div>
</div>

<!-- BADGE DETAIL SHEET -->
<div class="sheet-overlay" id="badgeOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div style="text-align:center;padding:10px 0 20px">
      <div id="badgeDetailIcon" style="font-size:4rem;margin-bottom:12px;"></div>
      <div id="badgeDetailName" style="font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--accent);margin-bottom:8px;"></div>
      <div id="badgeDetailDesc" style="font-size:0.7rem;color:var(--muted);line-height:1.7;"></div>
      <div id="badgeDetailStatus" style="margin-top:14px;font-size:0.65rem;"></div>
    </div>
    <button class="btn full" onclick="closeBadgeSheet()">Close</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS & DEFAULTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STORAGE_KEY      = 'art_hours_v2';
const SHEET_URL_KEY    = 'art_hours_sheet_url';
const CATS_KEY         = 'art_hours_categories';
const TARGETS_KEY      = 'art_hours_targets';
const MIGRATED_KEY     = 'art_hours_v2_migrated';
const DAYS   = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

const CAT_COLORS = ['#4ade80','#f87171','#60a5fa','#f5c842','#c084fc','#fb923c','#34d399','#f472b6','#94a3b8','#facc15'];

const DEFAULT_CATS = [
  {id:'general',  name:'General',        color:'#f5c842', subcategories:[], isDefault:true},
  {id:'figure',   name:'Figure Drawing', color:'#4ade80', subcategories:['Portraits','Gestures','Anatomy'], isDefault:false},
  {id:'painting', name:'Painting',       color:'#60a5fa', subcategories:['Oils','Watercolour','Digital'],   isDefault:false},
  {id:'theory',   name:'Color Theory',   color:'#c084fc', subcategories:[], isDefault:false},
];

const DEFAULT_TARGETS = {
  Mon:5, Tue:5, Wed:5, Thu:5, Fri:5, Sat:12, Sun:12
};

const SEED = [
  {date:'2025-12-15',hours:1.17,target:5},{date:'2025-12-16',hours:5,target:5},
  {date:'2025-12-17',hours:5,target:5},{date:'2025-12-18',hours:5.5,target:5},
  {date:'2025-12-19',hours:5.5,target:5},{date:'2025-12-20',hours:12,target:12},
  {date:'2025-12-21',hours:12,target:12},{date:'2025-12-22',hours:2.5,target:5},
  {date:'2025-12-23',hours:6,target:5},{date:'2025-12-24',hours:6,target:5},
  {date:'2025-12-25',hours:12,target:12},{date:'2025-12-26',hours:7.17,target:5},
  {date:'2025-12-27',hours:12,target:12},{date:'2025-12-28',hours:1,target:12},
  {date:'2025-12-29',hours:5,target:5},{date:'2025-12-30',hours:5,target:5},
  {date:'2025-12-31',hours:5.6,target:5},{date:'2026-01-01',hours:5.25,target:5},
  {date:'2026-01-02',hours:6,target:5},{date:'2026-01-03',hours:12,target:12},
  {date:'2026-01-04',hours:12,target:12},{date:'2026-01-05',hours:5,target:5},
  {date:'2026-01-06',hours:5,target:5},{date:'2026-01-07',hours:5,target:5},
  {date:'2026-01-08',hours:5,target:5},{date:'2026-01-09',hours:1.5,target:1},
  {date:'2026-01-10',hours:1.5,target:1},{date:'2026-01-11',hours:1,target:1},
  {date:'2026-01-12',hours:1.2,target:1},{date:'2026-01-13',hours:1,target:1},
  {date:'2026-01-14',hours:1.33,target:1},{date:'2026-01-15',hours:1.1,target:1},
  {date:'2026-01-16',hours:1.2,target:1},{date:'2026-01-17',hours:1,target:1},
  {date:'2026-01-18',hours:1,target:1},{date:'2026-01-19',hours:1,target:1},
  {date:'2026-01-20',hours:1,target:1},{date:'2026-01-21',hours:1,target:1},
  {date:'2026-01-22',hours:1,target:1},{date:'2026-01-23',hours:1,target:1},
  {date:'2026-01-24',hours:1,target:1},{date:'2026-01-25',hours:1,target:1},
  {date:'2026-01-26',hours:1,target:1},{date:'2026-01-27',hours:1,target:5},
  {date:'2026-01-28',hours:4,target:5},{date:'2026-01-29',hours:1,target:5},
  {date:'2026-01-30',hours:1,target:5},{date:'2026-01-31',hours:2.75,target:12},
  {date:'2026-02-01',hours:12,target:12},{date:'2026-02-02',hours:1,target:5},
  {date:'2026-02-03',hours:5,target:5},{date:'2026-02-04',hours:5,target:5},
  {date:'2026-02-05',hours:5,target:5},{date:'2026-02-06',hours:2.5,target:5},
  {date:'2026-02-07',hours:8,target:12},{date:'2026-02-08',hours:12,target:12},
  {date:'2026-02-09',hours:5,target:5},{date:'2026-02-24',hours:5,target:5},
];

const LEVELS = [
  {level:1,name:'Beginner',min:0,max:50},
  {level:2,name:'Apprentice',min:50,max:150},
  {level:3,name:'Practitioner',min:150,max:300},
  {level:4,name:'Journeyman',min:300,max:500},
  {level:5,name:'Skilled',min:500,max:750},
  {level:6,name:'Expert',min:750,max:1000},
  {level:7,name:'Master',min:1000,max:1500},
  {level:8,name:'Grand Master',min:1500,max:Infinity},
];

const BADGE_DEFS = [
  {id:'streak3',     icon:'üî•',name:'First Spark',   desc:'Maintain a 3 day streak',     check:s=>s.current>=3},
  {id:'streak7',     icon:'‚ö°',name:'Week Warrior',  desc:'Maintain a 7 day streak',     check:s=>s.current>=7},
  {id:'streak14',    icon:'üí™',name:'Fortnight',     desc:'Maintain a 14 day streak',    check:s=>s.current>=14},
  {id:'streak30',    icon:'üèÜ',name:'Month Master',  desc:'Maintain a 30 day streak',    check:s=>s.current>=30},
  {id:'hours10',     icon:'üå±',name:'First 10h',     desc:'Log 10 total hours',          check:s=>s.total>=10},
  {id:'hours100',    icon:'‚≠ê',name:'Century',       desc:'100 total hours',             check:s=>s.total>=100},
  {id:'hours500',    icon:'üí´',name:'500 Hours',     desc:'500 total hours',             check:s=>s.total>=500},
  {id:'hours1000',   icon:'üëë',name:'1000 Hours',    desc:'1000 total hours',            check:s=>s.total>=1000},
  {id:'perfectwk',   icon:'üéØ',name:'Perfect Week',  desc:'Hit target 7 days in a row ‚Äî active streak', check:s=>s.current>=7},
  {id:'overachiever',icon:'üöÄ',name:'Overachiever',  desc:'Do 2√ó your target in a day',  check:s=>s.hasDoubled},
  {id:'debtfree',    icon:'üí∞',name:'Debt Free',     desc:'Art debt reaches zero',       check:s=>s.debt<=0&&s.total>0},
  {id:'comeback',    icon:'üîÑ',name:'Comeback',      desc:'Log after a 7+ day gap',      check:s=>s.hasComeback},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toISO(dt){return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;}
function toDDMMYYYY(s){const dt=new Date(s+'T00:00:00');return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`;}
function dayName(dateStr){return DAYS[new Date(dateStr+'T00:00:00').getDay()];}
function uid(){return Math.random().toString(36).slice(2,9);}

function normalize(e){
  const dt=new Date(e.date+'T00:00:00');
  const hours = e.sessions ? e.sessions.reduce((s,x)=>s+(+x.hours),0) : (+e.hours||0);
  const sessions = e.sessions || [{category:'General',subcategory:'',hours:+e.hours||0}];
  return {date:e.date, day:DAYS[dt.getDay()], hours, target:+e.target, sessions,
          result: hours >= +e.target ? 'üü¢' : 'üî¥'};
}

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadData(){
  try{const r=localStorage.getItem(STORAGE_KEY);if(r)return JSON.parse(r);}catch(e){}
  const d=SEED.map(normalize);localStorage.setItem(STORAGE_KEY,JSON.stringify(d));return d;
}
function saveData(){localStorage.setItem(STORAGE_KEY,JSON.stringify(data));}

function loadCats(){
  try{const r=localStorage.getItem(CATS_KEY);if(r)return JSON.parse(r);}catch(e){}
  localStorage.setItem(CATS_KEY,JSON.stringify(DEFAULT_CATS));return JSON.parse(JSON.stringify(DEFAULT_CATS));
}
function saveCats(){localStorage.setItem(CATS_KEY,JSON.stringify(categories));}

function loadTargets(){
  try{const r=localStorage.getItem(TARGETS_KEY);if(r)return JSON.parse(r);}catch(e){}
  localStorage.setItem(TARGETS_KEY,JSON.stringify(DEFAULT_TARGETS));return {...DEFAULT_TARGETS};
}
function saveTargets(){localStorage.setItem(TARGETS_KEY,JSON.stringify(targets));}

function getDefaultTarget(dateStr){
  const d=dayName(dateStr);
  return targets[d] || 5;
}

function getDefaultCat(){
  return categories.find(c=>c.isDefault)||categories[0]||{name:'General',subcategories:[]};
}

// ‚îÄ‚îÄ MIGRATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function migrateOldData(){
  // Check if old v1 data exists and new v2 hasn't been set up
  const oldRaw = localStorage.getItem('art_hours_v1');
  const alreadyMigrated = localStorage.getItem(MIGRATED_KEY);
  if(alreadyMigrated||!oldRaw) return false;

  try{
    const oldData = JSON.parse(oldRaw);
    // Migrate each entry ‚Äî wrap hours in a General session
    const migrated = oldData.map(e=>normalize({
      ...e,
      sessions:[{category:'General',subcategory:'',hours:+e.hours||0}]
    }));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
    return true; // needs prompt
  }catch(e){return false;}
}

function confirmMigration(){
  localStorage.setItem(MIGRATED_KEY,'1');
  document.getElementById('migrationOverlay').classList.remove('open');
  showToast('Welcome to Art Hours v2 üé®');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let data        = loadData();
let categories  = loadCats();
let targets     = loadTargets();
let currentPage = 'calendar';
let currentChart= 'daily';
let pieMode     = 'alltime'; // 'alltime' | 'month'

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATS ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function computeStats(){
  const sorted=[...data].sort((a,b)=>a.date.localeCompare(b.date));
  const total=sorted.reduce((s,d)=>s+d.hours,0);
  const green=sorted.filter(d=>d.result==='üü¢').length;
  const red=sorted.filter(d=>d.result==='üî¥').length;

  let best=0,cur=0;
  for(const d of sorted){if(d.result==='üü¢'){cur++;best=Math.max(best,cur);}else cur=0;}
  let current=0;
  for(let i=sorted.length-1;i>=0;i--){if(sorted[i].result==='üü¢')current++;else break;}

  let debt=0;
  sorted.forEach(d=>{debt-=(d.hours-d.target);if(debt<0)debt=0;});

  const hasDoubled=sorted.some(d=>d.hours>=d.target*2&&d.target>0);

  let hasComeback=false;
  for(let i=1;i<sorted.length;i++){
    const gap=(new Date(sorted[i].date+'T00:00:00')-new Date(sorted[i-1].date+'T00:00:00'))/(864e5);
    if(gap>=7){hasComeback=true;break;}
  }

  const now=new Date();
  const dow=now.getDay();
  const monday=new Date(now);
  monday.setDate(now.getDate()-(dow===0?6:dow-1));monday.setHours(0,0,0,0);
  const sunday=new Date(monday);sunday.setDate(monday.getDate()+6);
  const weekEntries=sorted.filter(d=>{const dt=new Date(d.date+'T00:00:00');return dt>=monday&&dt<=sunday;});
  const weekHours=weekEntries.reduce((s,d)=>s+d.hours,0);
  const weekTarget=weekEntries.reduce((s,d)=>s+d.target,0)||35;

  const monthStr=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const monthEntries=sorted.filter(d=>d.date.startsWith(monthStr));
  const monthHours=monthEntries.reduce((s,d)=>s+d.hours,0);
  const daysInMonth=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
  const avgTarget=sorted.length?sorted.reduce((s,d)=>s+d.target,0)/sorted.length:5;
  const monthTarget=avgTarget*daysInMonth;

  const pct=sorted.length?Math.round(green/sorted.length*100):0;

  return{total,green,red,best,current,debt,hasDoubled,hasComeback,
         weekHours,weekTarget,monthHours,monthTarget,pct,
         avg:sorted.length?total/sorted.length:0};
}

// ‚îÄ‚îÄ CATEGORY HOURS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function computeCatHours(entries){
  const map={};
  entries.forEach(e=>{
    (e.sessions||[]).forEach(s=>{
      const k=s.category||'General';
      map[k]=(map[k]||0)+(+s.hours||0);
    });
  });
  return map;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LEVEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getLevel(total){return LEVELS.findLast(l=>total>=l.min)||LEVELS[0];}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SERVICE WORKER / PWA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js').then(reg=>{
      navigator.serviceWorker.addEventListener('message',e=>{
        if(e.data&&e.data.type==='SYNC_SUCCESS'){setSyncPill('synced','‚úì synced');showToast('Auto-synced ‚úì');}
      });
    }).catch(()=>{});
  });
}
let deferredInstallPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();deferredInstallPrompt=e;
  if(!localStorage.getItem('install_dismissed'))document.getElementById('installBanner').classList.add('show');
});
window.addEventListener('appinstalled',()=>{document.getElementById('installBanner').classList.remove('show');showToast('App installed ‚úì');deferredInstallPrompt=null;});
function triggerInstall(){if(!deferredInstallPrompt)return;deferredInstallPrompt.prompt();deferredInstallPrompt.userChoice.then(()=>{deferredInstallPrompt=null;document.getElementById('installBanner').classList.remove('show');});}
function dismissInstall(){document.getElementById('installBanner').classList.remove('show');localStorage.setItem('install_dismissed','1');}
function isIOS(){return /iphone|ipad|ipod/i.test(navigator.userAgent)&&!window.MSStream;}
function isInStandaloneMode(){return window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone;}
if(isIOS()&&!isInStandaloneMode()&&!localStorage.getItem('ios_hint_dismissed')){
  document.getElementById('iosHint').classList.add('show');
  setTimeout(()=>{document.getElementById('iosHint').classList.remove('show');localStorage.setItem('ios_hint_dismissed','1');},8000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTO SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load',()=>{
  const url=localStorage.getItem(SHEET_URL_KEY);
  if(url&&navigator.onLine){setSyncPill('syncing','‚ü≥ syncing‚Ä¶');setTimeout(()=>autoSync(url),1200);}
  else if(url&&!navigator.onLine)setSyncPill('offline','‚úï offline');
  else setSyncPill('nosync','‚óã no sync');
});
window.addEventListener('online',()=>{const u=localStorage.getItem(SHEET_URL_KEY);if(u){setSyncPill('syncing','‚ü≥ syncing‚Ä¶');autoSync(u);}});
window.addEventListener('offline',()=>setSyncPill('offline','‚úï offline'));

function sanitiseForSync(entries){
  return entries.map(e=>({
    date:e.date, day:e.day, hours:e.hours, target:e.target,
    result:e.result==='üü¢'?'Met':'Missed',
    categories:(e.sessions||[]).map(s=>`${s.category}${s.subcategory?'/'+s.subcategory:''}:${s.hours}h`).join(', ')
  }));
}

async function sheetFetch(url,payload){
  if(payload.data)payload={...payload,data:sanitiseForSync(payload.data)};
  if(payload.data&&payload.data.length>20)return await sheetFetchChunked(url,payload);
  const encoded=encodeURIComponent(JSON.stringify(payload));
  const res=await fetch(`${url}?payload=${encoded}`,{method:'GET',redirect:'follow'});
  const text=await res.text();
  if(text.trim().startsWith('<'))throw new Error('Script returned HTML ‚Äî check deployment');
  try{return JSON.parse(text);}catch(e){throw new Error('Bad response: '+text.slice(0,100));}
}

async function sheetFetchChunked(url,payload){
  const CHUNK=20;const chunks=[];
  for(let i=0;i<payload.data.length;i+=CHUNK)chunks.push(payload.data.slice(i,i+CHUNK));
  let totalAppended=0,totalUpdated=0;
  for(const chunk of chunks){
    const p={...payload,data:chunk};
    const encoded=encodeURIComponent(JSON.stringify(p));
    const res=await fetch(`${url}?payload=${encoded}`,{method:'GET',redirect:'follow'});
    const text=await res.text();
    if(text.trim().startsWith('<'))throw new Error('Script returned HTML');
    const json=JSON.parse(text);if(json.error)throw new Error(json.error);
    totalAppended+=json.appended||0;totalUpdated+=json.updated||0;
  }
  return{status:'ok',synced:payload.data.length,appended:totalAppended,updated:totalUpdated};
}

async function testConnection(){
  const url=getSheetUrl();if(!url)return;
  setSheetStatus('Testing‚Ä¶','var(--muted)');
  try{
    const encoded=encodeURIComponent(JSON.stringify({action:'load'}));
    const res=await fetch(`${url}?payload=${encoded}`,{method:'GET',redirect:'follow'});
    const text=await res.text();
    if(text.trim().startsWith('<')){setSheetStatus('‚úó Got HTML ‚Äî check deployment','var(--red)');return;}
    const json=JSON.parse(text);
    if(json.error){setSheetStatus(`‚úó ${json.error}`,'var(--red)');return;}
    setSheetStatus(`‚úì Connected! ${json.data?json.data.length:0} entries. Now tap Sync.`,'var(--green)');
  }catch(e){setSheetStatus(`‚úó ${e.message}`,'var(--red)');}
}

async function autoSync(url){
  try{
    const pushJson=await sheetFetch(url,{action:'sync',data});
    if(pushJson.error)throw new Error(pushJson.error);
    const pullJson=await sheetFetch(url,{action:'load'});
    if(pullJson.data&&pullJson.data.length){
      pullJson.data.forEach(imp=>{
        const idx=data.findIndex(d=>d.date===imp.date);
        const entry=normalize(imp);
        if(idx>=0)data[idx]=entry;else data.push(entry);
      });
      saveData();render();
    }
    setSyncPill('synced','‚úì synced');
    if('serviceWorker' in navigator&&'SyncManager' in window){
      const reg=await navigator.serviceWorker.ready;
      await queuePendingSync(url);
      await reg.sync.register('sync-sheets');
    }
  }catch(e){setSyncPill('offline','‚úï sync failed');}
}

async function queuePendingSync(url){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open('art-hours-sw',1);
    req.onupgradeneeded=e=>e.target.result.createObjectStore('pending',{autoIncrement:true});
    req.onsuccess=e=>{
      const db=e.target.result;const tx=db.transaction('pending','readwrite');
      const store=tx.objectStore('pending');store.clear();store.add({url,data});
      tx.oncomplete=resolve;tx.onerror=reject;
    };
    req.onerror=reject;
  });
}

function setSyncPill(state,label){const p=document.getElementById('syncPill');p.className=`sync-pill ${state}`;p.textContent=label;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
  currentPage=name;
  if(name==='chart'){if(currentChart==='daily')renderChart();else renderCumulativeChart();}
  if(name==='settings')renderSettings();
  window.scrollTo(0,0);
}

function switchChart(type){
  currentChart=type;
  document.getElementById('tab-daily').classList.toggle('active',type==='daily');
  document.getElementById('tab-cumulative').classList.toggle('active',type==='cumulative');
  document.getElementById('chart-daily-wrap').style.display=type==='daily'?'block':'none';
  document.getElementById('chart-cumulative-wrap').style.display=type==='cumulative'?'block':'none';
  if(type==='daily')renderChart();else renderCumulativeChart();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MASTER RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  data.sort((a,b)=>a.date.localeCompare(b.date));
  const s=computeStats();
  renderLevelCard(s);
  renderBadges(s);
  renderProgressBars(s);
  renderPieChart();
  renderStats(s);
  renderStreakCompare(s);
  renderMonthlyCards();
  renderCalendar();
  if(currentPage==='chart'){if(currentChart==='daily')renderChart();else renderCumulativeChart();}
  if(currentPage==='settings')renderSettings();
  if(data.length)document.getElementById('dateRange').textContent=`${toDDMMYYYY(data[0].date)} ‚Üí ${toDDMMYYYY(data[data.length-1].date)}`;
  const lv=getLevel(s.total);
  document.getElementById('levelBadge').textContent=`LVL ${lv.level} ¬∑ ${lv.name}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: LEVEL CARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLevelCard(s){
  const lv=getLevel(s.total);
  const next=LEVELS.find(l=>l.level===lv.level+1);
  const pct=next?Math.min(100,Math.round((s.total-lv.min)/(next.min-lv.min)*100)):100;
  document.getElementById('levelCard').innerHTML=`
    <div class="level-card" style="margin-bottom:24px">
      <div class="level-num">Level ${lv.level}</div>
      <div class="level-name">${lv.name}</div>
      <div class="level-progress-bg"><div class="level-progress-fill" style="width:${pct}%"></div></div>
      <div class="level-progress-meta">
        <span>${s.total.toFixed(1)}h total</span>
        <span>${next?`${next.min}h to Level ${next.level}`:'Max Level! üëë'}</span>
      </div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: BADGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBadges(s){
  document.getElementById('badgesGrid').innerHTML=BADGE_DEFS.map(b=>{
    const earned=b.check(s);
    return `<div class="badge ${earned?'earned':''}" onclick="openBadgeSheet('${b.id}')">
      <span class="badge-icon">${b.icon}</span>
      <div class="badge-name">${b.name}</div>
    </div>`;
  }).join('');
}

function openBadgeSheet(id){
  const b=BADGE_DEFS.find(x=>x.id===id);if(!b)return;
  const s=computeStats();const earned=b.check(s);
  document.getElementById('badgeDetailIcon').textContent=b.icon;
  document.getElementById('badgeDetailName').textContent=b.name;
  document.getElementById('badgeDetailDesc').textContent=b.desc;
  document.getElementById('badgeDetailStatus').innerHTML=earned
    ?`<span style="color:var(--green)">‚úì Earned!</span>`
    :`<span style="color:var(--muted)">Not yet earned</span>`;
  document.getElementById('badgeOverlay').classList.add('open');
}
function closeBadgeSheet(){document.getElementById('badgeOverlay').classList.remove('open');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: PROGRESS BARS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProgressBars(s){
  const weekPct=Math.min(100,s.weekTarget>0?Math.round(s.weekHours/s.weekTarget*100):0);
  const monthPct=Math.min(100,s.monthTarget>0?Math.round(s.monthHours/s.monthTarget*100):0);
  document.getElementById('progressBars').innerHTML=`
    <div class="progress-wrap">
      <div class="progress-title">This Week</div>
      <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${weekPct}%;background:${weekPct>=100?'var(--green)':'var(--accent)'}"></div></div>
      <div class="progress-meta"><span>${s.weekHours.toFixed(1)}h done</span><span>${s.weekTarget.toFixed(1)}h target ¬∑ ${weekPct}%</span></div>
    </div>
    <div class="progress-wrap">
      <div class="progress-title">This Month</div>
      <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${monthPct}%;background:${monthPct>=100?'var(--green)':'var(--accent)'}"></div></div>
      <div class="progress-meta"><span>${s.monthHours.toFixed(1)}h done</span><span>${s.monthTarget.toFixed(1)}h target ¬∑ ${monthPct}%</span></div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: PIE CHART (SVG arc)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPieChart(){
  const now=new Date();
  const monthStr=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const entries=pieMode==='alltime'?data:data.filter(d=>d.date.startsWith(monthStr));
  const catHours=computeCatHours(entries);
  const total=Object.values(catHours).reduce((s,v)=>s+v,0);

  const toggleHtml=`
    <div class="pie-toggle">
      <button class="pie-tab ${pieMode==='alltime'?'active':''}" onclick="setPieMode('alltime')">All Time</button>
      <button class="pie-tab ${pieMode==='month'?'active':''}" onclick="setPieMode('month')">This Month</button>
    </div>`;

  if(!total||!Object.keys(catHours).length){
    document.getElementById('pieSection').innerHTML=toggleHtml+`<div class="pie-empty">No session data yet</div>`;
    return;
  }

  // Build pie slices
  const catColors={};
  categories.forEach(c=>{catColors[c.name]=c.color;});
  const fallbackColors=CAT_COLORS;
  let fi=0;
  const slices=Object.entries(catHours).sort((a,b)=>b[1]-a[1]).map(([name,hrs])=>{
    const color=catColors[name]||(fallbackColors[fi++%fallbackColors.length]);
    return{name,hrs,pct:hrs/total,color};
  });

  // SVG pie
  const R=70,CX=80,CY=80;
  let angle=-Math.PI/2;
  const paths=slices.map(s=>{
    if(s.pct>=1){
      // Full circle
      const d=`M ${CX} ${CY-R} A ${R} ${R} 0 1 1 ${CX-0.01} ${CY-R} Z`;
      return`<path d="${d}" fill="${s.color}" opacity="0.85"/>`;
    }
    const a1=angle, a2=angle+s.pct*2*Math.PI;
    const x1=CX+R*Math.cos(a1),y1=CY+R*Math.sin(a1);
    const x2=CX+R*Math.cos(a2),y2=CY+R*Math.sin(a2);
    const large=s.pct>0.5?1:0;
    const d=`M ${CX} ${CY} L ${x1.toFixed(2)} ${y1.toFixed(2)} A ${R} ${R} 0 ${large} 1 ${x2.toFixed(2)} ${y2.toFixed(2)} Z`;
    angle=a2;
    return`<path d="${d}" fill="${s.color}" opacity="0.85"/>`;
  }).join('');

  const svg=`<svg viewBox="0 0 160 160" width="160" height="160" style="flex-shrink:0">
    ${paths}
    <circle cx="${CX}" cy="${CY}" r="34" fill="var(--bg)"/>
    <text x="${CX}" y="${CY-6}" text-anchor="middle" fill="var(--accent)" font-family="Playfair Display,serif" font-size="18" font-weight="700">${total.toFixed(0)}h</text>
    <text x="${CX}" y="${CY+10}" text-anchor="middle" fill="var(--muted)" font-family="Space Mono,monospace" font-size="7">TOTAL</text>
  </svg>`;

  const legend=slices.map(s=>`
    <div class="pie-legend-item">
      <div class="pie-legend-dot" style="background:${s.color}"></div>
      <div class="pie-legend-name">${s.name}</div>
      <div class="pie-legend-val">${s.hrs.toFixed(1)}h ¬∑ ${Math.round(s.pct*100)}%</div>
    </div>`).join('');

  document.getElementById('pieSection').innerHTML=`
    ${toggleHtml}
    <div class="pie-wrap">
      ${svg}
      <div class="pie-legend">${legend}</div>
    </div>`;
}

function setPieMode(mode){pieMode=mode;renderPieChart();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStats(s){
  document.getElementById('stats').innerHTML=`
    <div class="stat-card"><div class="stat-val">${s.total.toFixed(1)}h</div><div class="stat-label">Total Hours</div></div>
    <div class="stat-card"><div class="stat-val">${data.length}</div><div class="stat-label">Days Logged</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--green)">${s.green}</div><div class="stat-label">Days Met</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--red)">${s.red}</div><div class="stat-label">Days Missed</div></div>
    <div class="stat-card"><div class="stat-val">${s.pct}%</div><div class="stat-label">Success Rate</div></div>
    <div class="stat-card"><div class="stat-val">${s.avg.toFixed(1)}h</div><div class="stat-label">Daily Avg</div></div>
    <div class="stat-card" style="grid-column:1/-1;border-color:${s.debt<=0?'var(--green)':'var(--red)'};background:${s.debt<=0?'rgba(74,222,128,0.06)':'rgba(248,113,113,0.06)'}">
      <div class="stat-val" style="color:${s.debt<=0?'var(--green)':'var(--red)'};font-size:2.4rem">${s.debt<=0?'0.0':s.debt.toFixed(1)}h</div>
      <div class="stat-label" style="color:${s.debt<=0?'var(--green)':'var(--red)'}">üé® Art Debt${s.debt<=0?' ‚Äî Debt Free! üéâ':' ‚Äî exceeding target reduces debt'}</div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: STREAK COMPARE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStreakCompare(s){
  const max=Math.max(s.best,s.current,1);
  const bestH=Math.round((s.best/max)*100);
  const curH=Math.round((s.current/max)*100);
  const curColor=s.current>=s.best?'var(--green)':'var(--accent)';
  document.getElementById('streakCompare').innerHTML=`
    <div class="streak-compare">
      <div class="streak-compare-title">Streak Comparison</div>
      <div class="streak-bars">
        <div class="streak-bar-wrap">
          <div class="streak-bar-val">${s.best}</div>
          <div class="streak-bar" style="height:${bestH}%;background:var(--muted);opacity:0.6"></div>
          <div class="streak-bar-label">Best Ever</div>
        </div>
        <div class="streak-bar-wrap">
          <div class="streak-bar-val" style="color:${curColor}">${s.current}</div>
          <div class="streak-bar" style="height:${curH}%;background:${curColor}"></div>
          <div class="streak-bar-label">Current</div>
        </div>
      </div>
      ${s.current>=s.best&&s.current>0?`<div style="font-size:0.65rem;color:var(--green);text-align:center;margin-top:8px">üèÜ New record streak!</div>`
        :s.best>0?`<div style="font-size:0.6rem;color:var(--muted);text-align:center;margin-top:8px">${s.best-s.current} more day${s.best-s.current!==1?'s':''} to beat your record</div>`:''}
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: MONTHLY CARDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMonthlyCards(){
  const months={};
  data.forEach(d=>{
    const dt=new Date(d.date+'T00:00:00');
    const key=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    if(!months[key])months[key]={year:dt.getFullYear(),month:dt.getMonth(),entries:[]};
    months[key].entries.push(d);
  });
  document.getElementById('monthlyCards').innerHTML=Object.keys(months).sort().reverse().map(key=>{
    const m=months[key];
    const total=m.entries.reduce((s,d)=>s+d.hours,0);
    const met=m.entries.filter(d=>d.result==='üü¢').length;
    const missed=m.entries.filter(d=>d.result==='üî¥').length;
    let best=0,cur=0;
    [...m.entries].sort((a,b)=>a.date.localeCompare(b.date)).forEach(d=>{
      if(d.result==='üü¢'){cur++;best=Math.max(best,cur);}else cur=0;
    });
    const maxH=Math.max(...m.entries.map(d=>d.hours),1);
    const miniBars=m.entries.sort((a,b)=>a.date.localeCompare(b.date)).map(d=>`
      <div class="month-mini-bar" style="height:${Math.max(3,Math.round(d.hours/maxH*28))}px;background:${d.result==='üü¢'?'var(--green)':'var(--red)'}"></div>`).join('');
    return`<div class="month-card">
      <div class="month-card-header">
        <div class="month-card-name">${MONTHS[m.month]} ${m.year}</div>
        <div class="month-card-total">${total.toFixed(1)}h total</div>
      </div>
      <div class="month-card-stats">
        <div class="month-stat"><div class="month-stat-val" style="color:var(--green)">${met}</div><div class="month-stat-label">Met</div></div>
        <div class="month-stat"><div class="month-stat-val" style="color:var(--red)">${missed}</div><div class="month-stat-label">Missed</div></div>
        <div class="month-stat"><div class="month-stat-val">${best}</div><div class="month-stat-label">Best Streak</div></div>
      </div>
      <div class="month-mini-chart">${miniBars}</div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: DAILY CHART
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderChart(){
  const el=document.getElementById('chart');el.innerHTML='';
  if(!data.length)return;
  const sorted=[...data].sort((a,b)=>a.date.localeCompare(b.date));
  const startDt=new Date(sorted[0].date+'T00:00:00');
  const endDt=new Date(sorted[sorted.length-1].date+'T00:00:00');
  const dataMap={};sorted.forEach(d=>dataMap[d.date]=d);
  const allDays=[];
  for(let dt=new Date(startDt);dt<=endDt;dt.setDate(dt.getDate()+1)){
    const ds=toISO(dt);allDays.push({dateStr:ds,entry:dataMap[ds]||null});
  }
  const maxH=Math.max(...sorted.map(d=>d.hours),1);

  const yAxis=document.createElement('div');
  yAxis.style.cssText='position:absolute;left:0;top:0;bottom:20px;width:28px;display:flex;flex-direction:column;justify-content:space-between;pointer-events:none;';
  [1,0.75,0.5,0.25,0].forEach(f=>{
    const lbl=document.createElement('span');
    lbl.style.cssText='font-size:7px;color:var(--muted);text-align:right;width:100%;padding-right:4px;line-height:1;';
    lbl.textContent=f===0?'0':`${Math.round(maxH*f)}h`;
    yAxis.appendChild(lbl);
  });
  el.appendChild(yAxis);

  const floatLabel=document.createElement('div');
  floatLabel.style.cssText='position:absolute;top:4px;left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--accent);color:var(--accent);font-size:0.6rem;padding:4px 10px;border-radius:2px;pointer-events:none;opacity:0;transition:opacity 0.15s;white-space:nowrap;z-index:10;';
  el.appendChild(floatLabel);
  let floatTimer=null;

  const bars=document.createElement('div');bars.className='bars';bars.style.paddingLeft='30px';
  allDays.forEach(({dateStr,entry})=>{
    const wrap=document.createElement('div');wrap.className='bar-wrap';
    const bar=document.createElement('div');bar.className='bar';
    const ddmm=toDDMMYYYY(dateStr).slice(0,5);
    if(entry){
      bar.style.height=`${(entry.hours/maxH)*100}%`;
      bar.style.background=entry.result==='üü¢'?'var(--green)':'var(--red)';
      bar.style.opacity='0.85';
      bar.onclick=()=>{
        floatLabel.textContent=`${ddmm}  ${entry.hours}h / ${entry.target}h`;
        floatLabel.style.opacity='1';
        clearTimeout(floatTimer);
        floatTimer=setTimeout(()=>floatLabel.style.opacity='0',2000);
      };
    }else{
      bar.style.height='6px';bar.style.background='var(--border)';
    }
    const label=document.createElement('span');label.className='bar-label';label.textContent=ddmm;
    wrap.appendChild(bar);wrap.appendChild(label);bars.appendChild(wrap);
  });
  el.appendChild(bars);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: CUMULATIVE CHART
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCumulativeChart(){
  const el=document.getElementById('cumChart');el.innerHTML='';
  if(!data.length)return;
  const sorted=[...data].sort((a,b)=>a.date.localeCompare(b.date));
  let running=0;
  const points=sorted.map(d=>{running+=d.hours;return{date:d.date,total:running};});
  const maxTotal=points[points.length-1].total;
  const W=Math.max(600,points.length*12);const H=180;const PAD=24;
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`);svg.style.width=`${W}px`;svg.style.height=`${H}px`;
  [0.25,0.5,0.75,1].forEach(f=>{
    const y=PAD+(H-PAD*2)*(1-f);
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1','0');line.setAttribute('x2',W);line.setAttribute('y1',y);line.setAttribute('y2',y);
    line.setAttribute('stroke','#2a2b2e');line.setAttribute('stroke-width','1');svg.appendChild(line);
    const text=document.createElementNS('http://www.w3.org/2000/svg','text');
    text.setAttribute('x','4');text.setAttribute('y',y-3);text.setAttribute('fill','#6b6a65');text.setAttribute('font-size','8');
    text.textContent=`${(maxTotal*f).toFixed(0)}h`;svg.appendChild(text);
  });
  const xStep=(W-PAD*2)/(points.length-1||1);
  const pathD=points.map((p,i)=>`${i===0?'M':'L'}${PAD+i*xStep},${PAD+(H-PAD*2)*(1-p.total/maxTotal)}`).join(' ');
  const firstX=PAD,lastX=PAD+(points.length-1)*xStep;
  const area=document.createElementNS('http://www.w3.org/2000/svg','path');
  area.setAttribute('d',`${pathD} L${lastX},${H-PAD} L${firstX},${H-PAD} Z`);
  area.setAttribute('fill','rgba(245,200,66,0.08)');svg.appendChild(area);
  const path=document.createElementNS('http://www.w3.org/2000/svg','path');
  path.setAttribute('d',pathD);path.setAttribute('fill','none');path.setAttribute('stroke','var(--accent)');path.setAttribute('stroke-width','2');svg.appendChild(path);
  points.forEach((p,i)=>{
    const dt=new Date(p.date+'T00:00:00');
    if(dt.getDate()===1||i===0||i===points.length-1){
      const x=PAD+i*xStep,y=PAD+(H-PAD*2)*(1-p.total/maxTotal);
      const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx',x);c.setAttribute('cy',y);c.setAttribute('r','3');c.setAttribute('fill','var(--accent)');svg.appendChild(c);
      if(dt.getDate()===1){
        const t=document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x',x);t.setAttribute('y',H-8);t.setAttribute('text-anchor','middle');
        t.setAttribute('fill','#6b6a65');t.setAttribute('font-size','7');
        t.textContent=MONTHS[dt.getMonth()].slice(0,3);svg.appendChild(t);
      }
    }
  });
  el.appendChild(svg);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCalendar(){
  const calEl=document.getElementById('calendar');calEl.innerHTML='';
  const months={};
  data.forEach(d=>{
    const dt=new Date(d.date+'T00:00:00');
    const key=`${dt.getFullYear()}-${String(dt.getMonth()).padStart(2,'0')}`;
    if(!months[key])months[key]={year:dt.getFullYear(),month:dt.getMonth(),days:{}};
    months[key].days[dt.getDate()]=d;
  });
  Object.keys(months).sort().forEach(key=>{
    const m=months[key];
    const block=document.createElement('div');
    const title=document.createElement('div');title.className='month-title';
    title.textContent=`${MONTHS[m.month]} ${m.year}`;block.appendChild(title);
    const wdRow=document.createElement('div');wdRow.className='week-days';
    DAYS.forEach(dn=>{const w=document.createElement('div');w.className='wd';w.textContent=dn.slice(0,1);wdRow.appendChild(w);});
    block.appendChild(wdRow);
    const grid=document.createElement('div');grid.className='cal-grid';
    const firstDay=new Date(m.year,m.month,1).getDay();
    for(let i=0;i<firstDay;i++){const e=document.createElement('div');e.className='cal-day empty';grid.appendChild(e);}
    const totalDays=new Date(m.year,m.month+1,0).getDate();
    for(let d=1;d<=totalDays;d++){
      const cell=document.createElement('div');
      const entry=m.days[d];
      const dateStr=`${m.year}-${String(m.month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      if(entry){
        cell.className=`cal-day ${entry.result==='üü¢'?'green':'red'}`;
        cell.innerHTML=`<div class="dot"></div><div class="cal-day-num">${d}</div><div class="cal-hours">${entry.hours}h</div><div class="cal-target">/${entry.target}h</div><div class="cal-weekday">${entry.day}</div>`;
        cell.onclick=()=>openLogSheet(entry.date);
      }else{
        cell.className='cal-day';
        cell.innerHTML=`<div class="cal-day-num">${d}</div>`;
        cell.onclick=()=>openLogSheet(dateStr,true);
      }
      grid.appendChild(cell);
    }
    block.appendChild(grid);calEl.appendChild(block);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER: SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSettings(){
  renderTargetGrid();
  renderTargetSummary();
  renderCatList();
}

function renderTargetGrid(){
  const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  document.getElementById('targetGrid').innerHTML=days.map(d=>`
    <div class="target-day-cell">
      <div class="target-day-label">${d}</div>
      <input class="target-day-input" type="number" min="0" max="24" step="0.5"
        value="${targets[d]||0}" inputmode="decimal"
        onchange="targets['${d}']=+this.value;saveTargets();renderTargetSummary()">
    </div>`).join('');
  // Set weekday/weekend display values
  const wdVals=[targets.Mon,targets.Tue,targets.Wed,targets.Thu,targets.Fri];
  const weVals=[targets.Sat,targets.Sun];
  const allWd=wdVals.every(v=>v===wdVals[0]);
  const allWe=weVals.every(v=>v===weVals[0]);
  if(allWd)document.getElementById('targetWeekday').value=wdVals[0];
  if(allWe)document.getElementById('targetWeekend').value=weVals[0];
}

function renderTargetSummary(){
  const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const weekTotal=days.reduce((s,d)=>s+(targets[d]||0),0);
  const now=new Date();
  const daysInMonth=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
  // Approximate monthly by day-of-week distribution
  let monthTotal=0;
  for(let d=1;d<=daysInMonth;d++){
    const dow=new Date(now.getFullYear(),now.getMonth(),d).getDay();
    const dayN=DAYS[dow];
    monthTotal+=(targets[dayN]||0);
  }
  document.getElementById('targetSummary').innerHTML=
    `Weekly target: <strong style="color:var(--accent)">${weekTotal}h</strong> &nbsp;¬∑&nbsp; Monthly target: <strong style="color:var(--accent)">${monthTotal}h</strong>`;
}

function applyWeekdayDefault(){
  const val=+document.getElementById('targetWeekday').value;
  ['Mon','Tue','Wed','Thu','Fri'].forEach(d=>targets[d]=val);
  saveTargets();renderTargetGrid();renderTargetSummary();
  showToast('Weekday targets updated');
}

function applyWeekendDefault(){
  const val=+document.getElementById('targetWeekend').value;
  ['Sat','Sun'].forEach(d=>targets[d]=val);
  saveTargets();renderTargetGrid();renderTargetSummary();
  showToast('Weekend targets updated');
}

function renderCatList(){
  document.getElementById('catList').innerHTML=categories.map(cat=>`
    <div class="cat-item" id="catitem-${cat.id}">
      <div class="cat-item-header" onclick="toggleCatExpand('${cat.id}')">
        <div class="cat-color-dot" style="background:${cat.color}"></div>
        <div class="cat-item-name">${cat.name}</div>
        ${cat.isDefault?'<span class="cat-default-badge">Default</span>':''}
        <div class="cat-item-actions" onclick="event.stopPropagation()">
          ${!cat.isDefault?`<button class="cat-action-btn" title="Set as default" onclick="setCatDefault('${cat.id}')">‚≠ê</button>`:''}
          <button class="cat-action-btn" title="Edit" onclick="openEditCatSheet('${cat.id}')">‚úèÔ∏è</button>
        </div>
      </div>
      <div class="cat-subcats" id="subcats-${cat.id}">
        ${cat.subcategories.length?cat.subcategories.map(s=>`
          <div class="cat-subcat-item">
            <span>‚Ü≥ ${s}</span>
          </div>`).join(''):'<div style="font-size:0.6rem;color:var(--muted)">No subcategories</div>'}
      </div>
    </div>`).join('');
}

function toggleCatExpand(id){
  const el=document.getElementById(`subcats-${id}`);
  el.classList.toggle('open');
}

function setCatDefault(id){
  categories.forEach(c=>c.isDefault=c.id===id);
  saveCats();renderCatList();showToast('Default category updated');
}

// ‚îÄ‚îÄ CATEGORY SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let editingCatId=null;
let editorSubcats=[];

const COLOR_OPTIONS=CAT_COLORS;

function buildColorPicker(selectedColor){
  document.getElementById('colorPicker').innerHTML=COLOR_OPTIONS.map(c=>`
    <div onclick="selectColor('${c}')" style="width:28px;height:28px;border-radius:4px;background:${c};cursor:pointer;border:2px solid ${c===selectedColor?'var(--text)':'transparent'};transition:border 0.15s;" id="cp-${c.replace('#','')}"></div>`).join('');
}

let selectedCatColor=CAT_COLORS[0];
function selectColor(c){
  selectedCatColor=c;
  document.querySelectorAll('#colorPicker>div').forEach(el=>{
    el.style.border=`2px solid ${el.style.background===c?'var(--text)':'transparent'}`;
  });
}

function openAddCatSheet(){
  editingCatId=null;editorSubcats=[];selectedCatColor=CAT_COLORS[0];
  document.getElementById('catSheetTitle').textContent='Add Category';
  document.getElementById('catName').value='';
  document.getElementById('deleteCatBtn').style.display='none';
  buildColorPicker(selectedCatColor);
  renderSubcatEditor();
  document.getElementById('catSheet').classList.add('open');
}

function openEditCatSheet(id){
  const cat=categories.find(c=>c.id===id);if(!cat)return;
  editingCatId=id;editorSubcats=[...cat.subcategories];selectedCatColor=cat.color;
  document.getElementById('catSheetTitle').textContent='Edit Category';
  document.getElementById('catName').value=cat.name;
  document.getElementById('deleteCatBtn').style.display=cat.isDefault?'none':'block';
  buildColorPicker(selectedCatColor);
  renderSubcatEditor();
  document.getElementById('catSheet').classList.add('open');
}

function closeCatSheet(){document.getElementById('catSheet').classList.remove('open');}

function renderSubcatEditor(){
  document.getElementById('subcatEditList').innerHTML=editorSubcats.map((s,i)=>`
    <div style="display:flex;align-items:center;justify-content:space-between;background:var(--surface2);border:1px solid var(--border);border-radius:2px;padding:8px 12px;">
      <span style="font-size:0.7rem">${s}</span>
      <button onclick="removeSubcatInEditor(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:0.9rem;">‚úï</button>
    </div>`).join('');
}

function addSubcatInEditor(){
  const val=document.getElementById('newSubcatInput').value.trim();
  if(!val)return;
  editorSubcats.push(val);
  document.getElementById('newSubcatInput').value='';
  renderSubcatEditor();
}

function removeSubcatInEditor(i){
  editorSubcats.splice(i,1);renderSubcatEditor();
}

function saveCat(){
  const name=document.getElementById('catName').value.trim();
  if(!name){showToast('Enter a name');return;}
  if(editingCatId){
    const cat=categories.find(c=>c.id===editingCatId);
    if(cat){cat.name=name;cat.color=selectedCatColor;cat.subcategories=editorSubcats;}
  }else{
    categories.push({id:uid(),name,color:selectedCatColor,subcategories:editorSubcats,isDefault:false});
  }
  saveCats();renderCatList();closeCatSheet();
  showToast(editingCatId?'Category updated':'Category added');
}

function deleteCat(){
  if(!editingCatId)return;
  const cat=categories.find(c=>c.id===editingCatId);
  if(cat&&cat.isDefault){showToast("Can't delete the default category");return;}
  if(!confirm(`Delete "${cat.name}"?`))return;
  categories=categories.filter(c=>c.id!==editingCatId);
  saveCats();renderCatList();closeCatSheet();showToast('Category deleted');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOG SHEET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let editingDate=null;

function openLogSheet(dateStr=null,blank=false){
  editingDate=null;
  const existing=dateStr?data.find(d=>d.date===dateStr):null;
  if(existing){
    editingDate=existing.date;
    document.getElementById('logTitle').textContent=`Edit ‚Äî ${toDDMMYYYY(existing.date)}`;
    document.getElementById('inputDate').value=existing.date;
    document.getElementById('inputDate').readOnly=true;
    document.getElementById('inputTarget').value=existing.target;
    document.getElementById('deleteBtn').style.display='block';
    // Load existing sessions
    renderSessionsList(existing.sessions);
  }else{
    const todayStr=toISO(new Date());
    const ds=dateStr||todayStr;
    document.getElementById('logTitle').textContent='Log Entry';
    document.getElementById('inputDate').value=ds;
    document.getElementById('inputDate').readOnly=!!dateStr&&!blank;
    document.getElementById('inputTarget').value=getDefaultTarget(ds);
    document.getElementById('deleteBtn').style.display='none';
    // Start with one empty session using default category
    renderSessionsList([{category:getDefaultCat().name,subcategory:'',hours:''}]);
  }
  updateSessionTotal();
  document.getElementById('logOverlay').classList.add('open');
  setTimeout(()=>document.querySelector('.session-hours-input')?.focus(),150);
}

function closeLogSheet(){
  document.getElementById('logOverlay').classList.remove('open');
  document.getElementById('inputDate').readOnly=false;
}

function onDateChange(){
  const ds=document.getElementById('inputDate').value;
  if(ds&&!editingDate){
    document.getElementById('inputTarget').value=getDefaultTarget(ds);
  }
}

function renderSessionsList(sessions){
  document.getElementById('sessionsList').innerHTML='';
  sessions.forEach(s=>addSessionRow(s));
}

function addSession(){
  addSessionRow({category:getDefaultCat().name,subcategory:'',hours:''});
  updateSessionTotal();
}

function addSessionRow(s){
  const list=document.getElementById('sessionsList');
  const row=document.createElement('div');row.className='session-row';

  const catOptions=categories.map(c=>`<option value="${c.name}" ${c.name===s.category?'selected':''}>${c.name}</option>`).join('');
  const selCat=categories.find(c=>c.name===s.category)||categories[0];
  const subcatOptions=`<option value="">‚Äî subcategory ‚Äî</option>`+
    (selCat?selCat.subcategories.map(x=>`<option value="${x}" ${x===s.subcategory?'selected':''}>${x}</option>`).join(''):'');

  row.innerHTML=`
    <button class="session-remove" onclick="removeSessionRow(this)">‚úï</button>
    <div class="session-row-top">
      <select class="session-select" onchange="onCatChange(this)">${catOptions}</select>
      <input class="session-hours-input" type="number" min="0" max="24" step="0.25"
        inputmode="decimal" placeholder="0h" value="${s.hours||''}" oninput="updateSessionTotal()">
    </div>
    <select class="session-select" style="width:100%">${subcatOptions}</select>`;
  list.appendChild(row);
}

function onCatChange(sel){
  const catName=sel.value;
  const cat=categories.find(c=>c.name===catName);
  const subcatSel=sel.closest('.session-row').querySelectorAll('.session-select')[1];
  if(subcatSel){
    subcatSel.innerHTML=`<option value="">‚Äî subcategory ‚Äî</option>`+
      (cat?cat.subcategories.map(x=>`<option value="${x}">${x}</option>`).join(''):'');
  }
}

function removeSessionRow(btn){
  const rows=document.getElementById('sessionsList').querySelectorAll('.session-row');
  if(rows.length<=1){showToast('At least one session required');return;}
  btn.closest('.session-row').remove();
  updateSessionTotal();
}

function updateSessionTotal(){
  let total=0;
  document.querySelectorAll('.session-hours-input').forEach(inp=>{total+=(+inp.value||0);});
  document.getElementById('sessionTotal').textContent=total.toFixed(2).replace(/\.?0+$/,'');
}

function getSessionsFromForm(){
  const sessions=[];
  document.querySelectorAll('#sessionsList .session-row').forEach(row=>{
    const sels=row.querySelectorAll('.session-select');
    const hrs=+row.querySelector('.session-hours-input').value||0;
    sessions.push({
      category:sels[0]?sels[0].value:'General',
      subcategory:sels[1]?sels[1].value:'',
      hours:hrs
    });
  });
  return sessions.filter(s=>s.hours>0);
}

function saveEntry(){
  const dateVal=document.getElementById('inputDate').value;
  const targetVal=parseFloat(document.getElementById('inputTarget').value);
  if(!dateVal||isNaN(targetVal)){showToast('Fill in date and target');return;}
  const sessions=getSessionsFromForm();
  if(!sessions.length){showToast('Add at least one session with hours > 0');return;}
  const hours=sessions.reduce((s,x)=>s+x.hours,0);
  const entry=normalize({date:dateVal,hours,target:targetVal,sessions});
  if(editingDate){const idx=data.findIndex(d=>d.date===editingDate);if(idx>=0)data[idx]=entry;}
  else{const idx=data.findIndex(d=>d.date===dateVal);if(idx>=0)data[idx]=entry;else data.push(entry);}
  saveData();closeLogSheet();render();
  showToast(editingDate?'Updated ‚úì':'Saved ‚úì');
  const url=localStorage.getItem(SHEET_URL_KEY);
  if(url&&navigator.onLine){setSyncPill('syncing','‚ü≥ syncing‚Ä¶');autoSync(url);}
}

function deleteEntry(){
  if(!editingDate||!confirm(`Delete ${toDDMMYYYY(editingDate)}?`))return;
  data=data.filter(d=>d.date!==editingDate);
  saveData();closeLogSheet();render();showToast('Deleted');
  const url=localStorage.getItem(SHEET_URL_KEY);
  if(url&&navigator.onLine){setSyncPill('syncing','‚ü≥ syncing‚Ä¶');autoSync(url);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CSV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV(){
  const rows=['Date,Day,Hours,Target,Result,Categories'];
  data.forEach(d=>{
    const cats=(d.sessions||[]).map(s=>`${s.category}${s.subcategory?'/'+s.subcategory:''}:${s.hours}h`).join('; ');
    rows.push(`${d.date},${d.day},${d.hours},${d.target},${d.result==='üü¢'?'Met':'Missed'},"${cats}"`);
  });
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='art_hours_backup.csv';a.click();
  URL.revokeObjectURL(url);showToast('CSV downloaded ‚úì');
}

function parseCSVText(text){
  const lines=text.trim().split('\n');let count=0;
  lines.slice(1).forEach(line=>{
    // Handle quoted fields
    const p=line.match(/(".*?"|[^,]+)(?=,|$)/g)||line.split(',');
    if(p.length>=4){
      const date=p[0].trim().replace(/"/g,'');
      const hours=parseFloat(p[2]);const target=parseFloat(p[3]);
      if(date&&!isNaN(hours)&&!isNaN(target)){
        const entry=normalize({date,hours,target});
        const idx=data.findIndex(d=>d.date===date);if(idx>=0)data[idx]=entry;else data.push(entry);count++;
      }
    }
  });return count;
}

function openImportSheet(){document.getElementById('csvPasteArea').value='';document.getElementById('importStatus').textContent='';document.getElementById('importOverlay').classList.add('open');}
function closeImportSheet(){document.getElementById('importOverlay').classList.remove('open');}

function importFromPaste(){
  const text=document.getElementById('csvPasteArea').value.trim();
  if(!text){document.getElementById('importStatus').textContent='‚ö† Nothing pasted';document.getElementById('importStatus').style.color='var(--accent)';return;}
  const count=parseCSVText(text);
  if(!count){document.getElementById('importStatus').textContent='‚úó No valid rows found';document.getElementById('importStatus').style.color='var(--red)';return;}
  saveData();render();
  document.getElementById('importStatus').textContent=`‚úì Imported ${count} entries`;
  document.getElementById('importStatus').style.color='var(--green)';
  setTimeout(()=>closeImportSheet(),1500);
  showToast(`Imported ${count} entries ‚úì`);
}

function importCSV(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const count=parseCSVText(ev.target.result);
    if(!count){showToast('No valid rows found');return;}
    saveData();render();showToast(`Imported ${count} entries ‚úì`);closeImportSheet();
  };
  reader.readAsText(file);e.target.value='';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GOOGLE SHEETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSheetSheet(){const saved=localStorage.getItem(SHEET_URL_KEY)||'';document.getElementById('sheetUrl').value=saved;document.getElementById('sheetStatus').textContent='';document.getElementById('sheetOverlay').classList.add('open');}
function closeSheetSheet(){document.getElementById('sheetOverlay').classList.remove('open');}
function getSheetUrl(){
  const url=document.getElementById('sheetUrl').value.trim();
  if(!url){setSheetStatus('‚ö† Enter your Web App URL','var(--red)');return null;}
  localStorage.setItem(SHEET_URL_KEY,url);return url;
}
function setSheetStatus(msg,color='var(--muted)'){const el=document.getElementById('sheetStatus');el.textContent=msg;el.style.color=color;}

async function gsheetSync(silent=false){
  const url=getSheetUrl();if(!url)return;
  if(!silent)setSheetStatus('Syncing‚Ä¶');
  setSyncPill('syncing','‚ü≥ syncing‚Ä¶');
  try{
    const pushJson=await sheetFetch(url,{action:'sync',data});
    if(pushJson.error)throw new Error(pushJson.error);
    const pullJson=await sheetFetch(url,{action:'load'});
    if(pullJson.data&&pullJson.data.length){
      pullJson.data.forEach(imp=>{
        const idx=data.findIndex(d=>d.date===imp.date);
        const entry=normalize(imp);
        if(idx>=0)data[idx]=entry;else data.push(entry);
      });
      saveData();render();
    }
    setSyncPill('synced','‚úì synced');
    if(!silent)setSheetStatus(`‚úì Synced ‚Äî ${pushJson.synced} pushed, ${pullJson.data?pullJson.data.length:0} pulled`,'var(--green)');
    showToast('Synced ‚úì');
  }catch(e){setSyncPill('offline','‚úï sync failed');if(!silent)setSheetStatus(`‚úó ${e.message}`,'var(--red)');}
}

async function gsheetLoad(){
  const url=getSheetUrl();if(!url)return;
  setSheetStatus('Loading‚Ä¶');
  try{
    const json=await sheetFetch(url,{action:'load'});
    if(json.error)throw new Error(json.error);
    if(!json.data||!json.data.length){setSheetStatus('Sheet is empty','var(--accent)');return;}
    json.data.forEach(imp=>{
      const idx=data.findIndex(d=>d.date===imp.date);
      const entry=normalize(imp);
      if(idx>=0)data[idx]=entry;else data.push(entry);
    });
    saveData();render();
    setSheetStatus(`‚úì Loaded ${json.data.length} entries`,'var(--green)');showToast('Loaded ‚úì');
  }catch(e){setSheetStatus(`‚úó ${e.message}`,'var(--red)');}
}

async function gsheetBackup(){
  const url=getSheetUrl();if(!url)return;
  if(!confirm(`Overwrite sheet with all ${data.length} entries?`))return;
  setSheetStatus('Backing up‚Ä¶');
  try{
    const clearJson=await sheetFetch(url,{action:'clear'});
    if(clearJson.error)throw new Error(clearJson.error);
    const json=await sheetFetch(url,{action:'sync',data});
    if(json.error)throw new Error(json.error);
    setSheetStatus(`‚úì Backup complete ‚Äî ${json.synced} rows`,'var(--green)');showToast('Backed up ‚úì');
  }catch(e){setSheetStatus(`‚úó ${e.message}`,'var(--red)');}
}

function clearSheetUrl(){localStorage.removeItem(SHEET_URL_KEY);document.getElementById('sheetUrl').value='';setSheetStatus('Disconnected');setSyncPill('nosync','‚óã no sync');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KEYBOARD & OVERLAY CLOSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    closeLogSheet();closeSheetSheet();closeImportSheet();
    closeBadgeSheet();closeCatSheet();
  }
});
['logOverlay','sheetOverlay','importOverlay','badgeOverlay','catSheet'].forEach(id=>{
  document.getElementById(id).addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('open');});
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Check for migration
const needsMigration=migrateOldData();
if(needsMigration){
  data=loadData(); // reload migrated data
  document.getElementById('migrationOverlay').classList.add('open');
}else if(!localStorage.getItem(MIGRATED_KEY)){
  // Fresh install ‚Äî mark as migrated so prompt never shows
  localStorage.setItem(MIGRATED_KEY,'1');
}

render();
</script>
</body>
</html>
