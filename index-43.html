<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Art Hours">
<meta name="theme-color" content="#0e0e0f">
<title>Art Hours</title>
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%230e0e0f'/><text x='50%' y='55%' font-size='100' text-anchor='middle' dominant-baseline='middle'>ðŸŽ¨</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e0e0f;--surface:#17181a;--surface2:#1e1f22;--border:#2a2b2e;
  --green:#4ade80;--red:#f87171;--accent:#f5c842;--text:#e8e6e0;--muted:#6b6a65;
  --nav-h:68px;--safe-bottom:env(safe-area-inset-bottom,0px);--safe-top:env(safe-area-inset-top,0px);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}

/* UNLOCK SCREEN */
.unlock-screen{position:fixed;inset:0;background:var(--bg);z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 28px;transition:opacity 0.4s ease;}
.unlock-screen.hide{opacity:0;pointer-events:none;}
.unlock-logo{font-size:4rem;margin-bottom:16px;}
.unlock-title{font-family:'Playfair Display',serif;font-size:2rem;font-weight:900;color:var(--accent);margin-bottom:6px;text-align:center;}
.unlock-sub{font-size:0.6rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:40px;text-align:center;}
.unlock-field{width:100%;max-width:340px;margin-bottom:12px;}
.unlock-field label{display:block;font-size:0.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.unlock-input{width:100%;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:1rem;padding:16px 14px;outline:none;border-radius:2px;transition:border-color 0.15s;-webkit-appearance:none;letter-spacing:2px;}
.unlock-input:focus{border-color:var(--accent);}
.unlock-btn{width:100%;max-width:340px;background:var(--accent);color:var(--bg);border:none;font-family:'Space Mono',monospace;font-size:0.7rem;letter-spacing:3px;text-transform:uppercase;padding:16px;cursor:pointer;border-radius:2px;margin-top:4px;font-weight:700;transition:opacity 0.15s;}
.unlock-btn:active{opacity:0.8;}
.unlock-err{width:100%;max-width:340px;font-size:0.65rem;color:var(--red);margin-top:10px;text-align:center;min-height:20px;line-height:1.6;}
.unlock-skip{margin-top:20px;font-size:0.58rem;color:var(--muted);text-align:center;cursor:pointer;text-decoration:underline;text-underline-offset:3px;}
.unlock-syncing{margin-top:16px;font-size:0.6rem;color:var(--accent);letter-spacing:2px;text-transform:uppercase;display:none;}
.unlock-syncing.show{display:block;}
html,body{height:100%;overflow-x:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Space Mono',monospace;padding-bottom:calc(var(--nav-h) + var(--safe-bottom) + 16px);}

/* HEADER */
.header{padding:calc(16px + var(--safe-top)) 20px 14px;background:var(--bg);position:sticky;top:0;z-index:10;border-bottom:1px solid var(--border);display:flex;align-items:flex-end;justify-content:space-between;gap:12px;}
.header-left h1{font-family:'Playfair Display',serif;font-size:1.9rem;font-weight:900;color:var(--accent);letter-spacing:-0.5px;line-height:1;}
.header-left .subtitle{font-size:0.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:4px;}
.header-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0;}
.sync-pill{font-size:0.55rem;letter-spacing:1px;text-transform:uppercase;padding:4px 10px;border-radius:20px;border:1px solid var(--border);color:var(--muted);white-space:nowrap;cursor:pointer;transition:all 0.2s;}
.sync-pill.syncing{border-color:var(--accent);color:var(--accent);}
.sync-pill.synced{border-color:var(--green);color:var(--green);}
.sync-pill.offline{border-color:var(--red);color:var(--red);}
.sync-pill.nosync{border-color:var(--border);color:var(--muted);}
.level-badge{font-size:0.6rem;letter-spacing:1px;padding:4px 10px;border-radius:20px;border:1px solid var(--accent);color:var(--accent);white-space:nowrap;cursor:pointer;}

/* INSTALL */
.install-banner{background:var(--surface);border:1px solid var(--accent);margin:12px 20px 0;padding:12px 16px;display:none;align-items:center;gap:12px;border-radius:2px;}
.install-banner.show{display:flex;}
.install-banner-text{flex:1;font-size:0.65rem;color:var(--text);line-height:1.5;}
.install-banner-text strong{color:var(--accent);display:block;margin-bottom:2px;}
.install-btn{background:var(--accent);color:var(--bg);border:none;font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:1px;text-transform:uppercase;padding:8px 14px;cursor:pointer;border-radius:2px;white-space:nowrap;flex-shrink:0;}
.install-dismiss{background:none;border:none;color:var(--muted);font-size:1.1rem;cursor:pointer;padding:0 4px;}
.ios-hint{background:var(--surface);border:1px solid var(--border);margin:12px 20px 0;padding:12px 16px;display:none;border-radius:2px;}
.ios-hint.show{display:block;}
.ios-hint p{font-size:0.62rem;color:var(--muted);line-height:1.7;}
.ios-hint strong{color:var(--text);}

/* PAGES */
.page{display:none;padding:20px;}
.page.active{display:block;}

/* NAV */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;height:calc(var(--nav-h) + var(--safe-bottom));background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:flex-start;padding-top:8px;z-index:50;}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 4px;cursor:pointer;border:none;background:none;color:var(--muted);font-family:'Space Mono',monospace;font-size:0.45rem;letter-spacing:1px;text-transform:uppercase;transition:color 0.15s;}
.nav-item.active{color:var(--accent);}
.nav-item svg{width:20px;height:20px;}

/* FAB */
.fab{position:fixed;bottom:calc(var(--nav-h) + var(--safe-bottom) + 16px);right:20px;width:56px;height:56px;background:var(--accent);border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(245,200,66,0.4);z-index:49;font-size:1.6rem;color:var(--bg);transition:transform 0.15s;}
.fab:active{transform:scale(0.92);}
.fab.timer-active{background:var(--green);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{box-shadow:0 4px 20px rgba(74,222,128,0.4)}50%{box-shadow:0 4px 32px rgba(74,222,128,0.7)}}

/* TIMER PAGE */
.timer-tabs{display:flex;gap:0;margin-bottom:28px;border:1px solid var(--border);border-radius:2px;overflow:hidden;}
.timer-tab{flex:1;text-align:center;font-size:0.58rem;letter-spacing:1px;text-transform:uppercase;padding:10px 4px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-family:'Space Mono',monospace;transition:all 0.15s;}
.timer-tab.active{background:var(--surface2);color:var(--accent);}
.timer-tab:not(:last-child){border-right:1px solid var(--border);}

/* RING */
.ring-wrap{display:flex;justify-content:center;margin-bottom:28px;position:relative;}
.ring-svg{transform:rotate(-90deg);}
.ring-bg{fill:none;stroke:var(--surface2);stroke-width:8;}
.ring-fill{fill:none;stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset 1s linear,stroke 0.3s;}
.ring-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;}
.ring-time{font-family:'Playfair Display',serif;font-size:2.8rem;font-weight:700;color:var(--text);line-height:1;letter-spacing:-1px;}
.ring-label{font-size:0.55rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:6px;}
.ring-phase{font-size:0.6rem;letter-spacing:2px;text-transform:uppercase;margin-top:4px;}

/* POMODORO CYCLES */
.pomo-cycles{display:flex;justify-content:center;gap:8px;margin-bottom:20px;}
.pomo-dot{width:10px;height:10px;border-radius:50%;border:1px solid var(--border);transition:all 0.3s;}
.pomo-dot.done{background:var(--accent);border-color:var(--accent);}
.pomo-dot.current{border-color:var(--accent);}

/* TIMER CONTROLS */
.timer-controls{display:flex;justify-content:center;gap:12px;margin-bottom:24px;}
.timer-btn{width:60px;height:60px;border-radius:50%;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:1.4rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
.timer-btn.primary{width:72px;height:72px;border-color:var(--accent);color:var(--accent);}
.timer-btn:active{transform:scale(0.92);}

/* TIMER STATS */
.timer-stat-row{display:flex;justify-content:center;gap:32px;margin-bottom:24px;}
.timer-stat{text-align:center;}
.timer-stat-val{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--accent);}
.timer-stat-label{font-size:0.5rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:2px;}

/* POMODORO SETTINGS */
.pomo-settings{background:var(--surface);border:1px solid var(--border);border-radius:2px;padding:16px;margin-bottom:20px;}
.pomo-settings-title{font-size:0.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
.pomo-settings-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
.pomo-setting-cell{display:flex;flex-direction:column;gap:4px;}
.pomo-setting-label{font-size:0.5rem;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
.pomo-setting-input{background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.9rem;padding:8px;text-align:center;border-radius:2px;outline:none;-webkit-appearance:none;}
.pomo-setting-input:focus{border-color:var(--accent);}

/* LAPS */
.laps-list{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto;}
.lap-item{display:flex;justify-content:space-between;align-items:center;font-size:0.65rem;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:2px;}
.lap-num{color:var(--muted);}
.lap-time{color:var(--accent);font-family:'Playfair Display',serif;}
.lap-total{color:var(--muted);font-size:0.55rem;}

/* NAV INDICATOR DOT */
.nav-dot{width:5px;height:5px;border-radius:50%;background:var(--green);position:absolute;top:6px;right:calc(50% - 14px);display:none;}
.nav-dot.show{display:block;}
.nav-item{position:relative;}

/* COUNTDOWN INPUT */
.countdown-inputs{display:flex;justify-content:center;align-items:center;gap:12px;margin-bottom:28px;}
.countdown-unit{display:flex;flex-direction:column;align-items:center;gap:4px;}
.countdown-input{width:72px;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Playfair Display',serif;font-size:2rem;padding:12px 8px;text-align:center;border-radius:2px;outline:none;-webkit-appearance:none;}
.countdown-input:focus{border-color:var(--accent);}
.countdown-sep{font-family:'Playfair Display',serif;font-size:2rem;color:var(--muted);margin-top:-8px;}
.countdown-unit-label{font-size:0.5rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}

/* SECTION TITLE */
.section-title{font-size:0.6rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);}

/* STATS GRID */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:24px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:2px;padding:16px;}
.stat-val{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;color:var(--accent);line-height:1;}
.stat-label{font-size:0.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:6px;}

/* PROGRESS BARS */
.progress-wrap{margin-bottom:20px;}
.progress-title{font-size:0.6rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.progress-bar-bg{background:var(--surface2);border-radius:2px;height:10px;overflow:hidden;margin-bottom:4px;}
.progress-bar-fill{height:100%;border-radius:2px;transition:width 0.4s ease;}
.progress-meta{display:flex;justify-content:space-between;font-size:0.58rem;color:var(--muted);}

/* LEVEL CARD */
.level-card{background:var(--surface);border:2px solid var(--accent);border-radius:2px;padding:20px;margin-bottom:24px;position:relative;overflow:hidden;}
.level-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--green));}
.level-name{font-family:'Playfair Display',serif;font-size:1.6rem;color:var(--accent);margin-bottom:4px;}
.level-num{font-size:0.6rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);}
.level-progress-bg{background:var(--surface2);border-radius:2px;height:8px;margin:12px 0 6px;}
.level-progress-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--green));}
.level-progress-meta{display:flex;justify-content:space-between;font-size:0.58rem;color:var(--muted);}

/* BADGES */
.badges-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:24px;}
.badge{background:var(--surface);border:1px solid var(--border);border-radius:2px;padding:12px 8px;text-align:center;transition:all 0.2s;cursor:pointer;}
.badge.earned{border-color:var(--accent);background:rgba(245,200,66,0.06);}
.badge-icon{font-size:1.6rem;display:block;margin-bottom:6px;filter:grayscale(1);opacity:0.3;}
.badge.earned .badge-icon{filter:none;opacity:1;}
.badge-name{font-size:0.5rem;letter-spacing:1px;text-transform:uppercase;color:var(--muted);line-height:1.4;}
.badge.earned .badge-name{color:var(--text);}

/* STREAK COMPARE */
.streak-compare{background:var(--surface);border:1px solid var(--border);border-radius:2px;padding:16px;margin-bottom:24px;}
.streak-compare-title{font-size:0.6rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}
.streak-bars{display:flex;gap:16px;align-items:flex-end;height:80px;margin-bottom:8px;}
.streak-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;}
.streak-bar{width:100%;border-radius:2px 2px 0 0;transition:height 0.4s ease;}
.streak-bar-label{font-size:0.55rem;color:var(--muted);text-align:center;}
.streak-bar-val{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--accent);}

/* MONTHLY CARDS */
.monthly-cards{display:flex;flex-direction:column;gap:16px;margin-bottom:24px;}
.month-card{background:var(--surface);border:1px solid var(--border);border-radius:2px;padding:16px;}
.month-card-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:12px;}
.month-card-name{font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--accent);}
.month-card-total{font-size:0.65rem;color:var(--muted);}
.month-card-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;}
.month-stat{text-align:center;}
.month-stat-val{font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--text);}
.month-stat-label{font-size:0.48rem;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
.month-mini-chart{display:flex;align-items:flex-end;gap:1px;height:28px;}
.month-mini-bar{flex:1;border-radius:1px 1px 0 0;min-height:2px;}

/* PIE CHART */
.pie-section{margin-bottom:24px;}
.pie-toggle{display:flex;gap:8px;margin-bottom:14px;}
.pie-tab{flex:1;text-align:center;font-size:0.58rem;letter-spacing:1px;text-transform:uppercase;padding:8px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;border-radius:2px;font-family:'Space Mono',monospace;}
.pie-tab.active{border-color:var(--accent);color:var(--accent);}
.pie-wrap{display:flex;flex-direction:column;align-items:center;gap:16px;}
.pie-legend{width:100%;display:flex;flex-direction:column;gap:8px;}
.pie-legend-item{display:flex;align-items:center;gap:10px;font-size:0.62rem;}
.pie-legend-dot{width:12px;height:12px;border-radius:2px;flex-shrink:0;}
.pie-legend-name{flex:1;color:var(--text);}
.pie-legend-val{color:var(--muted);}
.pie-empty{text-align:center;color:var(--muted);font-size:0.7rem;padding:40px 0;}

/* CHART */
.chart-tabs{display:flex;gap:8px;margin-bottom:14px;}
.chart-tab{flex:1;text-align:center;font-size:0.58rem;letter-spacing:1px;text-transform:uppercase;padding:8px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;border-radius:2px;font-family:'Space Mono',monospace;}
.chart-tab.active{border-color:var(--accent);color:var(--accent);}
.chart-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;margin-bottom:24px;}
.chart-wrap{background:var(--surface);border:1px solid var(--border);padding:16px 16px 36px;}
.chart-inner{position:relative;height:180px;min-width:600px;}
.bars{position:absolute;inset:0;display:flex;align-items:flex-end;gap:2px;padding-bottom:20px;}
.bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%;position:relative;}
.bar{width:100%;border-radius:2px 2px 0 0;min-height:4px;cursor:default;}
.bar-label{font-size:6px;color:var(--muted);white-space:nowrap;position:absolute;bottom:-18px;left:50%;transform:rotate(-55deg);transform-origin:left center;}
.cum-chart{position:relative;height:180px;min-width:600px;}

/* CALENDAR */
.calendar-grid{display:flex;flex-direction:column;gap:28px;}
.month-title{font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--accent);margin-bottom:10px;}
.week-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:2px;}
.wd{text-align:center;font-size:0.5rem;color:var(--muted);padding:3px 0;text-transform:uppercase;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.cal-day{background:var(--surface);border:1px solid var(--border);padding:5px 3px;min-height:60px;display:flex;flex-direction:column;gap:2px;position:relative;cursor:pointer;border-radius:1px;}
.cal-day:active{opacity:0.7;}
.cal-day.empty{background:transparent;border-color:transparent;cursor:default;pointer-events:none;}
.cal-day.green{border-color:var(--green);background:rgba(74,222,128,0.07);}
.cal-day.red{border-color:var(--red);background:rgba(248,113,113,0.07);}
.cal-day.streak-glow{border-color:var(--green);background:rgba(74,222,128,0.11);animation:streakPulse 2.4s ease-in-out infinite;}
@keyframes streakPulse{0%,100%{box-shadow:0 0 0 0 rgba(74,222,128,0);background:rgba(74,222,128,0.09);}50%{box-shadow:0 0 8px 2px rgba(74,222,128,0.22);background:rgba(74,222,128,0.17);}}
.cal-day.streak-glow .cal-day-num{color:var(--green);}
.cal-day.streak-glow .cal-hours{color:var(--green);}
.cal-day.streak-glow .dot{background:var(--green);}
.cal-day.miss-glow{border-color:var(--red);border-width:2px;background:rgba(248,113,113,0.18);animation:missPulse 2s ease-in-out infinite;}
@keyframes missPulse{0%,100%{box-shadow:0 0 4px 1px rgba(248,113,113,0.3);background:rgba(248,113,113,0.14);}50%{box-shadow:0 0 14px 4px rgba(248,113,113,0.55);background:rgba(248,113,113,0.26);}}
.cal-day.miss-glow .cal-day-num{color:var(--red);}
.cal-day.miss-glow .cal-hours{color:var(--red);}
.cal-day.miss-glow .dot{background:var(--red);}
.cal-day-num{font-size:0.58rem;color:var(--muted);}
.cal-day.green .cal-day-num{color:var(--green);}
.cal-day.red .cal-day-num{color:var(--red);}
.cal-hours{font-family:'Playfair Display',serif;font-size:0.9rem;font-weight:700;line-height:1;}
.cal-day.green .cal-hours{color:var(--green);}
.cal-day.red .cal-hours{color:var(--red);}
.cal-target{font-size:0.5rem;color:var(--muted);}
.cal-weekday{font-size:0.45rem;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-top:auto;}
.dot{width:5px;height:5px;border-radius:50%;position:absolute;top:4px;right:4px;}
.green .dot{background:var(--green);}
.red .dot{background:var(--red);}
.legend{display:flex;gap:16px;margin-bottom:14px;font-size:0.6rem;color:var(--muted);align-items:center;}
.legend-item{display:flex;align-items:center;gap:5px;}
.legend-dot{width:8px;height:8px;border-radius:50%;}

/* SETTINGS */
.settings-section{margin-bottom:28px;}
.settings-row{display:flex;align-items:center;justify-content:space-between;background:var(--surface);border:1px solid var(--border);padding:14px 16px;margin-bottom:8px;border-radius:2px;cursor:pointer;gap:12px;}
.settings-row:active{opacity:0.7;}
.settings-row-left{flex:1;}
.settings-row-title{font-size:0.75rem;color:var(--text);margin-bottom:3px;}
.settings-row-desc{font-size:0.6rem;color:var(--muted);}
.settings-row-val{font-size:0.7rem;color:var(--accent);white-space:nowrap;}

/* TARGET GRID */
.target-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:16px;}
.target-day-cell{display:flex;flex-direction:column;align-items:center;gap:4px;}
.target-day-label{font-size:0.5rem;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
.target-day-input{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.7rem;padding:8px 4px;text-align:center;outline:none;border-radius:2px;-webkit-appearance:none;}
.target-day-input:focus{border-color:var(--accent);}
.target-quick{display:flex;gap:8px;margin-bottom:16px;}
.target-quick-btn{flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--muted);font-family:'Space Mono',monospace;font-size:0.55rem;letter-spacing:1px;text-transform:uppercase;padding:10px 6px;cursor:pointer;border-radius:2px;text-align:center;}
.target-quick-btn:active{border-color:var(--accent);color:var(--accent);}

/* CATEGORY LIST */
.cat-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;}
.cat-item{background:var(--surface);border:1px solid var(--border);border-radius:2px;overflow:hidden;}
.cat-item-header{display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer;}
.cat-color-dot{width:14px;height:14px;border-radius:3px;flex-shrink:0;}
.cat-item-name{flex:1;font-size:0.75rem;color:var(--text);}
.cat-default-badge{font-size:0.48rem;letter-spacing:1px;text-transform:uppercase;color:var(--accent);border:1px solid var(--accent);padding:2px 6px;border-radius:10px;}
.cat-item-actions{display:flex;gap:6px;}
.cat-action-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.75rem;padding:4px;}
.cat-subcats{padding:0 14px 12px 38px;display:none;flex-direction:column;gap:6px;}
.cat-subcats.open{display:flex;}
.cat-subcat-item{display:flex;align-items:center;justify-content:space-between;font-size:0.65rem;color:var(--muted);}
.add-subcat-row{display:flex;gap:6px;margin-top:4px;}

/* SESSIONS IN LOG */
.sessions-list{display:flex;flex-direction:column;gap:10px;margin-bottom:12px;}
.session-row{background:var(--surface2);border:1px solid var(--border);border-radius:2px;padding:10px 12px;position:relative;}
.session-row-top{display:flex;gap:8px;margin-bottom:8px;}
.session-select{flex:1;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.65rem;padding:10px 8px;outline:none;border-radius:2px;-webkit-appearance:none;cursor:pointer;}
.session-hours-input{width:72px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.8rem;padding:10px 8px;text-align:center;outline:none;border-radius:2px;-webkit-appearance:none;}
.session-hours-input:focus,.session-select:focus{border-color:var(--accent);}
.session-remove{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem;line-height:1;padding:2px;}
.session-total{text-align:right;font-size:0.65rem;color:var(--muted);margin-bottom:12px;}
.session-total span{color:var(--accent);font-family:'Playfair Display',serif;font-size:1rem;}
.add-session-btn{width:100%;background:transparent;border:1px dashed var(--border);color:var(--muted);font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:2px;text-transform:uppercase;padding:12px;cursor:pointer;border-radius:2px;margin-bottom:14px;}
.add-session-btn:active{border-color:var(--accent);color:var(--accent);}

/* BACKUP ROWS */
.backup-row{display:flex;align-items:center;gap:14px;background:var(--surface);border:1px solid var(--border);padding:16px;margin-bottom:10px;border-radius:2px;cursor:pointer;}
.backup-row:active{opacity:0.7;}
.backup-row-icon{font-size:1.4rem;width:32px;text-align:center;}
.backup-row-title{font-size:0.75rem;color:var(--text);margin-bottom:3px;}
.backup-row-desc{font-size:0.6rem;color:var(--muted);}

/* SHEET OVERLAY */
.sheet-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:100;align-items:flex-end;justify-content:center;}
.sheet-overlay.open{display:flex;}
.sheet{background:var(--surface);border-top:1px solid var(--border);border-radius:16px 16px 0 0;padding:0 24px calc(32px + var(--safe-bottom));width:100%;max-width:600px;max-height:92vh;overflow-y:auto;animation:slideUp 0.25s ease-out;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:14px auto 20px;}
.sheet h2{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--accent);margin-bottom:20px;}
.field{margin-bottom:16px;}
.field label{display:block;font-size:0.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.field input,.field select,.field textarea{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.9rem;padding:14px 12px;outline:none;border-radius:2px;transition:border-color 0.15s;-webkit-appearance:none;}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--accent);}
.sheet-actions{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;}
.btn{background:transparent;border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.65rem;letter-spacing:2px;text-transform:uppercase;padding:12px 18px;cursor:pointer;border-radius:2px;transition:all 0.15s;white-space:nowrap;min-height:44px;}
.btn:active{opacity:0.7;}
.btn.primary{border-color:var(--accent);color:var(--accent);}
.btn.danger{border-color:var(--red);color:var(--red);}
.btn.full{width:100%;text-align:center;display:block;}
.sheet-status{font-size:0.65rem;margin-top:14px;min-height:18px;}

/* TOAST */
.toast{position:fixed;bottom:calc(var(--nav-h) + var(--safe-bottom) + 20px);left:50%;transform:translateX(-50%) translateY(10px);background:var(--surface);border:1px solid var(--accent);color:var(--accent);font-size:0.65rem;letter-spacing:2px;text-transform:uppercase;padding:12px 20px;opacity:0;transition:opacity 0.25s,transform 0.25s;pointer-events:none;z-index:200;white-space:nowrap;border-radius:2px;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* TRASH TALK OVERLAY */
.trash-overlay{position:fixed;inset:0;background:rgba(10,10,11,0.97);z-index:500;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 28px;opacity:0;pointer-events:none;transition:opacity 0.3s;}
.trash-overlay.show{opacity:1;pointer-events:all;}
.trash-overlay.hide{opacity:0;}
.trash-emoji{font-size:3.5rem;margin-bottom:20px;animation:trashBounce 0.5s ease-out;}
@keyframes trashBounce{0%{transform:scale(0.5)}70%{transform:scale(1.15)}100%{transform:scale(1)}}
.trash-msg{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:var(--text);text-align:center;line-height:1.5;max-width:400px;margin-bottom:20px;}
.trash-msg.red{color:var(--red);}
.trash-msg.green{color:var(--green);}
.trash-msg.accent{color:var(--accent);}
.trash-sub{font-size:0.65rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);text-align:center;}
.trash-tap{position:absolute;bottom:calc(var(--nav-h) + var(--safe-bottom) + 32px);font-size:0.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}

/* CALENDAR CATEGORY DOTS */
.cal-cat-dots{display:flex;gap:2px;flex-wrap:wrap;margin-top:2px;}
.cal-cat-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}

/* YEAR VIEW */
.year-toggle{display:flex;gap:8px;margin-bottom:16px;}
.year-tab{flex:1;text-align:center;font-size:0.58rem;letter-spacing:1px;text-transform:uppercase;padding:8px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;border-radius:2px;font-family:'Space Mono',monospace;}
.year-tab.active{border-color:var(--accent);color:var(--accent);}
.year-full-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0;margin-bottom:16px;border:1px solid rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;}
.year-month-block{overflow:hidden;border-right:1px solid rgba(255,255,255,0.06);border-bottom:1px solid rgba(255,255,255,0.06);}
.year-month-block:nth-child(3n){border-right:none;}
.year-month-block:nth-last-child(-n+3){border-bottom:none;}
.year-month-header{background:transparent;color:var(--muted);text-align:center;font-size:0.46rem;font-weight:600;letter-spacing:0.5px;text-transform:uppercase;padding:3px 2px;border-bottom:1px solid rgba(255,255,255,0.06);}
.year-wd-row{display:grid;grid-template-columns:repeat(7,1fr);background:rgba(255,255,255,0.04);}
.year-wd{font-size:0.32rem;text-align:center;color:var(--muted);padding:1px 0;}
.year-day-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;padding:1px;background:rgba(255,255,255,0.04);}
.year-cell{aspect-ratio:1;border-radius:0;cursor:pointer;transition:opacity 0.15s;}
.year-cell:active{opacity:0.4;}
.year-cell.empty{background:transparent;cursor:default;pointer-events:none;}
.year-cell.unlogged{background:rgba(255,255,255,0.05);}
.year-cell.met{background:var(--green);opacity:0.9;}
.year-cell.missed{background:var(--red);opacity:0.9;}
.year-cell.today{outline:1.5px solid var(--accent);outline-offset:-1px;z-index:1;position:relative;}
.year-legend{display:flex;gap:12px;margin-bottom:12px;font-size:0.58rem;color:var(--muted);align-items:center;flex-wrap:wrap;}
.year-legend-cell{width:10px;height:10px;border-radius:1px;flex-shrink:0;}
.year-selector{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:12px;}
.year-arrow{background:none;border:1px solid var(--border);color:var(--text);width:28px;height:28px;border-radius:2px;cursor:pointer;font-size:0.9rem;}
.year-year-label{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:var(--text);min-width:60px;text-align:center;}

/* HOME PAGE */
.home-date{font-size:0.46rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);opacity:0.5;margin-bottom:16px;}
.home-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:16px 14px;}
.home-card.accent-border{border-color:var(--accent);}
.home-card.red-border{border-color:rgba(248,113,113,0.5);}
.home-card-label{font-size:0.48rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.home-card-val{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;color:var(--text);line-height:1;}
.home-card-val.green{color:var(--green);}
.home-card-val.red{color:var(--red);}
.home-card-val.accent{color:var(--accent);}
.home-card-val.streak-active{color:var(--green);animation:streakNumPulse 2s ease-in-out infinite;}
@keyframes streakNumPulse{0%,100%{text-shadow:0 0 0 rgba(74,222,128,0);}50%{text-shadow:0 0 16px rgba(74,222,128,0.7);}}
.streak-flame{display:inline-block;animation:flameDance 1.2s ease-in-out infinite alternate;}
@keyframes flameDance{0%{transform:scale(1) rotate(-3deg);}100%{transform:scale(1.15) rotate(3deg);}}
.home-card-sub{font-size:0.52rem;color:var(--muted);margin-top:5px;}
.home-section{margin-bottom:16px;}
.home-section-title{font-size:0.5rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;border-bottom:1px solid var(--border);padding-bottom:6px;}
/* Would've been */
.wouldve-gap{font-family:'Playfair Display',serif;font-size:2.6rem;font-weight:700;color:var(--red);line-height:1;}
/* Callout */
.callout-card{background:var(--surface);border:1px solid rgba(248,113,113,0.35);border-radius:4px;padding:16px 14px;opacity:0;transform:translateY(12px);transition:opacity 0.4s ease,transform 0.4s ease;}
.callout-card.visible{opacity:1;transform:translateY(0);}
.callout-skull{font-size:1.1rem;margin-bottom:8px;display:block;}
.callout-text{font-size:0.72rem;color:var(--text);line-height:1.7;font-family:'Space Mono',monospace;}
.callout-stat{font-size:0.58rem;color:var(--red);margin-top:6px;letter-spacing:1px;}
/* Animations */
@keyframes hitRatePulse{0%{box-shadow:0 0 0 0 rgba(248,113,113,0.5);}60%{box-shadow:0 0 0 10px rgba(248,113,113,0);}100%{box-shadow:0 0 0 0 rgba(248,113,113,0);}}
.hit-rate-pulse{animation:hitRatePulse 0.7s ease-out forwards;}
@keyframes streakShake{0%,100%{transform:translateX(0);}20%{transform:translateX(-6px);}40%{transform:translateX(6px);}60%{transform:translateX(-4px);}80%{transform:translateX(4px);}}
.streak-shake{animation:streakShake 0.5s ease-out forwards;}
/* Home top grid */
.home-top-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
/* Monthly history cards */
.month-history-card{background:var(--surface);border-left:3px solid var(--border);border-radius:0 4px 4px 0;padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:12px;}
.month-history-card.border-green{border-left-color:var(--green);}
.month-history-card.border-yellow{border-left-color:var(--accent);}
.month-history-card.border-red{border-left-color:var(--red);}
.month-history-name{font-family:'Playfair Display',serif;font-size:0.9rem;font-weight:700;color:var(--text);min-width:80px;}
.month-history-rate{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;line-height:1;}
.month-history-verdict{font-size:0.5rem;letter-spacing:1px;text-transform:uppercase;margin-top:3px;}
.month-history-meta{font-size:0.52rem;color:var(--muted);margin-left:auto;text-align:right;line-height:1.8;}
.month-mini-chart{display:flex;align-items:flex-end;gap:2px;height:28px;margin-top:6px;}
.month-mini-bar{width:4px;border-radius:1px 1px 0 0;min-height:3px;}
/* Counter animation */
.counting{transition:none;}
/* Days since last hit â€” hero row */
.home-hero-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:8px;}
.home-hero-side{display:flex;flex-direction:column;align-items:center;gap:2px;min-width:64px;}
.home-hero-side-label{font-size:0.44rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.home-hero-side-val{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;line-height:1;}
.home-hero-side-sub{font-size:0.52rem;color:var(--accent);font-weight:600;font-family:'Space Mono',monospace;}
/* Week form squares */
.week-form{display:flex;gap:4px;margin-top:4px;align-items:center;}
.week-form-w{font-size:0.6rem;font-weight:700;color:var(--green);font-family:'Space Mono',monospace;}
.week-form-l{font-size:0.6rem;font-weight:700;color:var(--red);font-family:'Space Mono',monospace;}
/* Days since â€” big center */
.days-since-wrap{flex:1;display:flex;flex-direction:column;align-items:center;position:relative;}
.days-since-num{font-family:'Playfair Display',serif;font-size:4.5rem;font-weight:900;line-height:1;position:relative;z-index:1;}
.days-since-label{font-size:0.46rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:2px;}
/* Days since â€” number pulses big */
@keyframes daysPulse{0%{transform:scale(1);text-shadow:0 0 0 rgba(248,113,113,0);}40%{transform:scale(1.18);text-shadow:0 0 28px rgba(248,113,113,0.7);}70%{transform:scale(1.06);text-shadow:0 0 14px rgba(248,113,113,0.4);}100%{transform:scale(1);text-shadow:0 0 0 rgba(248,113,113,0);}}
.days-since-num.pulse{animation:daysPulse 1.1s ease-out forwards;}
/* Greeting â€” left, compact */
.home-greeting{font-size:1.15rem;font-weight:700;color:var(--text);margin-bottom:2px;font-family:'Playfair Display',serif;letter-spacing:-0.3px;}
.home-date{font-size:0.46rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);opacity:0.5;margin-bottom:16px;}

/* MIGRATION BANNER */
.migration-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:300;align-items:center;justify-content:center;padding:20px;}
.migration-overlay.open{display:flex;}
.migration-box{background:var(--surface);border:1px solid var(--accent);border-radius:4px;padding:28px 24px;max-width:420px;width:100%;}
.migration-box h2{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--accent);margin-bottom:12px;}
.migration-box p{font-size:0.68rem;color:var(--muted);line-height:1.8;margin-bottom:16px;}
.migration-box ul{font-size:0.65rem;color:var(--text);line-height:2;margin-left:16px;margin-bottom:20px;}

.lang-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);}
.lang-row:last-child{border-bottom:none;}
.lang-row-label{font-size:0.6rem;letter-spacing:1px;text-transform:uppercase;color:var(--text);}
.lang-row-desc{font-size:0.5rem;color:var(--muted);margin-top:2px;}
.lang-pills{display:flex;gap:4px;}
.lang-pill{font-size:0.48rem;letter-spacing:1px;text-transform:uppercase;padding:5px 10px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;border-radius:2px;font-family:'Space Mono',monospace;}
.lang-pill.active{border-color:var(--accent);color:var(--accent);background:rgba(212,175,55,0.08);}

@media(min-width:600px){
  .page{padding:28px 32px;}
  .stats-grid{grid-template-columns:repeat(3,1fr);}
  .cal-day{min-height:72px;}
  .badges-grid{grid-template-columns:repeat(4,1fr);}
}
</style>
</head>
<body>

<!-- UNLOCK SCREEN -->
<div class="unlock-screen" id="unlockScreen" style="display:none">
  <div class="unlock-logo">ðŸŽ¨</div>
  <div class="unlock-title" id="unlockAppTitle">Art Hours</div>
  <div class="unlock-sub">Daily Practice Logger</div>
  <div class="unlock-field">
    <label>Passphrase</label>
    <input class="unlock-input" type="password" id="unlockPass"
      placeholder="Enter passphrase"
      onkeydown="if(event.key==='Enter')unlockApp()"
      autocomplete="current-password">
  </div>
  <button class="unlock-btn" onclick="unlockApp()">Unlock &amp; Sync</button>
  <div class="unlock-err" id="unlockErr"></div>
  <div class="unlock-syncing" id="unlockSyncing">âŸ³ Connecting to Sheetâ€¦</div>
  <div class="unlock-skip" onclick="unlockSkip()">Skip sync â€” use local data only</div>
</div>

<!-- MIGRATION PROMPT -->
<div class="migration-overlay" id="migrationOverlay">
  <div class="migration-box">
    <h2>ðŸŽ¨ Art Hours v2</h2>
    <p>Welcome to the updated Art Hours! We've added sessions and categories so you can track <em>what</em> you practice, not just how long.</p>
    <ul>
      <li>All existing entries migrated to <strong>General</strong> category</li>
      <li>Log form now supports multiple sessions per day</li>
      <li>New Settings tab for targets &amp; categories</li>
      <li>Pie chart showing time per category</li>
    </ul>
    <button class="btn primary full" onclick="confirmMigration()">Got it â€” let's go!</button>
  </div>
</div>

<div class="header">
  <div class="header-left">
    <h1 id="appTitle">Art Hours</h1>
    <div class="subtitle" id="dateRange"></div>
  </div>
  <div class="header-right">
    <div class="level-badge" id="levelBadge" onclick="showPage('analysis')">LVL 1</div>
    <div class="sync-pill nosync" id="syncPill" onclick="showPage('settings')">â—‹ no sync</div>
  </div>
</div>

<div class="install-banner" id="installBanner">
  <div class="install-banner-text"><strong>Add to Home Screen</strong>Install Art Hours for quick access &amp; offline use</div>
  <button class="install-btn" onclick="triggerInstall()">Install</button>
  <button class="install-dismiss" onclick="dismissInstall()">âœ•</button>
</div>
<div class="ios-hint" id="iosHint">
  <p>To install: tap <strong>Share â†‘</strong> then <strong>"Add to Home Screen"</strong></p>
</div>

<!-- PAGE: HOME -->
<div class="page active" id="page-home">
  <!-- Greeting â€” left aligned, muted, small -->
  <div class="home-greeting" id="homeGreeting"></div>
  <div class="home-date" id="homeDate"></div>

  <!-- Hero row: streak | days since | week form -->
  <div class="home-hero-row">
    <!-- Left: streak -->
    <div class="home-hero-side" id="hStreakCard">
      <div class="home-hero-side-label" id="hStreakLabel">Streak</div>
      <div class="home-hero-side-val accent" id="hStreak">0</div>
      <div class="home-hero-side-sub" id="hStreakSub">days</div>
    </div>

    <!-- Center: days since last hit -->
    <div class="days-since-wrap">
      <div class="days-since-num" id="hDaysSince">0</div>
      <div class="days-since-label">days since last hit</div>
    </div>

    <!-- Right: week form -->
    <div class="home-hero-side" style="align-items:flex-end">
      <div class="home-hero-side-label">Last 7</div>
      <div class="week-form" id="hWeekForm"></div>
      <div class="home-hero-side-sub" id="hWeekStat"></div>
    </div>
  </div>

  <!-- Would've Been -->
  <div class="home-section">
    <div class="home-section-title">Would've Been</div>
    <div class="home-card" style="display:flex;gap:16px;align-items:center">
      <div style="flex:1">
        <div class="home-card-label">Hours lost to missed days</div>
        <div class="wouldve-gap" id="hWouldveGap">0h</div>
        <div class="home-card-sub" id="hWouldveSub">behind your ideal self</div>
        <div style="font-size:0.46rem;color:var(--muted);margin-top:5px" id="hWouldfeDays"></div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div class="home-card-label">Logged</div>
        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:var(--green)" id="hWouldveActual">0h</div>
        <div class="home-card-label" style="margin-top:6px">Ideal</div>
        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:var(--muted)" id="hWouldveIdeal">0h</div>
      </div>
    </div>
  </div>

  <!-- Verdict -->
  <div class="home-section">
    <div class="home-section-title">Verdict</div>
    <div class="callout-card" id="calloutCard">
      <span class="callout-skull">ðŸ’€</span>
      <div class="callout-text" id="calloutText"></div>
      <div class="callout-stat" id="calloutStat"></div>
    </div>
  </div>

  <!-- Track Record -->
  <div class="home-section">
    <div class="home-section-title">Track Record</div>
    <div id="monthHistoryList"></div>
  </div>
</div>

<!-- PAGE: CALENDAR -->
<div class="page" id="page-calendar">
  <div class="year-toggle">
    <button class="year-tab active" id="cal-tab-month" onclick="switchCalView('month')">Monthly</button>
    <button class="year-tab" id="cal-tab-year" onclick="switchCalView('year')">Year View</button>
  </div>
  <div id="cal-monthly-view">
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>Met</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div>Missed</div>
      <span style="font-size:0.55rem;color:var(--muted)">Tap any day to log / edit</span>
    </div>
    <div class="calendar-grid" id="calendar"></div>
  </div>
  <div id="cal-year-view" style="display:none">
    <div class="year-selector">
      <button class="year-arrow" onclick="shiftYear(-1)">&#8249;</button>
      <span class="year-year-label" id="yearLabel">2026</span>
      <button class="year-arrow" onclick="shiftYear(1)">&#8250;</button>
    </div>
    <div class="year-legend">
      <div class="year-legend-cell" style="background:var(--green);opacity:0.85"></div><span>Met</span>
      <div class="year-legend-cell" style="background:var(--red);opacity:0.85"></div><span>Missed</span>
      <div class="year-legend-cell" style="background:var(--surface2)"></div><span>Unlogged</span>
      <div class="year-legend-cell" style="outline:1.5px solid var(--accent);outline-offset:-1px"></div><span>Today</span>
    </div>
    <div class="year-full-grid" id="yearGrid"></div>
  </div>
</div>

<!-- PAGE: ANALYSIS (chart + deep insights) -->
<div class="page" id="page-analysis">

  <!-- ANALYSIS SUB-TABS -->
  <div class="chart-tabs" style="margin-bottom:16px">
    <button class="chart-tab active" id="atab-overview" onclick="switchAnalysis('overview')">Overview</button>
    <button class="chart-tab" id="atab-chart" onclick="switchAnalysis('chart')">Chart</button>
    <button class="chart-tab" id="atab-skills" onclick="switchAnalysis('skills')">Skills</button>
    <button class="chart-tab" id="atab-patterns" onclick="switchAnalysis('patterns')">Patterns</button>
  </div>

  <!-- OVERVIEW TAB -->
  <div id="analysis-overview">
    <div class="section-title">Your Level</div>
    <div id="levelCard"></div>
    <div class="section-title">Badges</div>
    <div class="badges-grid" id="badgesGrid"></div>
    <div class="section-title">Progress</div>
    <div id="progressBars"></div>
    <div class="section-title">Stats</div>
    <div class="stats-grid" id="stats"></div>
    <div class="section-title">Streak Comparison</div>
    <div id="streakCompare"></div>
    <div class="section-title">Monthly Summary</div>
    <div class="monthly-cards" id="monthlyCards"></div>
  </div>

  <!-- CHART TAB -->
  <div id="analysis-chart" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <div class="chart-tabs" style="margin-bottom:0;flex:1;margin-right:10px">
        <button class="chart-tab active" id="tab-daily" onclick="switchChart('daily')">Daily</button>
        <button class="chart-tab" id="tab-cumulative" onclick="switchChart('cumulative')">Cumulative</button>
      </div>
      <div id="chartZoomBtns" style="display:flex;gap:3px">
        <button class="lang-pill active" id="zoom-7"  onclick="setChartZoom(7)">7d</button>
        <button class="lang-pill"        id="zoom-30" onclick="setChartZoom(30)">30d</button>
        <button class="lang-pill"        id="zoom-all" onclick="setChartZoom(0)">All</button>
      </div>
    </div>
    <div id="chart-daily-wrap">
      <div class="chart-scroll">
        <div class="chart-wrap"><div class="chart-inner" id="chart"></div></div>
      </div>
      <p style="font-size:0.6rem;color:var(--muted);text-align:center;margin-top:8px;">Tap any bar Â· scroll to pan Â· Green = met Â· Red = missed</p>
    </div>
    <div id="chart-cumulative-wrap" style="display:none">
      <div class="chart-scroll">
        <div class="chart-wrap"><div class="cum-chart" id="cumChart"></div></div>
      </div>
      <p style="font-size:0.6rem;color:var(--muted);text-align:center;margin-top:8px;">Total hours accumulated over time</p>
    </div>
    <!-- Monthly history section -->
    <div id="monthHistorySection" style="margin-top:24px">
      <div class="section-title">Monthly History</div>
      <div id="chartMonthHistory"></div>
    </div>
  </div>

  <!-- SKILLS TAB -->
  <div id="analysis-skills" style="display:none">
    <div class="section-title">Category Breakdown</div>
    <div class="pie-section" id="pieSection"></div>
    <div class="section-title">Skill Split Over Time</div>
    <div id="skillSplitChart"></div>
  </div>

  <!-- PATTERNS TAB -->
  <div id="analysis-patterns" style="display:none">
    <div class="section-title">Best &amp; Worst Days</div>
    <div id="dayPatternCard"></div>
    <div class="section-title">Time of Month</div>
    <div id="monthPatternCard"></div>
  </div>

</div>

<!-- PAGE: SETTINGS -->
<div class="page" id="page-settings">

  <!-- TARGETS -->
  <div class="settings-section">
    <div class="section-title">Daily Targets</div>
    <p style="font-size:0.62rem;color:var(--muted);margin-bottom:14px;line-height:1.7;">Set your target hours per day. Weekly and monthly targets auto-calculate.</p>

    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <div style="flex:1">
        <div style="font-size:0.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;">Weekday default</div>
        <input type="number" id="targetWeekday" min="0" max="24" step="0.5" value="5" inputmode="decimal" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:1rem;padding:12px;outline:none;border-radius:2px;-webkit-appearance:none;" onchange="applyWeekdayDefault()">
      </div>
      <div style="flex:1">
        <div style="font-size:0.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;">Weekend default</div>
        <input type="number" id="targetWeekend" min="0" max="24" step="0.5" value="12" inputmode="decimal" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:1rem;padding:12px;outline:none;border-radius:2px;-webkit-appearance:none;" onchange="applyWeekendDefault()">
      </div>
    </div>

    <div style="font-size:0.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Override per day</div>
    <div class="target-grid" id="targetGrid"></div>

    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:2px;padding:12px;font-size:0.62rem;color:var(--muted);line-height:1.8;margin-top:8px;" id="targetSummary"></div>
  </div>

  <!-- CATEGORIES -->
  <div class="settings-section">
    <div class="section-title">Categories</div>
    <p style="font-size:0.62rem;color:var(--muted);margin-bottom:14px;line-height:1.7;">Organise your sessions. Tap a category to manage subcategories. One category is the default for quick logging.</p>
    <div class="cat-list" id="catList"></div>
    <button class="btn full" style="margin-bottom:8px;" onclick="openAddCatSheet()">ï¼‹ Add Category</button>
  </div>

  <!-- LANGUAGE -->
  <div class="settings-section">
    <div class="section-title">Language</div>
    <p style="font-size:0.62rem;color:var(--muted);margin-bottom:14px;line-height:1.7;">Control the language for each part of the app independently. Mixed = 50/50 per message.</p>
    <div id="langToggles"></div>
  </div>

  <!-- BACKUP & SYNC -->
  <div class="settings-section">
    <div class="section-title">Backup &amp; Sync</div>

    <div style="font-size:0.44rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Export</div>
    <div class="backup-row" onclick="exportJSON()">
      <div class="backup-row-icon">â†“</div>
      <div class="backup-row-text">
        <div class="backup-row-title">Download JSON <span style="font-size:0.44rem;color:var(--green);letter-spacing:1px;text-transform:uppercase;margin-left:6px;">Recommended</span></div>
        <div class="backup-row-desc">Full lossless backup â€” sessions, categories, everything. Import back into this app.</div>
      </div>
    </div>
    <div class="backup-row" onclick="exportCSV()">
      <div class="backup-row-icon">â†“</div>
      <div class="backup-row-text">
        <div class="backup-row-title">Download CSV</div>
        <div class="backup-row-desc">Open in Google Sheets or Excel. Use for viewing data, not as primary backup.</div>
      </div>
    </div>

    <div style="font-size:0.44rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;margin-top:16px;">Import</div>
    <div class="backup-row" onclick="openImportSheet()">
      <div class="backup-row-icon">â†‘</div>
      <div class="backup-row-text">
        <div class="backup-row-title">Restore from File</div>
        <div class="backup-row-desc">Accepts JSON (full restore) or CSV. Drag &amp; drop also supported.</div>
      </div>
    </div>
    <input type="file" id="importFile" accept=".json,.csv,text/csv,text/plain,application/json,*/*" style="display:none" onchange="importFile(event)">

    <div style="font-size:0.44rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;margin-top:16px;">Sync</div>
    <div class="backup-row" onclick="openSheetSheet()">
      <div class="backup-row-icon">âŸ³</div>
      <div class="backup-row-text"><div class="backup-row-title">Google Sheets Sync</div><div class="backup-row-desc">Connect to a live Google Sheet â€” auto-syncs on open</div></div>
    </div>
  </div>

</div>

<button class="fab" id="fabBtn" onclick="openLogSheet()" title="Log today">ï¼‹</button>

<!-- PAGE: TIMER -->
<div class="page" id="page-timer">
  <div class="timer-tabs">
    <button class="timer-tab active" id="ttab-pomodoro" onclick="switchTimerMode('pomodoro')">Pomodoro</button>
    <button class="timer-tab" id="ttab-stopwatch" onclick="switchTimerMode('stopwatch')">Stopwatch</button>
    <button class="timer-tab" id="ttab-countdown" onclick="switchTimerMode('countdown')">Countdown</button>
  </div>

  <!-- POMODORO -->
  <div id="timer-pomodoro">
    <div class="pomo-cycles" id="pomoCycles"></div>
    <div class="ring-wrap">
      <svg class="ring-svg" width="220" height="220" viewBox="0 0 220 220">
        <circle class="ring-bg" cx="110" cy="110" r="96"/>
        <circle class="ring-fill" id="pomoRing" cx="110" cy="110" r="96"
          stroke="var(--accent)" stroke-dasharray="603" stroke-dashoffset="0"/>
      </svg>
      <div class="ring-center">
        <div class="ring-time" id="pomoTime">25:00</div>
        <div class="ring-label" id="pomoLabel">Focus</div>
        <div class="ring-phase" id="pomoPhase" style="color:var(--accent)">Cycle 1</div>
      </div>
    </div>
    <div class="timer-stat-row">
      <div class="timer-stat"><div class="timer-stat-val" id="pomoWorkTotal">0:00</div><div class="timer-stat-label">Work Time</div></div>
      <div class="timer-stat"><div class="timer-stat-val" id="pomoSessions">0</div><div class="timer-stat-label">Pomodoros</div></div>
    </div>
    <div class="timer-controls">
      <button class="timer-btn" onclick="pomoReset()" title="Reset">â†º</button>
      <button class="timer-btn primary" id="pomoPlayBtn" onclick="pomoToggle()">â–¶</button>
      <button class="timer-btn" onclick="pomoSkip()" title="Skip">â­</button>
    </div>
    <div class="pomo-settings">
      <div class="pomo-settings-title">Pomodoro Settings</div>
      <div class="pomo-settings-grid">
        <div class="pomo-setting-cell">
          <div class="pomo-setting-label">Work (min)</div>
          <input class="pomo-setting-input" type="number" id="pomoWorkMin" min="1" max="120" value="25" inputmode="numeric" onchange="pomoApplySettings()">
        </div>
        <div class="pomo-setting-cell">
          <div class="pomo-setting-label">Short Break (min)</div>
          <input class="pomo-setting-input" type="number" id="pomoBreakMin" min="1" max="60" value="5" inputmode="numeric" onchange="pomoApplySettings()">
        </div>
        <div class="pomo-setting-cell">
          <div class="pomo-setting-label">Long Break (min)</div>
          <input class="pomo-setting-input" type="number" id="pomoLongMin" min="1" max="120" value="15" inputmode="numeric" onchange="pomoApplySettings()">
        </div>
        <div class="pomo-setting-cell">
          <div class="pomo-setting-label">Cycles before long</div>
          <input class="pomo-setting-input" type="number" id="pomoCycleCount" min="1" max="10" value="4" inputmode="numeric" onchange="pomoApplySettings()">
        </div>
      </div>
    </div>
    <button class="btn full" onclick="pomoLogSession()" id="pomoLogBtn" style="display:none">Log Session â†’</button>
  </div>

  <!-- STOPWATCH -->
  <div id="timer-stopwatch" style="display:none">
    <div class="ring-wrap">
      <svg class="ring-svg" width="220" height="220" viewBox="0 0 220 220">
        <circle class="ring-bg" cx="110" cy="110" r="96"/>
        <circle class="ring-fill" id="swRing" cx="110" cy="110" r="96"
          stroke="var(--green)" stroke-dasharray="603" stroke-dashoffset="603"/>
      </svg>
      <div class="ring-center">
        <div class="ring-time" id="swTime">0:00:00</div>
        <div class="ring-label">Elapsed</div>
      </div>
    </div>
    <div class="timer-controls">
      <button class="timer-btn" onclick="swReset()" title="Reset">â†º</button>
      <button class="timer-btn primary" id="swPlayBtn" onclick="swToggle()">â–¶</button>
      <button class="timer-btn" onclick="swLap()" title="Lap" id="swLapBtn" style="opacity:0.3">â—Ž</button>
    </div>
    <div id="swLapsList" class="laps-list" style="margin-bottom:20px;"></div>
    <button class="btn full" onclick="swLogSession()" id="swLogBtn" style="display:none">Log Session â†’</button>
  </div>

  <!-- COUNTDOWN -->
  <div id="timer-countdown" style="display:none">
    <div class="countdown-inputs" id="cdInputs">
      <div class="countdown-unit">
        <input class="countdown-input" type="number" id="cdHours" min="0" max="23" value="0" placeholder="0" inputmode="numeric">
        <div class="countdown-unit-label">Hours</div>
      </div>
      <div class="countdown-sep">:</div>
      <div class="countdown-unit">
        <input class="countdown-input" type="number" id="cdMins" min="0" max="59" value="25" placeholder="25" inputmode="numeric">
        <div class="countdown-unit-label">Minutes</div>
      </div>
    </div>
    <div class="ring-wrap" id="cdRingWrap" style="display:none">
      <svg class="ring-svg" width="220" height="220" viewBox="0 0 220 220">
        <circle class="ring-bg" cx="110" cy="110" r="96"/>
        <circle class="ring-fill" id="cdRing" cx="110" cy="110" r="96"
          stroke="var(--accent)" stroke-dasharray="603" stroke-dashoffset="0"/>
      </svg>
      <div class="ring-center">
        <div class="ring-time" id="cdTime">25:00</div>
        <div class="ring-label">Remaining</div>
      </div>
    </div>
    <div class="timer-stat-row" id="cdStatRow" style="display:none">
      <div class="timer-stat"><div class="timer-stat-val" id="cdElapsed">0:00</div><div class="timer-stat-label">Elapsed</div></div>
      <div class="timer-stat"><div class="timer-stat-val" id="cdTarget">25:00</div><div class="timer-stat-label">Target</div></div>
    </div>
    <div class="timer-controls">
      <button class="timer-btn" onclick="cdReset()" title="Reset">â†º</button>
      <button class="timer-btn primary" id="cdPlayBtn" onclick="cdToggle()">â–¶</button>
      <button class="timer-btn" style="opacity:0.3;cursor:default"></button>
    </div>
    <button class="btn full" onclick="cdLogSession()" id="cdLogBtn" style="display:none">Log Session â†’</button>
  </div>
</div>

<nav class="bottom-nav">
  <button class="nav-item active" id="nav-home" onclick="showPage('home')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    Home
  </button>
  <button class="nav-item" id="nav-calendar" onclick="showPage('calendar')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Calendar
  </button>
  <button class="nav-item" id="nav-analysis" onclick="showPage('analysis')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
    Analysis
  </button>
  <button class="nav-item" id="nav-timer" onclick="showPage('timer')">
    <div class="nav-dot" id="timerNavDot"></div>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/><line x1="12" y1="3" x2="12" y2="1"/><line x1="18.5" y1="5.5" x2="19.9" y2="4.1"/></svg>
    Timer
  </button>
  <button class="nav-item" id="nav-settings" onclick="showPage('settings')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l-.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    Settings
  </button>
</nav>

<!-- LOG SHEET -->
<div class="sheet-overlay" id="logOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h2 id="logTitle">Log Entry</h2>
    <div class="field"><label>Date</label><input type="date" id="inputDate" onchange="onDateChange()"></div>
    <div class="field"><label>Target Hours</label><input type="number" id="inputTarget" min="0" max="24" step="0.25" inputmode="decimal" placeholder="e.g. 5"></div>
    <div style="font-size:0.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;">Sessions</div>
    <div class="sessions-list" id="sessionsList"></div>
    <div class="session-total">Total: <span id="sessionTotal">0</span>h</div>
    <button class="add-session-btn" onclick="addSession()">ï¼‹ Add Session</button>
    <div class="sheet-actions">
      <button class="btn primary" style="flex:1" onclick="saveEntry()">Save</button>
      <button class="btn" onclick="closeLogSheet()">Cancel</button>
      <button class="btn danger" id="deleteBtn" onclick="deleteEntry()" style="display:none">Delete</button>
    </div>
  </div>
</div>

<!-- GOOGLE SHEETS SHEET -->
<div class="sheet-overlay" id="sheetOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h2>Google Sheets Sync</h2>
    <div style="font-size:0.62rem;color:var(--muted);line-height:1.8;margin-bottom:16px;background:var(--surface2);padding:14px;border-radius:2px;border:1px solid var(--border)">
      <strong style="color:var(--accent);display:block;margin-bottom:6px">Auto-sync is ON once URL is saved</strong>
      Syncs automatically on open and after every entry saved or deleted.
    </div>
    <div class="field"><label>Web App URL</label><input type="url" id="sheetUrl" placeholder="https://script.google.com/macros/s/..."></div>
    <div class="sheet-actions" style="flex-direction:column;gap:8px;">
      <button class="btn full" style="border-color:var(--muted);color:var(--muted);font-size:0.55rem" onclick="testConnection()">â–¶ Test Connection</button>
      <button class="btn primary full" onclick="gsheetSync(false)">âŸ³ Sync Now</button>
      <button class="btn full" onclick="gsheetLoad()">â†“ Load from Sheet</button>
      <button class="btn full" onclick="gsheetBackup()">â†‘ Full Backup to Sheet</button>
      <button class="btn danger full" onclick="clearSheetUrl()">âœ• Disconnect</button>
      <button class="btn full" onclick="closeSheetSheet()">Close</button>
    </div>
    <div class="sheet-status" id="sheetStatus"></div>
  </div>
</div>

<!-- IMPORT SHEET -->
<div class="sheet-overlay" id="importOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h2>Restore from File</h2>

    <!-- Drag & drop zone -->
    <div id="dropZone" onclick="document.getElementById('importFile').click()"
      style="border:2px dashed var(--border);border-radius:4px;padding:24px 16px;text-align:center;cursor:pointer;margin-bottom:16px;transition:border-color 0.2s,background 0.2s;"
      ondragover="event.preventDefault();this.style.borderColor='var(--accent)';this.style.background='rgba(212,175,55,0.06)'"
      ondragleave="this.style.borderColor='var(--border)';this.style.background=''"
      ondrop="handleFileDrop(event)">
      <div style="font-size:1.4rem;margin-bottom:8px">ðŸ“</div>
      <div style="font-size:0.65rem;color:var(--text);font-weight:600;margin-bottom:4px">Tap to browse or drag &amp; drop</div>
      <div style="font-size:0.52rem;color:var(--muted)">Accepts .json or .csv</div>
    </div>

    <!-- Sheets URL import -->
    <div style="margin-bottom:14px">
      <div style="font-size:0.44rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px">Import from Google Sheets URL</div>
      <div style="font-size:0.55rem;color:var(--muted);line-height:1.7;margin-bottom:8px">Paste your Sheet's published CSV URL. <span style="color:var(--accent)">Sheet â†’ File â†’ Share â†’ Publish to web â†’ CSV</span></div>
      <div style="display:flex;gap:6px">
        <input type="url" id="sheetsImportUrl" placeholder="https://docs.google.com/spreadsheets/d/..." 
          style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.6rem;padding:10px;outline:none;border-radius:2px;min-width:0">
        <button class="btn primary" onclick="importFromSheetsUrl()" style="flex-shrink:0;white-space:nowrap;font-size:0.55rem;padding:10px 14px">Fetch</button>
      </div>
      <div id="sheetsUrlStatus" style="font-size:0.58rem;margin-top:6px;min-height:16px;"></div>
    </div>

    <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
      <div style="flex:1;height:1px;background:var(--border)"></div>
      <div style="font-size:0.48rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase">or paste / upload file</div>
      <div style="flex:1;height:1px;background:var(--border)"></div>
    </div>

    <textarea id="csvPasteArea" placeholder="Paste JSON or CSV here..." style="width:100%;height:90px;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:0.65rem;padding:12px;outline:none;resize:none;border-radius:2px;line-height:1.6;margin-bottom:12px;box-sizing:border-box;"></textarea>
    <div class="sheet-actions" style="flex-direction:column;gap:8px;">
      <button class="btn primary full" onclick="importFromPaste()">â†‘ Import</button>
      <button class="btn full" onclick="closeImportSheet()">Cancel</button>
    </div>
    <div id="importStatus" style="font-size:0.65rem;margin-top:12px;min-height:18px;text-align:center;"></div>
  </div>
</div>

<!-- ADD / EDIT CATEGORY SHEET -->
<div class="sheet-overlay" id="catSheet">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h2 id="catSheetTitle">Add Category</h2>
    <div class="field"><label>Name</label><input type="text" id="catName" placeholder="e.g. Figure Drawing"></div>
    <div class="field">
      <label>Color</label>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;"><div style="display:flex;gap:6px;flex-wrap:wrap;flex:1;" id="colorPicker"></div><input type="color" id="customColorInput" value="#4ade80" oninput="selectColor(this.value)" title="Custom colour" style="width:36px;height:36px;border-radius:4px;border:2px solid var(--border);background:none;cursor:pointer;padding:2px;flex-shrink:0;"></div>
    </div>
    <div class="field" id="subcatField">
      <label>Subcategories</label>
      <div id="subcatEditList" style="display:flex;flex-direction:column;gap:6px;margin-bottom:8px;"></div>
      <div style="display:flex;gap:8px;">
        <input type="text" id="newSubcatInput" placeholder="Add subcategory..." style="flex:1">
        <button class="btn" onclick="addSubcatInEditor()" style="padding:10px 14px;">ï¼‹</button>
      </div>
    </div>
    <div class="sheet-actions" style="flex-direction:column;gap:8px;">
      <button class="btn primary full" onclick="saveCat()">Save Category</button>
      <button class="btn danger full" id="deleteCatBtn" onclick="deleteCat()" style="display:none">Delete Category</button>
      <button class="btn full" onclick="closeCatSheet()">Cancel</button>
    </div>
  </div>
</div>

<!-- BADGE DETAIL SHEET -->
<div class="sheet-overlay" id="badgeOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div style="text-align:center;padding:10px 0 20px">
      <div id="badgeDetailIcon" style="font-size:4rem;margin-bottom:12px;"></div>
      <div id="badgeDetailName" style="font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--accent);margin-bottom:8px;"></div>
      <div id="badgeDetailDesc" style="font-size:0.7rem;color:var(--muted);line-height:1.7;"></div>
      <div id="badgeDetailStatus" style="margin-top:14px;font-size:0.65rem;"></div>
    </div>
    <button class="btn full" onclick="closeBadgeSheet()">Close</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- TRASH TALK OVERLAY -->
<div class="trash-overlay" id="trashOverlay"
  onmousedown="trashHold()" onmouseup="trashRelease()"
  ontouchstart="trashHold(event)" ontouchend="trashRelease()" ontouchcancel="trashRelease()">
  <div class="trash-emoji" id="trashEmoji">ðŸ’€</div>
  <div class="trash-msg" id="trashMsg"></div>
  <div class="trash-sub" id="trashSub"></div>
  <div class="trash-tap">hold to read Â· release to dismiss</div>
</div>

<script src="./config.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & DEFAULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ APPLY THEME FROM CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
  const r=document.documentElement.style;
  const t=CFG_THEME;
  if(t.bg)      r.setProperty('--bg',      t.bg);
  if(t.surface) r.setProperty('--surface', t.surface);
  if(t.surface2)r.setProperty('--surface2',t.surface2);
  if(t.border)  r.setProperty('--border',  t.border);
  if(t.green)   r.setProperty('--green',   t.green);
  if(t.red)     r.setProperty('--red',     t.red);
  if(t.accent)  r.setProperty('--accent',  t.accent);
  if(t.text)    r.setProperty('--text',    t.text);
  if(t.muted)   r.setProperty('--muted',   t.muted);
})();

// â”€â”€ CONFIG ALIASES â”€â”€ (values come from config.js)
// Set app name from config
document.addEventListener('DOMContentLoaded',()=>{const t=document.getElementById('appTitle');if(t)t.textContent=CFG_APP_NAME;document.title=CFG_APP_NAME;});
const STORAGE_KEY    = CFG_KEYS.data;
const SHEET_URL_KEY  = CFG_KEYS.sheetUrl;
const CATS_KEY       = CFG_KEYS.cats;
const TARGETS_KEY    = CFG_KEYS.targets;
const MIGRATED_KEY   = CFG_KEYS.migrated;
const DAYS           = CFG_DAYS;
const MONTHS         = CFG_MONTHS;
const CAT_COLORS     = CFG_CAT_COLORS;
const DEFAULT_CATS   = CFG_DEFAULT_CATS;
const DEFAULT_TARGETS= CFG_DEFAULT_TARGETS;

const SEED = CFG_SEED;

const LEVELS = CFG_LEVELS;

const BADGE_DEFS = CFG_BADGES;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toISO(dt){return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;}
function toDDMMYYYY(s){const dt=new Date(s+'T00:00:00');return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`;}
function dayName(dateStr){return DAYS[new Date(dateStr+'T00:00:00').getDay()];}
function uid(){return Math.random().toString(36).slice(2,9);}

function normalize(e){
  const dt=new Date(e.date+'T00:00:00');
  const hours = e.sessions ? e.sessions.reduce((s,x)=>s+(+x.hours),0) : (+e.hours||0);
  const sessions = e.sessions || [{category:'General',subcategory:'',hours:+e.hours||0}];
  return {date:e.date, day:DAYS[dt.getDay()], hours, target:+e.target, sessions,
          result: hours >= +e.target ? 'ðŸŸ¢' : 'ðŸ”´'};
}

// â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORAGE_KEY_MIRROR = STORAGE_KEY + '_mirror';

function loadData(){
  // Try primary key first
  try{
    const r=localStorage.getItem(STORAGE_KEY);
    if(r){
      const parsed=JSON.parse(r);
      if(Array.isArray(parsed)&&parsed.length) return parsed;
    }
  }catch(e){}
  // Primary missing or empty â€” try mirror
  try{
    const r=localStorage.getItem(STORAGE_KEY_MIRROR);
    if(r){
      const parsed=JSON.parse(r);
      if(Array.isArray(parsed)&&parsed.length){
        console.warn('[Storage] Primary key missing â€” recovered from mirror');
        // Restore primary from mirror immediately
        try{localStorage.setItem(STORAGE_KEY,r);}catch(e){}
        return parsed;
      }
    }
  }catch(e){}
  return [];
}

function saveData(){
  const serialised=JSON.stringify(data);
  localStorage.setItem(STORAGE_KEY, serialised);
  // Mirror â€” independent copy in a separate key
  try{localStorage.setItem(STORAGE_KEY_MIRROR, serialised);}catch(e){}
}

function loadCats(){
  try{const r=localStorage.getItem(CATS_KEY);if(r)return JSON.parse(r);}catch(e){}
  localStorage.setItem(CATS_KEY,JSON.stringify(DEFAULT_CATS));return JSON.parse(JSON.stringify(DEFAULT_CATS));
}
function saveCats(){localStorage.setItem(CATS_KEY,JSON.stringify(categories));}

function loadTargets(){
  try{const r=localStorage.getItem(TARGETS_KEY);if(r)return JSON.parse(r);}catch(e){}
  localStorage.setItem(TARGETS_KEY,JSON.stringify(DEFAULT_TARGETS));return {...DEFAULT_TARGETS};
}
function saveTargets(){localStorage.setItem(TARGETS_KEY,JSON.stringify(targets));}

function getDefaultTarget(dateStr){
  const d=dayName(dateStr);
  return targets[d] || 5;
}

function getDefaultCat(){
  return categories.find(c=>c.isDefault)||categories[0]||{name:'General',subcategories:[]};
}

// â”€â”€ MIGRATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function migrateOldData(){
  // Check if old v1 data exists and new v2 hasn't been set up
  const oldRaw = localStorage.getItem('art_hours_v1');
  const alreadyMigrated = localStorage.getItem(MIGRATED_KEY);
  if(alreadyMigrated||!oldRaw) return false;

  try{
    const oldData = JSON.parse(oldRaw);
    // Migrate each entry â€” wrap hours in a General session
    const migrated = oldData.map(e=>normalize({
      ...e,
      sessions:[{category:'General',subcategory:'',hours:+e.hours||0}]
    }));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
    return true; // needs prompt
  }catch(e){return false;}
}

function confirmMigration(){
  localStorage.setItem(MIGRATED_KEY,'1');
  document.getElementById('migrationOverlay').classList.remove('open');
  showToast('Welcome to Art Hours v2 ðŸŽ¨');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let data        = loadData();
let categories  = loadCats();
let targets     = loadTargets();
let currentPage = 'home';
let currentChart= 'daily';
let pieMode     = 'alltime'; // 'alltime' | 'month'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function computeStats(){
  const sorted=[...data].sort((a,b)=>a.date.localeCompare(b.date));
  const total=sorted.reduce((s,d)=>s+d.hours,0);
  const green=sorted.filter(d=>d.result==='ðŸŸ¢').length;
  const red=sorted.filter(d=>d.result==='ðŸ”´').length;

  let best=0,cur=0;
  for(const d of sorted){if(d.result==='ðŸŸ¢'){cur++;best=Math.max(best,cur);}else cur=0;}
  let current=0;
  for(let i=sorted.length-1;i>=0;i--){if(sorted[i].result==='ðŸŸ¢')current++;else break;}

  let debt=0;
  sorted.forEach(d=>{debt-=(d.hours-d.target);if(debt<0)debt=0;});

  const hasDoubled=sorted.some(d=>d.hours>=d.target*2&&d.target>0);

  let hasComeback=false;
  for(let i=1;i<sorted.length;i++){
    const gap=(new Date(sorted[i].date+'T00:00:00')-new Date(sorted[i-1].date+'T00:00:00'))/(864e5);
    if(gap>=7){hasComeback=true;break;}
  }

  const now=new Date();
  const dow=now.getDay();
  const monday=new Date(now);
  monday.setDate(now.getDate()-(dow===0?6:dow-1));monday.setHours(0,0,0,0);
  const sunday=new Date(monday);sunday.setDate(monday.getDate()+6);
  const weekEntries=sorted.filter(d=>{const dt=new Date(d.date+'T00:00:00');return dt>=monday&&dt<=sunday;});
  const weekHours=weekEntries.reduce((s,d)=>s+d.hours,0);
  const weekTarget=weekEntries.reduce((s,d)=>s+d.target,0)||35;

  const monthStr=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const monthEntries=sorted.filter(d=>d.date.startsWith(monthStr));
  const monthHours=monthEntries.reduce((s,d)=>s+d.hours,0);
  const daysInMonth=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
  const avgTarget=sorted.length?sorted.reduce((s,d)=>s+d.target,0)/sorted.length:5;
  const monthTarget=avgTarget*daysInMonth;

  const pct=sorted.length?Math.round(green/sorted.length*100):0;

  return{total,green,red,best,current,debt,hasDoubled,hasComeback,
         weekHours,weekTarget,monthHours,monthTarget,pct,
         avg:sorted.length?total/sorted.length:0};
}

// â”€â”€ CATEGORY HOURS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeCatHours(entries){
  const map={};
  entries.forEach(e=>{
    (e.sessions||[]).forEach(s=>{
      const k=s.category||'General';
      map[k]=(map[k]||0)+(+s.hours||0);
    });
  });
  return map;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEVEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getLevel(total){return LEVELS.findLast(l=>total>=l.min)||LEVELS[0];}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SERVICE WORKER / PWA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js').then(reg=>{
      navigator.serviceWorker.addEventListener('message',e=>{
        if(e.data&&e.data.type==='SYNC_SUCCESS'){setSyncPill('synced','âœ“ synced');showToast('Auto-synced âœ“');}
      });
    }).catch(()=>{});
  });
}
let deferredInstallPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();deferredInstallPrompt=e;
  if(!localStorage.getItem('install_dismissed'))document.getElementById('installBanner').classList.add('show');
});
window.addEventListener('appinstalled',()=>{document.getElementById('installBanner').classList.remove('show');showToast('App installed âœ“');deferredInstallPrompt=null;});
function triggerInstall(){if(!deferredInstallPrompt)return;deferredInstallPrompt.prompt();deferredInstallPrompt.userChoice.then(()=>{deferredInstallPrompt=null;document.getElementById('installBanner').classList.remove('show');});}
function dismissInstall(){document.getElementById('installBanner').classList.remove('show');localStorage.setItem('install_dismissed','1');}
function isIOS(){return /iphone|ipad|ipod/i.test(navigator.userAgent)&&!window.MSStream;}
function isInStandaloneMode(){return window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone;}
if(isIOS()&&!isInStandaloneMode()&&!localStorage.getItem('ios_hint_dismissed')){
  document.getElementById('iosHint').classList.add('show');
  setTimeout(()=>{document.getElementById('iosHint').classList.remove('show');localStorage.setItem('ios_hint_dismissed','1');},8000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load',()=>{
  // Pre-fill Sheet URL from config if not already saved
  if(CFG_SHEET_URL && !localStorage.getItem(SHEET_URL_KEY)){
    localStorage.setItem(SHEET_URL_KEY, CFG_SHEET_URL);
  }
  // If encryption is enabled and unlock screen is visible, do NOT auto-sync here.
  // autoSync will be called by unlockApp() after successful decryption.
  const unlockVisible = CFG_USE_ENCRYPTION && CFG_ENCRYPTED_URL &&
    !sessionStorage.getItem('art_hours_session_url');
  if(unlockVisible){
    setSyncPill('nosync','â—‹ unlock to sync');
    return;
  }
  const url=localStorage.getItem(SHEET_URL_KEY);
  if(url&&navigator.onLine){setSyncPill('syncing','âŸ³ syncingâ€¦');setTimeout(()=>autoSync(url),1200);}
  else if(url&&!navigator.onLine)setSyncPill('offline','âœ• offline');
  else setSyncPill('nosync','â—‹ no sync');
});
window.addEventListener('online',()=>{const u=localStorage.getItem(SHEET_URL_KEY);if(u){setSyncPill('syncing','âŸ³ syncingâ€¦');autoSync(u);}});
window.addEventListener('offline',()=>setSyncPill('offline','âœ• offline'));

function sanitiseForSync(entries){
  return entries.map(e=>({
    date:e.date, day:e.day, hours:e.hours, target:e.target,
    result:e.result==='ðŸŸ¢'?'Met':'Missed',
    categories:(e.sessions||[]).map(s=>`${s.category}${s.subcategory?'/'+s.subcategory:''}:${s.hours}h`).join(', ')
  }));
}

async function sheetFetch(url,payload){
  if(payload.data)payload={...payload,data:sanitiseForSync(payload.data)};
  if(payload.data&&payload.data.length>20)return await sheetFetchChunked(url,payload);
  const encoded=encodeURIComponent(JSON.stringify(payload));
  const res=await fetch(`${url}?payload=${encoded}`,{method:'GET',redirect:'follow'});
  const text=await res.text();
  if(text.trim().startsWith('<'))throw new Error('Script returned HTML â€” check deployment');
  try{return JSON.parse(text);}catch(e){throw new Error('Bad response: '+text.slice(0,100));}
}

async function sheetFetchChunked(url,payload){
  const CHUNK=20;const chunks=[];
  for(let i=0;i<payload.data.length;i+=CHUNK)chunks.push(payload.data.slice(i,i+CHUNK));
  let totalAppended=0,totalUpdated=0;
  for(const chunk of chunks){
    const p={...payload,data:chunk};
    const encoded=encodeURIComponent(JSON.stringify(p));
    const res=await fetch(`${url}?payload=${encoded}`,{method:'GET',redirect:'follow'});
    const text=await res.text();
    if(text.trim().startsWith('<'))throw new Error('Script returned HTML');
    const json=JSON.parse(text);if(json.error)throw new Error(json.error);
    totalAppended+=json.appended||0;totalUpdated+=json.updated||0;
  }
  return{status:'ok',synced:payload.data.length,appended:totalAppended,updated:totalUpdated};
}

async function testConnection(){
  const url=getSheetUrl();if(!url)return;
  setSheetStatus('Testingâ€¦','var(--muted)');
  try{
    const encoded=encodeURIComponent(JSON.stringify({action:'load'}));
    const res=await fetch(`${url}?payload=${encoded}`,{method:'GET',redirect:'follow'});
    const text=await res.text();
    if(text.trim().startsWith('<')){setSheetStatus('âœ— Got HTML â€” check deployment','var(--red)');return;}
    const json=JSON.parse(text);
    if(json.error){setSheetStatus(`âœ— ${json.error}`,'var(--red)');return;}
    setSheetStatus(`âœ“ Connected! ${json.data?json.data.length:0} entries. Now tap Sync.`,'var(--green)');
  }catch(e){setSheetStatus(`âœ— ${e.message}`,'var(--red)');}
}

async function autoSync(url){
  try{
    // â”€â”€ STEP 1: Pull settings from Sheet first â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Sheet is source of truth for settings across devices.
    // But only apply if Sheet version is newer than local.
    const setJson=await sheetFetch(url,{action:'loadSettings'});
    const sheetSettingsTime = setJson.savedAt ? +new Date(setJson.savedAt) : 0;
    const localSettingsTime = +(localStorage.getItem('art_hours_settings_saved')||0);

    if(setJson.categories&&setJson.categories.length&&sheetSettingsTime>=localSettingsTime){
      categories=setJson.categories;
      localStorage.setItem(CATS_KEY,JSON.stringify(categories));
    }
    if(setJson.targets&&Object.keys(setJson.targets).length&&sheetSettingsTime>=localSettingsTime){
      targets=setJson.targets;
      localStorage.setItem(TARGETS_KEY,JSON.stringify(targets));
    }

    // â”€â”€ STEP 2: Push current local settings to Sheet â”€â”€â”€â”€â”€â”€â”€â”€
    // This ensures Sheet always has the latest local state.
    await sheetFetch(url,{action:'saveSettings',categories,targets});
    localStorage.setItem('art_hours_settings_saved',Date.now());

    // â”€â”€ STEP 3: Push entries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const pushJson=await sheetFetch(url,{action:'sync',data});
    if(pushJson.error)throw new Error(pushJson.error);

    // â”€â”€ STEP 4: Pull entries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const pullJson=await sheetFetch(url,{action:'load'});
    if(pullJson.data&&pullJson.data.length){
      pullJson.data.forEach(imp=>{
        const idx=data.findIndex(d=>d.date===imp.date);
        const entry=normalize(imp);
        if(idx>=0)data[idx]=entry;else data.push(entry);
      });
      saveData();
    }

    render();
    setSyncPill('synced','âœ“ synced');
    localStorage.setItem('art_hours_last_synced',Date.now());
    if('serviceWorker' in navigator&&'SyncManager' in window){
      const reg=await navigator.serviceWorker.ready;
      await queuePendingSync(url);
      await reg.sync.register('sync-sheets');
    }
  }catch(e){setSyncPill('offline','âœ• sync failed');}
}

async function queuePendingSync(url){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open('art-hours-sw',1);
    req.onupgradeneeded=e=>e.target.result.createObjectStore('pending',{autoIncrement:true});
    req.onsuccess=e=>{
      const db=e.target.result;const tx=db.transaction('pending','readwrite');
      const store=tx.objectStore('pending');store.clear();store.add({url,data});
      tx.oncomplete=resolve;tx.onerror=reject;
    };
    req.onerror=reject;
  });
}

// Push settings to Sheet silently (fire and forget)
async function pushSettingsToSheet(){
  const url=localStorage.getItem(SHEET_URL_KEY);
  if(!url||!navigator.onLine)return;
  try{
    await sheetFetch(url,{action:'saveSettings',categories,targets});
    localStorage.setItem('art_hours_settings_saved',Date.now());
  }catch(e){}
}

function setSyncPill(state,label){const p=document.getElementById('syncPill');p.className=`sync-pill ${state}`;p.textContent=label;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentAnalysisTab = 'overview';

function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  const navEl=document.getElementById('nav-'+name);
  if(navEl)navEl.classList.add('active');
  currentPage=name;
  if(name==='home')renderHome();
  if(name==='analysis'){renderAnalysisTab(currentAnalysisTab);}
  if(name==='settings')renderSettings();
  if(name==='timer')pomoRenderAll();
  window.scrollTo(0,0);
}

function switchAnalysis(tab){
  currentAnalysisTab=tab;
  ['overview','chart','skills','patterns'].forEach(t=>{
    document.getElementById('atab-'+t).classList.toggle('active',t===tab);
    document.getElementById('analysis-'+t).style.display=t===tab?'block':'none';
  });
  renderAnalysisTab(tab);
}

function renderAnalysisTab(tab){
  if(tab==='overview'){
    const s=computeStats();
    renderLevelCard(s);renderBadges(s);renderProgressBars(s);
    renderStats(s);renderStreakCompare(s);renderMonthlyCards();
  }
  if(tab==='chart'){
    if(currentChart==='daily')renderChart();else renderCumulativeChart();
  }
  if(tab==='skills'){
    renderPieChart();renderSkillSplit();
  }
  if(tab==='patterns'){
    renderDayPatterns();renderMonthPatterns();
  }
}

function switchChart(type){
  currentChart=type;
  document.getElementById('tab-daily').classList.toggle('active',type==='daily');
  document.getElementById('tab-cumulative').classList.toggle('active',type==='cumulative');
  document.getElementById('chart-daily-wrap').style.display=type==='daily'?'block':'none';
  document.getElementById('chart-cumulative-wrap').style.display=type==='cumulative'?'block':'none';
  if(type==='daily')renderChart();else renderCumulativeChart();
  const zoomBtns=document.getElementById('chartZoomBtns');
  if(zoomBtns) zoomBtns.style.display=type==='daily'?'flex':'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MASTER RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  data.sort((a,b)=>a.date.localeCompare(b.date));
  const s=computeStats();
  renderCalendar();
  if(currentPage==='home')renderHome();
  if(currentPage==='analysis')renderAnalysisTab(currentAnalysisTab);
  if(currentPage==='settings')renderSettings();
  if(data.length)document.getElementById('dateRange').textContent=`${toDDMMYYYY(data[0].date)} â†’ ${toDDMMYYYY(data[data.length-1].date)}`;
  const lv=getLevel(s.total);
  document.getElementById('levelBadge').textContent=`LVL ${lv.level} Â· ${lv.name}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: LEVEL CARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLevelCard(s){
  const lv=getLevel(s.total);
  const next=LEVELS.find(l=>l.level===lv.level+1);
  const pct=next?Math.min(100,Math.round((s.total-lv.min)/(next.min-lv.min)*100)):100;
  document.getElementById('levelCard').innerHTML=`
    <div class="level-card" style="margin-bottom:24px">
      <div class="level-num">Level ${lv.level}</div>
      <div class="level-name">${lv.name}</div>
      <div class="level-progress-bg"><div class="level-progress-fill" style="width:${pct}%"></div></div>
      <div class="level-progress-meta">
        <span>${s.total.toFixed(1)}h total</span>
        <span>${next?`${next.min}h to Level ${next.level}`:'Max Level! ðŸ‘‘'}</span>
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: BADGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBadges(s){
  document.getElementById('badgesGrid').innerHTML=BADGE_DEFS.map(b=>{
    const earned=b.check(s);
    return `<div class="badge ${earned?'earned':''}" onclick="openBadgeSheet('${b.id}')">
      <span class="badge-icon">${b.icon}</span>
      <div class="badge-name">${b.name}</div>
    </div>`;
  }).join('');
}

function openBadgeSheet(id){
  const b=BADGE_DEFS.find(x=>x.id===id);if(!b)return;
  const s=computeStats();const earned=b.check(s);
  document.getElementById('badgeDetailIcon').textContent=b.icon;
  document.getElementById('badgeDetailName').textContent=b.name;
  document.getElementById('badgeDetailDesc').textContent=b.desc;
  document.getElementById('badgeDetailStatus').innerHTML=earned
    ?`<span style="color:var(--green)">âœ“ Earned!</span>`
    :`<span style="color:var(--muted)">Not yet earned</span>`;
  document.getElementById('badgeOverlay').classList.add('open');
}
function closeBadgeSheet(){document.getElementById('badgeOverlay').classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: PROGRESS BARS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderProgressBars(s){
  const weekPct=Math.min(100,s.weekTarget>0?Math.round(s.weekHours/s.weekTarget*100):0);
  const monthPct=Math.min(100,s.monthTarget>0?Math.round(s.monthHours/s.monthTarget*100):0);
  document.getElementById('progressBars').innerHTML=`
    <div class="progress-wrap">
      <div class="progress-title">This Week</div>
      <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${weekPct}%;background:${weekPct>=100?'var(--green)':'var(--accent)'}"></div></div>
      <div class="progress-meta"><span>${s.weekHours.toFixed(1)}h done</span><span>${s.weekTarget.toFixed(1)}h target Â· ${weekPct}%</span></div>
    </div>
    <div class="progress-wrap">
      <div class="progress-title">This Month</div>
      <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${monthPct}%;background:${monthPct>=100?'var(--green)':'var(--accent)'}"></div></div>
      <div class="progress-meta"><span>${s.monthHours.toFixed(1)}h done</span><span>${s.monthTarget.toFixed(1)}h target Â· ${monthPct}%</span></div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: PIE CHART (SVG arc)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPieChart(){
  const now=new Date();
  const monthStr=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const entries=pieMode==='alltime'?data:data.filter(d=>d.date.startsWith(monthStr));
  const catHours=computeCatHours(entries);
  const total=Object.values(catHours).reduce((s,v)=>s+v,0);

  const toggleHtml=`
    <div class="pie-toggle">
      <button class="pie-tab ${pieMode==='alltime'?'active':''}" onclick="setPieMode('alltime')">All Time</button>
      <button class="pie-tab ${pieMode==='month'?'active':''}" onclick="setPieMode('month')">This Month</button>
    </div>`;

  if(!total||!Object.keys(catHours).length){
    document.getElementById('pieSection').innerHTML=toggleHtml+`<div class="pie-empty">No session data yet</div>`;
    return;
  }

  // Build pie slices
  const catColors={};
  categories.forEach(c=>{catColors[c.name]=c.color;});
  const fallbackColors=CAT_COLORS;
  let fi=0;
  const slices=Object.entries(catHours).sort((a,b)=>b[1]-a[1]).map(([name,hrs])=>{
    const color=catColors[name]||(fallbackColors[fi++%fallbackColors.length]);
    return{name,hrs,pct:hrs/total,color};
  });

  // SVG pie
  const R=70,CX=80,CY=80;
  let angle=-Math.PI/2;
  const paths=slices.map(s=>{
    if(s.pct>=1){
      // Full circle
      const d=`M ${CX} ${CY-R} A ${R} ${R} 0 1 1 ${CX-0.01} ${CY-R} Z`;
      return`<path d="${d}" fill="${s.color}" opacity="0.85"/>`;
    }
    const a1=angle, a2=angle+s.pct*2*Math.PI;
    const x1=CX+R*Math.cos(a1),y1=CY+R*Math.sin(a1);
    const x2=CX+R*Math.cos(a2),y2=CY+R*Math.sin(a2);
    const large=s.pct>0.5?1:0;
    const d=`M ${CX} ${CY} L ${x1.toFixed(2)} ${y1.toFixed(2)} A ${R} ${R} 0 ${large} 1 ${x2.toFixed(2)} ${y2.toFixed(2)} Z`;
    angle=a2;
    return`<path d="${d}" fill="${s.color}" opacity="0.85"/>`;
  }).join('');

  const svg=`<svg viewBox="0 0 160 160" width="160" height="160" style="flex-shrink:0">
    ${paths}
    <circle cx="${CX}" cy="${CY}" r="34" fill="var(--bg)"/>
    <text x="${CX}" y="${CY-6}" text-anchor="middle" fill="var(--accent)" font-family="Playfair Display,serif" font-size="18" font-weight="700">${total.toFixed(0)}h</text>
    <text x="${CX}" y="${CY+10}" text-anchor="middle" fill="var(--muted)" font-family="Space Mono,monospace" font-size="7">TOTAL</text>
  </svg>`;

  const legend=slices.map(s=>`
    <div class="pie-legend-item">
      <div class="pie-legend-dot" style="background:${s.color}"></div>
      <div class="pie-legend-name">${s.name}</div>
      <div class="pie-legend-val">${s.hrs.toFixed(1)}h Â· ${Math.round(s.pct*100)}%</div>
    </div>`).join('');

  document.getElementById('pieSection').innerHTML=`
    ${toggleHtml}
    <div class="pie-wrap">
      ${svg}
      <div class="pie-legend">${legend}</div>
    </div>`;
}

function setPieMode(mode){pieMode=mode;renderPieChart();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats(s){
  document.getElementById('stats').innerHTML=`
    <div class="stat-card"><div class="stat-val">${s.total.toFixed(1)}h</div><div class="stat-label">Total Hours</div></div>
    <div class="stat-card"><div class="stat-val">${data.length}</div><div class="stat-label">Days Logged</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--green)">${s.green}</div><div class="stat-label">Days Met</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--red)">${s.red}</div><div class="stat-label">Days Missed</div></div>
    <div class="stat-card"><div class="stat-val">${s.pct}%</div><div class="stat-label">Success Rate</div></div>
    <div class="stat-card"><div class="stat-val">${s.avg.toFixed(1)}h</div><div class="stat-label">Daily Avg</div></div>
    <div class="stat-card" style="grid-column:1/-1;border-color:${s.debt<=0?'var(--green)':'var(--red)'};background:${s.debt<=0?'rgba(74,222,128,0.06)':'rgba(248,113,113,0.06)'}">
      <div class="stat-val" style="color:${s.debt<=0?'var(--green)':'var(--red)'};font-size:2.4rem">${s.debt<=0?'0.0':s.debt.toFixed(1)}h</div>
      <div class="stat-label" style="color:${s.debt<=0?'var(--green)':'var(--red)'}">ðŸŽ¨ Art Debt${s.debt<=0?' â€” Debt Free! ðŸŽ‰':' â€” exceeding target reduces debt'}</div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: STREAK COMPARE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStreakCompare(s){
  const max=Math.max(s.best,s.current,1);
  const bestH=Math.round((s.best/max)*100);
  const curH=Math.round((s.current/max)*100);
  const curColor=s.current>=s.best?'var(--green)':'var(--accent)';
  document.getElementById('streakCompare').innerHTML=`
    <div class="streak-compare">
      <div class="streak-compare-title">Streak Comparison</div>
      <div class="streak-bars">
        <div class="streak-bar-wrap">
          <div class="streak-bar-val">${s.best}</div>
          <div class="streak-bar" style="height:${bestH}%;background:var(--muted);opacity:0.6"></div>
          <div class="streak-bar-label">Best Ever</div>
        </div>
        <div class="streak-bar-wrap">
          <div class="streak-bar-val" style="color:${curColor}">${s.current}</div>
          <div class="streak-bar" style="height:${curH}%;background:${curColor}"></div>
          <div class="streak-bar-label">Current</div>
        </div>
      </div>
      ${s.current>=s.best&&s.current>0?`<div style="font-size:0.65rem;color:var(--green);text-align:center;margin-top:8px">ðŸ† New record streak!</div>`
        :s.best>0?`<div style="font-size:0.6rem;color:var(--muted);text-align:center;margin-top:8px">${s.best-s.current} more day${s.best-s.current!==1?'s':''} to beat your record</div>`:''}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: MONTHLY CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMonthlyCards(){
  const months={};
  data.forEach(d=>{
    const dt=new Date(d.date+'T00:00:00');
    const key=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    if(!months[key])months[key]={year:dt.getFullYear(),month:dt.getMonth(),entries:[]};
    months[key].entries.push(d);
  });
  document.getElementById('monthlyCards').innerHTML=Object.keys(months).sort().reverse().map(key=>{
    const m=months[key];
    const total=m.entries.reduce((s,d)=>s+d.hours,0);
    const met=m.entries.filter(d=>d.result==='ðŸŸ¢').length;
    const missed=m.entries.filter(d=>d.result==='ðŸ”´').length;
    let best=0,cur=0;
    [...m.entries].sort((a,b)=>a.date.localeCompare(b.date)).forEach(d=>{
      if(d.result==='ðŸŸ¢'){cur++;best=Math.max(best,cur);}else cur=0;
    });
    const maxH=Math.max(...m.entries.map(d=>d.hours),1);
    const miniBars=m.entries.sort((a,b)=>a.date.localeCompare(b.date)).map(d=>`
      <div class="month-mini-bar" style="height:${Math.max(3,Math.round(d.hours/maxH*28))}px;background:${d.result==='ðŸŸ¢'?'var(--green)':'var(--red)'}"></div>`).join('');
    return`<div class="month-card">
      <div class="month-card-header">
        <div class="month-card-name">${MONTHS[m.month]} ${m.year}</div>
        <div class="month-card-total">${total.toFixed(1)}h total</div>
      </div>
      <div class="month-card-stats">
        <div class="month-stat"><div class="month-stat-val" style="color:var(--green)">${met}</div><div class="month-stat-label">Met</div></div>
        <div class="month-stat"><div class="month-stat-val" style="color:var(--red)">${missed}</div><div class="month-stat-label">Missed</div></div>
        <div class="month-stat"><div class="month-stat-val">${best}</div><div class="month-stat-label">Best Streak</div></div>
      </div>
      <div class="month-mini-chart">${miniBars}</div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: DAILY CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _chartZoom=7; // default 7 days

function setChartZoom(days){
  _chartZoom=days;
  // update button states
  ['7','30','all'].forEach(z=>{
    const btn=document.getElementById('zoom-'+z);
    if(btn) btn.className='lang-pill'+(( (z==='all'&&days===0)||(z!=='all'&&+z===days))?' active':'');
  });
  renderChart();
}

function renderChart(){
  const el=document.getElementById('chart');el.innerHTML='';
  if(!data.length)return;
  const sorted=[...data].sort((a,b)=>a.date.localeCompare(b.date));
  // Apply zoom window
  let visibleData=sorted;
  if(_chartZoom>0){
    const cutoff=new Date();cutoff.setDate(cutoff.getDate()-_chartZoom);cutoff.setHours(0,0,0,0);
    visibleData=sorted.filter(d=>new Date(d.date+'T00:00:00')>=cutoff);
    if(!visibleData.length) visibleData=sorted.slice(-_chartZoom);
  }
  const startDt=new Date(visibleData[0].date+'T00:00:00');
  const endDt=new Date(visibleData[visibleData.length-1].date+'T00:00:00');
  const dataMap={};sorted.forEach(d=>dataMap[d.date]=d);
  const allDays=[];
  for(let dt=new Date(startDt);dt<=endDt;dt.setDate(dt.getDate()+1)){
    const ds=toISO(dt);allDays.push({dateStr:ds,entry:dataMap[ds]||null});
  }
  const maxH=Math.max(...visibleData.map(d=>d.hours),1);

  const yAxis=document.createElement('div');
  yAxis.style.cssText='position:absolute;left:0;top:0;bottom:20px;width:28px;display:flex;flex-direction:column;justify-content:space-between;pointer-events:none;';
  [1,0.75,0.5,0.25,0].forEach(f=>{
    const lbl=document.createElement('span');
    lbl.style.cssText='font-size:7px;color:var(--muted);text-align:right;width:100%;padding-right:4px;line-height:1;';
    lbl.textContent=f===0?'0':`${Math.round(maxH*f)}h`;
    yAxis.appendChild(lbl);
  });
  el.appendChild(yAxis);

  const floatLabel=document.createElement('div');
  floatLabel.style.cssText='position:absolute;top:4px;left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--accent);color:var(--accent);font-size:0.6rem;padding:4px 10px;border-radius:2px;pointer-events:none;opacity:0;transition:opacity 0.15s;white-space:nowrap;z-index:10;';
  el.appendChild(floatLabel);
  let floatTimer=null;

  const bars=document.createElement('div');bars.className='bars';bars.style.paddingLeft='30px';
  allDays.forEach(({dateStr,entry})=>{
    const wrap=document.createElement('div');wrap.className='bar-wrap';
    const bar=document.createElement('div');bar.className='bar';
    const ddmm=toDDMMYYYY(dateStr).slice(0,5);
    if(entry){
      bar.style.height=`${(entry.hours/maxH)*100}%`;
      bar.style.background=entry.result==='ðŸŸ¢'?'var(--green)':'var(--red)';
      bar.style.opacity='0.85';
      bar.onclick=()=>{
        floatLabel.textContent=`${ddmm}  ${entry.hours}h / ${entry.target}h`;
        floatLabel.style.opacity='1';
        clearTimeout(floatTimer);
        floatTimer=setTimeout(()=>floatLabel.style.opacity='0',2000);
      };
    }else{
      bar.style.height='6px';bar.style.background='var(--border)';
    }
    const label=document.createElement('span');label.className='bar-label';label.textContent=ddmm;
    wrap.appendChild(bar);wrap.appendChild(label);bars.appendChild(wrap);
  });
  el.appendChild(bars);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: CUMULATIVE CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCumulativeChart(){
  const el=document.getElementById('cumChart');el.innerHTML='';
  if(!data.length)return;
  const sorted=[...data].sort((a,b)=>a.date.localeCompare(b.date));
  let running=0;
  const points=sorted.map(d=>{running+=d.hours;return{date:d.date,total:running};});
  const maxTotal=points[points.length-1].total;
  const W=Math.max(600,points.length*12);const H=180;const PAD=24;
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`);svg.style.width=`${W}px`;svg.style.height=`${H}px`;
  [0.25,0.5,0.75,1].forEach(f=>{
    const y=PAD+(H-PAD*2)*(1-f);
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1','0');line.setAttribute('x2',W);line.setAttribute('y1',y);line.setAttribute('y2',y);
    line.setAttribute('stroke','#2a2b2e');line.setAttribute('stroke-width','1');svg.appendChild(line);
    const text=document.createElementNS('http://www.w3.org/2000/svg','text');
    text.setAttribute('x','4');text.setAttribute('y',y-3);text.setAttribute('fill','#6b6a65');text.setAttribute('font-size','8');
    text.textContent=`${(maxTotal*f).toFixed(0)}h`;svg.appendChild(text);
  });
  const xStep=(W-PAD*2)/(points.length-1||1);
  const pathD=points.map((p,i)=>`${i===0?'M':'L'}${PAD+i*xStep},${PAD+(H-PAD*2)*(1-p.total/maxTotal)}`).join(' ');
  const firstX=PAD,lastX=PAD+(points.length-1)*xStep;
  const area=document.createElementNS('http://www.w3.org/2000/svg','path');
  area.setAttribute('d',`${pathD} L${lastX},${H-PAD} L${firstX},${H-PAD} Z`);
  area.setAttribute('fill','rgba(245,200,66,0.08)');svg.appendChild(area);
  const path=document.createElementNS('http://www.w3.org/2000/svg','path');
  path.setAttribute('d',pathD);path.setAttribute('fill','none');path.setAttribute('stroke','var(--accent)');path.setAttribute('stroke-width','2');svg.appendChild(path);
  points.forEach((p,i)=>{
    const dt=new Date(p.date+'T00:00:00');
    if(dt.getDate()===1||i===0||i===points.length-1){
      const x=PAD+i*xStep,y=PAD+(H-PAD*2)*(1-p.total/maxTotal);
      const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx',x);c.setAttribute('cy',y);c.setAttribute('r','3');c.setAttribute('fill','var(--accent)');svg.appendChild(c);
      if(dt.getDate()===1){
        const t=document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x',x);t.setAttribute('y',H-8);t.setAttribute('text-anchor','middle');
        t.setAttribute('fill','#6b6a65');t.setAttribute('font-size','7');
        t.textContent=MONTHS[dt.getMonth()].slice(0,3);svg.appendChild(t);
      }
    }
  });
  el.appendChild(svg);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getCatColor(name){
  const cat=categories.find(c=>c.name===name);
  return cat?cat.color:'#6b6a65';
}

function switchCalView(mode){
  document.getElementById('cal-tab-month').classList.toggle('active',mode==='month');
  document.getElementById('cal-tab-year').classList.toggle('active',mode==='year');
  document.getElementById('cal-monthly-view').style.display=mode==='month'?'block':'none';
  document.getElementById('cal-year-view').style.display=mode==='year'?'block':'none';
  if(mode==='year')renderYearView();
}

function getStreakDates(){
  // Returns a Set of date strings that are part of the CURRENT active green streak
  const sorted=[...data].sort((a,b)=>a.date.localeCompare(b.date));
  const streakDates=new Set();
  for(let i=sorted.length-1;i>=0;i--){
    if(sorted[i].result==='ðŸŸ¢') streakDates.add(sorted[i].date);
    else break;
  }
  return streakDates;
}

function getMissStreakDates(){
  // Returns a Set of date strings that are part of the CURRENT active miss streak (â‰¥2 consecutive reds)
  const sorted=[...data].sort((a,b)=>a.date.localeCompare(b.date));
  const missDates=new Set();
  for(let i=sorted.length-1;i>=0;i--){
    if(sorted[i].result==='ðŸ”´') missDates.add(sorted[i].date);
    else break;
  }
  return missDates;
}

function renderCalendar(){
  const calEl=document.getElementById('calendar');calEl.innerHTML='';
  const streakDates=getStreakDates();
  const missDates=getMissStreakDates();
  const months={};
  data.forEach(d=>{
    const dt=new Date(d.date+'T00:00:00');
    const key=`${dt.getFullYear()}-${String(dt.getMonth()).padStart(2,'0')}`;
    if(!months[key])months[key]={year:dt.getFullYear(),month:dt.getMonth(),days:{}};
    months[key].days[dt.getDate()]=d;
  });
  // Latest month first
  Object.keys(months).sort().reverse().forEach(key=>{
    const m=months[key];
    const block=document.createElement('div');
    const title=document.createElement('div');title.className='month-title';
    title.textContent=`${MONTHS[m.month]} ${m.year}`;block.appendChild(title);
    const wdRow=document.createElement('div');wdRow.className='week-days';
    DAYS.forEach(dn=>{const w=document.createElement('div');w.className='wd';w.textContent=dn.slice(0,1);wdRow.appendChild(w);});
    block.appendChild(wdRow);
    const grid=document.createElement('div');grid.className='cal-grid';
    const firstDay=new Date(m.year,m.month,1).getDay();
    for(let i=0;i<firstDay;i++){const e=document.createElement('div');e.className='cal-day empty';grid.appendChild(e);}
    const totalDays=new Date(m.year,m.month+1,0).getDate();
    for(let d=1;d<=totalDays;d++){
      const cell=document.createElement('div');
      const entry=m.days[d];
      const dateStr=`${m.year}-${String(m.month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      if(entry){
        const inStreak=streakDates.has(entry.date)&&streakDates.size>=2;
        const inMissStreak=missDates.has(entry.date)&&missDates.size>=2;
        const cls=inStreak?'streak-glow':inMissStreak?'miss-glow':(entry.result==='ðŸŸ¢'?'green':'red');
        cell.className=`cal-day ${cls}`;
        const uniqueCats=[...new Set((entry.sessions||[]).map(s=>s.category))];
        const dotsHtml=`<div class="cal-cat-dots">${uniqueCats.map(c=>`<div class="cal-cat-dot" style="background:${getCatColor(c)}" title="${c}"></div>`).join('')}</div>`;
        cell.innerHTML=`<div class="dot"></div><div class="cal-day-num">${d}</div><div class="cal-hours">${entry.hours}h</div><div class="cal-target">/${entry.target}h</div>${dotsHtml}`;
        cell.onclick=()=>openLogSheet(entry.date);
      }else{
        cell.className='cal-day';
        cell.innerHTML=`<div class="cal-day-num">${d}</div>`;
        cell.onclick=()=>openLogSheet(dateStr,true);
      }
      grid.appendChild(cell);
    }
    block.appendChild(grid);calEl.appendChild(block);
  });
}

let _yearViewYear = new Date().getFullYear();

function shiftYear(dir){
  _yearViewYear += dir;
  document.getElementById('yearLabel').textContent = _yearViewYear;
  renderYearView();
}

function renderYearView(){
  const el=document.getElementById('yearGrid');el.innerHTML='';
  document.getElementById('yearLabel').textContent = _yearViewYear;
  const dataMap={};data.forEach(d=>dataMap[d.date]=d);
  const now=new Date();
  const todayStr=now.toISOString().slice(0,10);
  const WD_LABELS=['S','M','T','W','T','F','S'];
  // All 12 months Janâ†’Dec in 3-col grid
  for(let mo=0;mo<12;mo++){
    const wrap=document.createElement('div');wrap.className='year-month-block';
    // Header
    const hdr=document.createElement('div');hdr.className='year-month-header';
    hdr.textContent=MONTHS[mo].slice(0,3);wrap.appendChild(hdr);
    // Weekday labels
    const wdRow=document.createElement('div');wdRow.className='year-wd-row';
    WD_LABELS.forEach(w=>{const d=document.createElement('div');d.className='year-wd';d.textContent=w;wdRow.appendChild(d);});
    wrap.appendChild(wdRow);
    // Day cells
    const grid=document.createElement('div');grid.className='year-day-grid';
    const firstDay=new Date(_yearViewYear,mo,1).getDay();
    for(let i=0;i<firstDay;i++){const e=document.createElement('div');e.className='year-cell empty';grid.appendChild(e);}
    const totalDays=new Date(_yearViewYear,mo+1,0).getDate();
    for(let d=1;d<=totalDays;d++){
      const dateStr=`${_yearViewYear}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const entry=dataMap[dateStr];
      const cell=document.createElement('div');
      const isToday=dateStr===todayStr;
      if(entry){
        cell.className=`year-cell ${entry.result==='ðŸŸ¢'?'met':'missed'}${isToday?' today':''}`;
        cell.title=`${dateStr}\n${entry.hours}h / ${entry.target}h`;
        cell.onclick=()=>openLogSheet(entry.date);
      }else{
        const dt=new Date(dateStr+'T00:00:00');
        if(dt<=now){
          cell.className=`year-cell unlogged${isToday?' today':''}`;
          cell.title=dateStr;
          cell.onclick=()=>openLogSheet(dateStr,true);
        }else{
          cell.className=`year-cell empty${isToday?' today':''}`;
        }
      }
      grid.appendChild(cell);
    }
    wrap.appendChild(grid);el.appendChild(wrap);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LANG_KEYS = {
  msgs:     'art_hours_lang_msgs',
  verdict:  'art_hours_lang_verdict',
  greeting: 'art_hours_lang_greeting',
};

function getLangPref(key){
  const saved = localStorage.getItem(LANG_KEYS[key]);
  if(saved) return saved;
  // fall back to config.js values
  if(key==='msgs')     return (typeof CFG_LANG_MSGS!=='undefined')?CFG_LANG_MSGS:'mixed';
  if(key==='verdict')  return (typeof CFG_LANG_VERDICT!=='undefined')?CFG_LANG_VERDICT:'mixed';
  if(key==='greeting') return (typeof CFG_LANG_GREETING!=='undefined')?CFG_LANG_GREETING:'mixed';
  return 'mixed';
}

function setLangPref(key, val){
  localStorage.setItem(LANG_KEYS[key], val);
  renderLangToggles();
  // Clear daily verdict cache so it regenerates with new language
  if(key==='verdict') localStorage.removeItem('art_hours_verdict');
}

function renderLangToggles(){
  const el=document.getElementById('langToggles');
  if(!el) return;
  const rows=[
    {key:'msgs',     label:'Trash Talk',  desc:'After logging a day'},
    {key:'verdict',  label:'Verdict',     desc:'Daily callout on Home'},
    {key:'greeting', label:'Greeting',    desc:'Opening line on Home'},
  ];
  el.innerHTML=rows.map(r=>{
    const cur=getLangPref(r.key);
    const pills=['english','mixed','telugu'].map(v=>`
      <button class="lang-pill${cur===v?' active':''}" onclick="setLangPref('${r.key}','${v}')">${v==='mixed'?'Mixed':v==='english'?'EN':'TE'}</button>`).join('');
    return`<div class="lang-row">
      <div><div class="lang-row-label">${r.label}</div><div class="lang-row-desc">${r.desc}</div></div>
      <div class="lang-pills">${pills}</div>
    </div>`;
  }).join('');
}

function renderSettings(){
  renderTargetGrid();
  renderTargetSummary();
  renderCatList();
  renderLangToggles();
}

function renderTargetGrid(){
  const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  document.getElementById('targetGrid').innerHTML=days.map(d=>`
    <div class="target-day-cell">
      <div class="target-day-label">${d}</div>
      <input class="target-day-input" type="number" min="0" max="24" step="0.5"
        value="${targets[d]||0}" inputmode="decimal"
        onchange="targets['${d}']=+this.value;saveTargets();localStorage.setItem('art_hours_settings_saved',Date.now());renderTargetSummary();pushSettingsToSheet()">
    </div>`).join('');
  // Set weekday/weekend display values
  const wdVals=[targets.Mon,targets.Tue,targets.Wed,targets.Thu,targets.Fri];
  const weVals=[targets.Sat,targets.Sun];
  const allWd=wdVals.every(v=>v===wdVals[0]);
  const allWe=weVals.every(v=>v===weVals[0]);
  if(allWd)document.getElementById('targetWeekday').value=wdVals[0];
  if(allWe)document.getElementById('targetWeekend').value=weVals[0];
}

function renderTargetSummary(){
  const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const weekTotal=days.reduce((s,d)=>s+(targets[d]||0),0);
  const now=new Date();
  const daysInMonth=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
  // Approximate monthly by day-of-week distribution
  let monthTotal=0;
  for(let d=1;d<=daysInMonth;d++){
    const dow=new Date(now.getFullYear(),now.getMonth(),d).getDay();
    const dayN=DAYS[dow];
    monthTotal+=(targets[dayN]||0);
  }
  document.getElementById('targetSummary').innerHTML=
    `Weekly target: <strong style="color:var(--accent)">${weekTotal}h</strong> &nbsp;Â·&nbsp; Monthly target: <strong style="color:var(--accent)">${monthTotal}h</strong>`;
}

function applyWeekdayDefault(){
  const val=+document.getElementById('targetWeekday').value;
  ['Mon','Tue','Wed','Thu','Fri'].forEach(d=>targets[d]=val);
  saveTargets();
  localStorage.setItem('art_hours_settings_saved',Date.now());
  renderTargetGrid();renderTargetSummary();
  showToast('Weekday targets updated');
  pushSettingsToSheet();
}

function applyWeekendDefault(){
  const val=+document.getElementById('targetWeekend').value;
  ['Sat','Sun'].forEach(d=>targets[d]=val);
  saveTargets();
  localStorage.setItem('art_hours_settings_saved',Date.now());
  renderTargetGrid();renderTargetSummary();
  showToast('Weekend targets updated');
  pushSettingsToSheet();
}

function renderCatList(){
  document.getElementById('catList').innerHTML=categories.map(cat=>`
    <div class="cat-item" id="catitem-${cat.id}">
      <div class="cat-item-header" onclick="toggleCatExpand('${cat.id}')">
        <div class="cat-color-dot" style="background:${cat.color}"></div>
        <div class="cat-item-name">${cat.name}</div>
        ${cat.isDefault?'<span class="cat-default-badge">Default</span>':''}
        <div class="cat-item-actions" onclick="event.stopPropagation()">
          ${!cat.isDefault?`<button class="cat-action-btn" title="Set as default" onclick="setCatDefault('${cat.id}')">â­</button>`:''}
          <button class="cat-action-btn" title="Edit" onclick="openEditCatSheet('${cat.id}')">âœï¸</button>
        </div>
      </div>
      <div class="cat-subcats" id="subcats-${cat.id}">
        ${cat.subcategories.length?cat.subcategories.map(s=>`
          <div class="cat-subcat-item">
            <span>â†³ ${s}</span>
          </div>`).join(''):'<div style="font-size:0.6rem;color:var(--muted)">No subcategories</div>'}
      </div>
    </div>`).join('');
}

function toggleCatExpand(id){
  const el=document.getElementById(`subcats-${id}`);
  el.classList.toggle('open');
}

function setCatDefault(id){
  categories.forEach(c=>c.isDefault=c.id===id);
  saveCats();
  localStorage.setItem('art_hours_settings_saved',Date.now());
  renderCatList();showToast('Default category updated');
  pushSettingsToSheet();
}

// â”€â”€ CATEGORY SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let editingCatId=null;
let editorSubcats=[];

const COLOR_OPTIONS=CFG_CAT_COLORS;

function buildColorPicker(selectedColor){
  const usedColors=categories
    .filter(c=>!editingCatId||c.id!==editingCatId)
    .map(c=>c.color.toLowerCase());
  document.getElementById('colorPicker').innerHTML=COLOR_OPTIONS.map(c=>{
    const used=usedColors.includes(c.toLowerCase())&&c.toLowerCase()!==selectedColor.toLowerCase();
    return`<div onclick="selectColor('${c}')" style="width:28px;height:28px;border-radius:4px;background:${c};cursor:pointer;border:2px solid ${c===selectedColor?'var(--text)':'transparent'};transition:border 0.15s;position:relative;opacity:${used?0.3:1};" id="cp-${c.replace('#','')}">
      ${used?`<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:10px;color:rgba(255,255,255,0.7)">âœ“</div>`:''}
    </div>`;
  }).join('');
  const inp=document.getElementById('customColorInput');
  if(inp){inp.value=selectedColor;}
}

let selectedCatColor=CAT_COLORS[0];
function selectColor(c){
  selectedCatColor=c;
  // Update swatch borders
  document.querySelectorAll('#colorPicker>div').forEach(el=>{
    el.style.border=`2px solid ${el.style.background===c?'var(--text)':'transparent'}`;
  });
  // Sync native colour input
  const inp=document.getElementById('customColorInput');
  if(inp) inp.value=c.length===7?c:selectedCatColor;
}

function openAddCatSheet(){
  editingCatId=null;editorSubcats=[];selectedCatColor=CAT_COLORS[0];
  document.getElementById('catSheetTitle').textContent='Add Category';
  document.getElementById('catName').value='';
  document.getElementById('deleteCatBtn').style.display='none';
  buildColorPicker(selectedCatColor);
  renderSubcatEditor();
  document.getElementById('catSheet').classList.add('open');
}

function openEditCatSheet(id){
  const cat=categories.find(c=>c.id===id);if(!cat)return;
  editingCatId=id;editorSubcats=[...cat.subcategories];selectedCatColor=cat.color;
  document.getElementById('catSheetTitle').textContent='Edit Category';
  document.getElementById('catName').value=cat.name;
  document.getElementById('deleteCatBtn').style.display=cat.isDefault?'none':'block';
  buildColorPicker(selectedCatColor);
  renderSubcatEditor();
  document.getElementById('catSheet').classList.add('open');
}

function closeCatSheet(){document.getElementById('catSheet').classList.remove('open');}

function renderSubcatEditor(){
  document.getElementById('subcatEditList').innerHTML=editorSubcats.map((s,i)=>`
    <div style="display:flex;align-items:center;justify-content:space-between;background:var(--surface2);border:1px solid var(--border);border-radius:2px;padding:8px 12px;">
      <span style="font-size:0.7rem">${s}</span>
      <button onclick="removeSubcatInEditor(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:0.9rem;">âœ•</button>
    </div>`).join('');
}

function addSubcatInEditor(){
  const val=document.getElementById('newSubcatInput').value.trim();
  if(!val)return;
  editorSubcats.push(val);
  document.getElementById('newSubcatInput').value='';
  renderSubcatEditor();
}

function removeSubcatInEditor(i){
  editorSubcats.splice(i,1);renderSubcatEditor();
}

function saveCat(){
  const name=document.getElementById('catName').value.trim();
  if(!name){showToast('Enter a name');return;}
  if(editingCatId){
    const cat=categories.find(c=>c.id===editingCatId);
    if(cat){cat.name=name;cat.color=selectedCatColor;cat.subcategories=editorSubcats;}
  }else{
    categories.push({id:uid(),name,color:selectedCatColor,subcategories:editorSubcats,isDefault:false});
  }
  saveCats();
  localStorage.setItem('art_hours_settings_saved',Date.now());
  renderCatList();closeCatSheet();
  showToast(editingCatId?'Category updated':'Category added');
  pushSettingsToSheet();
}

function deleteCat(){
  if(!editingCatId)return;
  const cat=categories.find(c=>c.id===editingCatId);
  if(cat&&cat.isDefault){showToast("Can't delete the default category");return;}
  if(!confirm(`Delete "${cat.name}"?`))return;
  categories=categories.filter(c=>c.id!==editingCatId);
  saveCats();
  localStorage.setItem('art_hours_settings_saved',Date.now());
  renderCatList();closeCatSheet();showToast('Category deleted');
  pushSettingsToSheet();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOG SHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingDate=null;

function openLogSheet(dateStr=null,blank=false,prefillHours=null){
  editingDate=null;
  const existing=dateStr?data.find(d=>d.date===dateStr):null;
  if(existing){
    editingDate=existing.date;
    document.getElementById('logTitle').textContent=`Edit â€” ${toDDMMYYYY(existing.date)}`;
    document.getElementById('inputDate').value=existing.date;
    document.getElementById('inputDate').readOnly=true;
    document.getElementById('inputTarget').value=existing.target;
    document.getElementById('deleteBtn').style.display='block';
    // Load existing sessions
    renderSessionsList(existing.sessions);
  }else{
    const todayStr=toISO(new Date());
    const ds=dateStr||todayStr;
    document.getElementById('logTitle').textContent='Log Entry';
    document.getElementById('inputDate').value=ds;
    document.getElementById('inputDate').readOnly=!!dateStr&&!blank;
    document.getElementById('inputTarget').value=getDefaultTarget(ds);
    document.getElementById('deleteBtn').style.display='none';
    // Start with one empty session using default category
    renderSessionsList([{category:getDefaultCat().name,subcategory:'',hours:prefillHours||''}]);
  }
  updateSessionTotal();
  document.getElementById('logOverlay').classList.add('open');
  setTimeout(()=>document.querySelector('.session-hours-input')?.focus(),150);
}

function closeLogSheet(){
  document.getElementById('logOverlay').classList.remove('open');
  document.getElementById('inputDate').readOnly=false;
}

function onDateChange(){
  const ds=document.getElementById('inputDate').value;
  if(ds&&!editingDate){
    document.getElementById('inputTarget').value=getDefaultTarget(ds);
  }
}

function renderSessionsList(sessions){
  document.getElementById('sessionsList').innerHTML='';
  sessions.forEach(s=>addSessionRow(s));
}

function addSession(){
  addSessionRow({category:getDefaultCat().name,subcategory:'',hours:''});
  updateSessionTotal();
}

function addSessionRow(s){
  const list=document.getElementById('sessionsList');
  const row=document.createElement('div');row.className='session-row';

  const catOptions=categories.map(c=>`<option value="${c.name}" ${c.name===s.category?'selected':''}>${c.name}</option>`).join('');
  const selCat=categories.find(c=>c.name===s.category)||categories[0];
  const subcatOptions=`<option value="">â€” subcategory â€”</option>`+
    (selCat?selCat.subcategories.map(x=>`<option value="${x}" ${x===s.subcategory?'selected':''}>${x}</option>`).join(''):'');

  row.innerHTML=`
    <button class="session-remove" onclick="removeSessionRow(this)">âœ•</button>
    <div class="session-row-top">
      <select class="session-select" onchange="onCatChange(this)">${catOptions}</select>
      <input class="session-hours-input" type="number" min="0" max="24" step="0.25"
        inputmode="decimal" placeholder="0h" value="${s.hours||''}" oninput="updateSessionTotal()">
    </div>
    <select class="session-select" style="width:100%">${subcatOptions}</select>`;
  list.appendChild(row);
}

function onCatChange(sel){
  const catName=sel.value;
  const cat=categories.find(c=>c.name===catName);
  const subcatSel=sel.closest('.session-row').querySelectorAll('.session-select')[1];
  if(subcatSel){
    subcatSel.innerHTML=`<option value="">â€” subcategory â€”</option>`+
      (cat?cat.subcategories.map(x=>`<option value="${x}">${x}</option>`).join(''):'');
  }
}

function removeSessionRow(btn){
  const rows=document.getElementById('sessionsList').querySelectorAll('.session-row');
  if(rows.length<=1){showToast('At least one session required');return;}
  btn.closest('.session-row').remove();
  updateSessionTotal();
}

function updateSessionTotal(){
  let total=0;
  document.querySelectorAll('.session-hours-input').forEach(inp=>{total+=(+inp.value||0);});
  document.getElementById('sessionTotal').textContent=total.toFixed(2).replace(/\.?0+$/,'');
}

function getSessionsFromForm(){
  const sessions=[];
  document.querySelectorAll('#sessionsList .session-row').forEach(row=>{
    const sels=row.querySelectorAll('.session-select');
    const hrs=+row.querySelector('.session-hours-input').value||0;
    sessions.push({
      category:sels[0]?sels[0].value:'General',
      subcategory:sels[1]?sels[1].value:'',
      hours:hrs
    });
  });
  return sessions.filter(s=>s.hours>0);
}

function saveEntry(){
  const dateVal=document.getElementById('inputDate').value;
  const targetVal=parseFloat(document.getElementById('inputTarget').value);
  if(!dateVal||isNaN(targetVal)){showToast('Fill in date and target');return;}
  const sessions=getSessionsFromForm();
  if(!sessions.length){showToast('Add at least one session with hours > 0');return;}
  const hours=sessions.reduce((s,x)=>s+x.hours,0);
  const entry=normalize({date:dateVal,hours,target:targetVal,sessions});
  // Capture streak before saving so we can detect if it breaks
  const prevStreak=computeStats().current;
  if(editingDate){const idx=data.findIndex(d=>d.date===editingDate);if(idx>=0)data[idx]=entry;}
  else{const idx=data.findIndex(d=>d.date===dateVal);if(idx>=0)data[idx]=entry;else data.push(entry);}
  saveData();closeLogSheet();render();
  // Show trash talk after a short delay so render completes first
  setTimeout(()=>showTrashTalk(entry, prevStreak), 300);
  const url=localStorage.getItem(SHEET_URL_KEY);
  if(url&&navigator.onLine){setSyncPill('syncing','âŸ³ syncingâ€¦');autoSync(url);}
}

async function deleteEntry(){
  if(!editingDate||!confirm(`Delete ${toDDMMYYYY(editingDate)}?`))return;
  const dateToDelete=editingDate;
  data=data.filter(d=>d.date!==dateToDelete);
  saveData();closeLogSheet();render();showToast('Deleted');
  const url=localStorage.getItem(SHEET_URL_KEY);
  if(url){
    if(navigator.onLine){
      setSyncPill('syncing','âŸ³ syncingâ€¦');
      try{await sheetFetch(url,{action:'deleteDate',date:dateToDelete});}catch(e){}
      autoSync(url);
    }
    triggerBgSync(); // ensure sync survives tab close
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportJSON(){
  const payload={
    version:2,
    exportedAt:new Date().toISOString(),
    categories,
    targets,
    data
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const d=new Date();
  const stamp=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
  a.href=url;a.download=`art_hours_backup_${stamp}.json`;a.click();
  URL.revokeObjectURL(url);showToast('JSON backup downloaded âœ“');
}

function exportCSV(){
  // Clean format â€” identical to Google Sheets download
  // No meta lines â€” interchangeable with Sheets CSV
  const rows=['Date,Day,Hours,Target,Result,Categories'];
  [...data].sort((a,b)=>a.date.localeCompare(b.date)).forEach(d=>{
    const cats=(d.sessions||[]).map(s=>`${s.category}${s.subcategory?'/'+s.subcategory:''}:${s.hours}h`).join(', ');
    rows.push(`${d.date},${d.day},${d.hours},${d.target},${d.result==='ðŸŸ¢'?'Met':'Missed'},"${cats}"`);
  });
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const d=new Date();
  const stamp=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
  const a=document.createElement('a');a.href=url;a.download=`art_hours_${stamp}.csv`;a.click();
  URL.revokeObjectURL(url);showToast('CSV downloaded âœ“');
}

function parseJSONBackup(text){
  const obj=JSON.parse(text);
  // Support version 2 (full export) and raw array (legacy)
  const entries=Array.isArray(obj)?obj:(obj.data||[]);
  if(obj.categories&&Array.isArray(obj.categories)&&obj.categories.length){
    categories=obj.categories;saveCats();
  }
  if(obj.targets&&typeof obj.targets==='object'&&Object.keys(obj.targets).length){
    targets=obj.targets;saveTargets();
  }
  let count=0;
  entries.forEach(imp=>{
    if(!imp.date)return;
    const entry=normalize(imp);
    const idx=data.findIndex(d=>d.date===entry.date);
    if(idx>=0)data[idx]=entry;else data.push(entry);
    count++;
  });
  return count;
}

function detectAndImport(text){
  const trimmed=text.trim();
  try{
    if(trimmed.startsWith('{')||trimmed.startsWith('[')){
      // JSON
      const count=parseJSONBackup(trimmed);
      return{count,format:'JSON'};
    }
  }catch(e){}
  // Fall back to CSV
  const count=parseCSVText(trimmed);
  return{count,format:'CSV'};
}

// Unified file import dispatcher â€” handles both JSON and CSV
function importFile(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const result=detectAndImport(ev.target.result);
      if(!result.count){showToast('No valid entries found');return;}
      saveData();render();
      showToast(`Imported ${result.count} entries from ${result.format} âœ“`);
      closeImportSheet();
    }catch(err){
      showToast('Import failed: '+err.message);
    }
  };
  reader.readAsText(file);
  e.target.value='';
}

function handleFileDrop(e){
  e.preventDefault();
  const dropZone=document.getElementById('dropZone');
  dropZone.style.borderColor='var(--border)';
  dropZone.style.background='';
  const file=e.dataTransfer.files[0];
  if(!file){return;}
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const result=detectAndImport(ev.target.result);
      if(!result.count){
        document.getElementById('importStatus').textContent='âœ— No valid entries found';
        document.getElementById('importStatus').style.color='var(--red)';
        return;
      }
      saveData();render();
      document.getElementById('importStatus').textContent=`âœ“ Imported ${result.count} entries from ${result.format}`;
      document.getElementById('importStatus').style.color='var(--green)';
      setTimeout(()=>closeImportSheet(),1500);
    }catch(err){
      document.getElementById('importStatus').textContent='âœ— '+err.message;
      document.getElementById('importStatus').style.color='var(--red)';
    }
  };
  reader.readAsText(file);
}

function splitCSVLine(line){
  // Proper CSV line splitter â€” handles quoted fields with commas inside
  const fields=[];let cur='',inQ=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"'){inQ=!inQ;}
    else if(c===','&&!inQ){fields.push(cur.trim());cur='';}
    else cur+=c;
  }
  fields.push(cur.trim());
  return fields.map(f=>f.replace(/^"|"$/g,'').trim());
}

function parseCSVText(text){
  const lines=text.trim().split('\n').filter(l=>l.trim());
  let count=0;
  // Extract legacy #CATEGORIES and #TARGETS meta lines (old app format)
  lines.forEach(line=>{
    if(line.startsWith('#CATEGORIES,')){
      try{
        const parsed=JSON.parse(line.slice('#CATEGORIES,'.length));
        if(Array.isArray(parsed)&&parsed.length){categories=parsed;saveCats();}
      }catch(e){}
    }else if(line.startsWith('#TARGETS,')){
      try{
        const parsed=JSON.parse(line.slice('#TARGETS,'.length));
        if(parsed&&typeof parsed==='object'){targets=parsed;saveTargets();}
      }catch(e){}
    }
  });
  // Find header row â€” detect column positions dynamically
  const dataLines=lines.filter(l=>!l.startsWith('#'));
  if(!dataLines.length) return count;

  // Header row â€” find column indices by name (case-insensitive)
  const headerFields=splitCSVLine(dataLines[0]).map(h=>h.toLowerCase().trim());
  const iDate   = headerFields.findIndex(h=>h==='date');
  const iHours  = headerFields.findIndex(h=>h==='hours');
  const iTarget = headerFields.findIndex(h=>h==='target');
  const iCats   = headerFields.findIndex(h=>h.includes('categor'));
  const iDay    = headerFields.findIndex(h=>h==='day');

  // If no recognisable header, assume fixed positions (legacy/manual CSV)
  const colDate   = iDate>=0   ? iDate   : 0;
  const colHours  = iHours>=0  ? iHours  : 2;
  const colTarget = iTarget>=0 ? iTarget : 3;
  const colCats   = iCats>=0   ? iCats   : 5;

  dataLines.slice(1).forEach(line=>{
    if(!line.trim()) return;
    const p=splitCSVLine(line);
    if(p.length<3) return;
    const date=p[colDate]||'';
    const hours=parseFloat(p[colHours]);
    const target=parseFloat(p[colTarget]);
    if(!date||isNaN(hours)||isNaN(target)) return;
    // Validate date format YYYY-MM-DD
    if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) return;

    const catCol=(p[colCats]||'').trim();
    const sessions=[];
    if(catCol){
      catCol.split(',').forEach(part=>{
        const m=part.trim().match(/^(.+):([0-9.]+)h?$/);
        if(m){
          const catPart=m[1].trim();
          const hrs=parseFloat(m[2]);
          const slash=catPart.indexOf('/');
          const category=slash>=0?catPart.slice(0,slash).trim():catPart;
          const subcategory=slash>=0?catPart.slice(slash+1).trim():'';
          if(!isNaN(hrs)&&hrs>0) sessions.push({category,subcategory,hours:hrs});
        }
      });
    }
    if(!sessions.length&&hours>0){
      const defCat=categories.find(c=>c.isDefault)||categories[0];
      if(defCat) sessions.push({category:defCat.name,subcategory:'',hours});
    }
    const entry=normalize({date,hours,target,sessions});
    const idx=data.findIndex(d=>d.date===date);
    if(idx>=0)data[idx]=entry;else data.push(entry);
    count++;
  });
  return count;
}

function openImportSheet(){document.getElementById('csvPasteArea').value='';document.getElementById('importStatus').textContent='';document.getElementById('importOverlay').classList.add('open');}
function closeImportSheet(){document.getElementById('importOverlay').classList.remove('open');}

async function importFromSheetsUrl(){
  const urlEl=document.getElementById('sheetsImportUrl');
  const statusEl=document.getElementById('sheetsUrlStatus');
  const url=urlEl.value.trim();
  if(!url){statusEl.textContent='âš  Paste a URL first';statusEl.style.color='var(--accent)';return;}

  // Validate it looks like a Sheets URL
  if(!url.includes('docs.google.com/spreadsheets')){
    statusEl.textContent='âœ— Doesn't look like a Google Sheets URL';
    statusEl.style.color='var(--red)';return;
  }

  // Convert any /edit or /view URL to published CSV URL if needed
  let fetchUrl=url;
  if(!url.includes('pub?')&&!url.includes('output=csv')){
    // Try to convert /d/SHEET_ID/edit â†’ /d/SHEET_ID/pub?output=csv
    const match=url.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
    if(match){
      fetchUrl=`https://docs.google.com/spreadsheets/d/${match[1]}/pub?output=csv`;
    }
  }

  statusEl.textContent='âŸ³ Fetchingâ€¦';statusEl.style.color='var(--accent)';

  try{
    const res=await fetch(fetchUrl,{redirect:'follow'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const text=await res.text();
    if(text.trim().startsWith('<')) throw new Error('Got HTML â€” make sure the sheet is published as CSV');

    const result=detectAndImport(text);
    if(!result.count) throw new Error('No valid entries found in sheet');

    saveData();render();
    statusEl.textContent=`âœ“ Imported ${result.count} entries`;
    statusEl.style.color='var(--green)';
    showToast(`Imported ${result.count} entries from Sheets âœ“`);
    setTimeout(()=>closeImportSheet(),1800);
  }catch(e){
    statusEl.textContent='âœ— '+e.message;
    statusEl.style.color='var(--red)';
    console.error('[SheetsImport]',e);
  }
}

function importFromPaste(){
  const text=document.getElementById('csvPasteArea').value.trim();
  const statusEl=document.getElementById('importStatus');
  if(!text){statusEl.textContent='âš  Nothing pasted';statusEl.style.color='var(--accent)';return;}
  try{
    const result=detectAndImport(text);
    if(!result.count){statusEl.textContent='âœ— No valid entries found';statusEl.style.color='var(--red)';return;}
    saveData();render();
    statusEl.textContent=`âœ“ Imported ${result.count} entries from ${result.format}`;
    statusEl.style.color='var(--green)';
    setTimeout(()=>closeImportSheet(),1500);
    showToast(`Imported ${result.count} entries âœ“`);
  }catch(err){
    statusEl.textContent='âœ— '+err.message;
    statusEl.style.color='var(--red)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOOGLE SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSheetSheet(){
  const saved=localStorage.getItem(SHEET_URL_KEY)||'';
  document.getElementById('sheetUrl').value=saved;
  const lastSync=localStorage.getItem('art_hours_last_synced');
  if(lastSync){
    const mins=Math.round((Date.now()-+lastSync)/60000);
    const label=mins<1?'just now':mins<60?`${mins}m ago`:`${Math.round(mins/60)}h ago`;
    document.getElementById('sheetStatus').textContent=`Last synced: ${label}`;
    document.getElementById('sheetStatus').style.color='var(--muted)';
  }else{
    document.getElementById('sheetStatus').textContent='';
  }
  document.getElementById('sheetOverlay').classList.add('open');
}
function closeSheetSheet(){document.getElementById('sheetOverlay').classList.remove('open');}
function getSheetUrl(){
  const url=document.getElementById('sheetUrl').value.trim();
  if(!url){setSheetStatus('âš  Enter your Web App URL','var(--red)');return null;}
  localStorage.setItem(SHEET_URL_KEY,url);return url;
}
function setSheetStatus(msg,color='var(--muted)'){const el=document.getElementById('sheetStatus');el.textContent=msg;el.style.color=color;}

async function gsheetSync(silent=false){
  const url=getSheetUrl();if(!url)return;
  if(!silent)setSheetStatus('Syncingâ€¦');
  setSyncPill('syncing','âŸ³ syncingâ€¦');
  try{
    const pushJson=await sheetFetch(url,{action:'sync',data});
    if(pushJson.error)throw new Error(pushJson.error);
    // Pull settings first â€” Sheet wins if newer
    const setJson=await sheetFetch(url,{action:'loadSettings'});
    const sheetT=setJson.savedAt?+new Date(setJson.savedAt):0;
    const localT=+(localStorage.getItem('art_hours_settings_saved')||0);
    if(setJson.categories&&setJson.categories.length&&sheetT>=localT){
      categories=setJson.categories;localStorage.setItem(CATS_KEY,JSON.stringify(categories));
    }
    if(setJson.targets&&Object.keys(setJson.targets).length&&sheetT>=localT){
      targets=setJson.targets;localStorage.setItem(TARGETS_KEY,JSON.stringify(targets));
    }
    // Push current settings
    await sheetFetch(url,{action:'saveSettings',categories,targets});
    localStorage.setItem('art_hours_settings_saved',Date.now());
    // Pull entries
    const pullJson=await sheetFetch(url,{action:'load'});
    if(pullJson.data&&pullJson.data.length){
      pullJson.data.forEach(imp=>{
        const idx=data.findIndex(d=>d.date===imp.date);
        const entry=normalize(imp);
        if(idx>=0)data[idx]=entry;else data.push(entry);
      });
      saveData();
    }
    render();
    setSyncPill('synced','âœ“ synced');
    localStorage.setItem('art_hours_last_synced',Date.now());
    if(!silent)setSheetStatus(`âœ“ Synced â€” ${pushJson.synced} entries Â· settings saved`,'var(--green)');
    showToast('Synced âœ“');
  }catch(e){setSyncPill('offline','âœ• sync failed');if(!silent)setSheetStatus(`âœ— ${e.message}`,'var(--red)');}
}

async function gsheetLoad(){
  const url=getSheetUrl();if(!url)return;
  setSheetStatus('Loadingâ€¦');
  try{
    const json=await sheetFetch(url,{action:'load'});
    if(json.error)throw new Error(json.error);
    if(!json.data||!json.data.length){setSheetStatus('Sheet is empty','var(--accent)');return;}
    json.data.forEach(imp=>{
      const idx=data.findIndex(d=>d.date===imp.date);
      const entry=normalize(imp);
      if(idx>=0)data[idx]=entry;else data.push(entry);
    });
    saveData();render();
    setSheetStatus(`âœ“ Loaded ${json.data.length} entries`,'var(--green)');showToast('Loaded âœ“');
  }catch(e){setSheetStatus(`âœ— ${e.message}`,'var(--red)');}
}

async function gsheetBackup(){
  const url=getSheetUrl();if(!url)return;
  if(!confirm(`Overwrite sheet with all ${data.length} entries?`))return;
  setSheetStatus('Backing upâ€¦');
  try{
    const clearJson=await sheetFetch(url,{action:'clear'});
    if(clearJson.error)throw new Error(clearJson.error);
    const json=await sheetFetch(url,{action:'sync',data});
    if(json.error)throw new Error(json.error);
    setSheetStatus(`âœ“ Backup complete â€” ${json.synced} rows`,'var(--green)');showToast('Backed up âœ“');
  }catch(e){setSheetStatus(`âœ— ${e.message}`,'var(--red)');}
}

function clearSheetUrl(){localStorage.removeItem(SHEET_URL_KEY);document.getElementById('sheetUrl').value='';setSheetStatus('Disconnected');setSyncPill('nosync','â—‹ no sync');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD & OVERLAY CLOSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    closeLogSheet();closeSheetSheet();closeImportSheet();
    closeBadgeSheet();closeCatSheet();
  }
});
['logOverlay','sheetOverlay','importOverlay','badgeOverlay','catSheet'].forEach(id=>{
  document.getElementById(id).addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('open');});
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMER ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RING_CIRC = 603; // 2Ï€ Ã— 96
let timerMode = 'pomodoro';

// â”€â”€ AUDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function beep(freq=880, dur=0.3, vol=0.3){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.frequency.value=freq;gain.gain.value=vol;
    osc.start();gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+dur);
    osc.stop(ctx.currentTime+dur);
  }catch(e){}
  if(navigator.vibrate)navigator.vibrate([200,100,200]);
}

function switchTimerMode(mode){
  timerMode=mode;
  ['pomodoro','stopwatch','countdown'].forEach(m=>{
    document.getElementById(`ttab-${m}`).classList.toggle('active',m===mode);
    document.getElementById(`timer-${m}`).style.display=m===mode?'block':'none';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POMODORO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pomoState = {
  running: false,
  phase: 'work',       // 'work' | 'break' | 'longbreak'
  cycle: 1,
  completedCycles: 0,
  remaining: 0,        // seconds
  total: 0,            // total work seconds accumulated
  workMin: 25,
  breakMin: 5,
  longMin: 15,
  cycleMax: 4,
  interval: null,
  startedAt: null,
};

function pomoApplySettings(){
  if(pomoState.running) return;
  pomoState.workMin   = +document.getElementById('pomoWorkMin').value  || 25;
  pomoState.breakMin  = +document.getElementById('pomoBreakMin').value || 5;
  pomoState.longMin   = +document.getElementById('pomoLongMin').value  || 15;
  pomoState.cycleMax  = +document.getElementById('pomoCycleCount').value || 4;
  pomoState.remaining = pomoState.workMin * 60;
  pomoState.phase     = 'work';
  pomoRenderAll();
}

function pomoToggle(){
  if(pomoState.running) pomoPause(); else pomoStart();
}

function pomoStart(){
  if(!pomoState.remaining) pomoState.remaining = pomoState.workMin * 60;
  pomoState.running  = true;
  pomoState.startedAt = Date.now();
  document.getElementById('pomoPlayBtn').textContent = 'â¸';
  setNavDot(true);
  pomoState.interval = setInterval(pomoTick, 1000);
}

function pomoPause(){
  pomoState.running = false;
  clearInterval(pomoState.interval);
  document.getElementById('pomoPlayBtn').textContent = 'â–¶';
  setNavDot(false);
  if(pomoState.total > 0) document.getElementById('pomoLogBtn').style.display = 'block';
}

function pomoReset(){
  clearInterval(pomoState.interval);
  pomoState = {...pomoState, running:false, phase:'work', cycle:1,
    completedCycles:0, total:0, remaining: pomoState.workMin*60, interval:null};
  document.getElementById('pomoPlayBtn').textContent = 'â–¶';
  document.getElementById('pomoLogBtn').style.display = 'none';
  setNavDot(false);
  pomoRenderAll();
}

function pomoSkip(){
  clearInterval(pomoState.interval);
  pomoAdvancePhase();
  if(pomoState.running) pomoStart();
}

function pomoTick(){
  // Compensate for drift using wall clock
  const elapsed = Math.floor((Date.now() - pomoState.startedAt) / 1000);
  pomoState.startedAt = Date.now();
  if(pomoState.phase === 'work') pomoState.total += elapsed;
  pomoState.remaining -= elapsed;
  if(pomoState.remaining <= 0){
    beep();
    pomoAdvancePhase();
    clearInterval(pomoState.interval);
    if(pomoState.running) pomoStart();
  }
  pomoRenderAll();
}

function pomoAdvancePhase(){
  if(pomoState.phase === 'work'){
    pomoState.completedCycles++;
    if(pomoState.completedCycles % pomoState.cycleMax === 0){
      pomoState.phase = 'longbreak';
      pomoState.remaining = pomoState.longMin * 60;
    } else {
      pomoState.phase = 'break';
      pomoState.remaining = pomoState.breakMin * 60;
    }
    pomoState.cycle = pomoState.completedCycles + 1;
  } else {
    pomoState.phase = 'work';
    pomoState.remaining = pomoState.workMin * 60;
  }
}

function pomoRenderAll(){
  const s = pomoState;
  const isWork = s.phase === 'work';
  const total  = isWork ? s.workMin*60 : s.phase==='break' ? s.breakMin*60 : s.longMin*60;
  const pct    = Math.max(0, s.remaining / total);
  const offset = RING_CIRC * (1 - pct);
  const color  = isWork ? 'var(--accent)' : 'var(--green)';

  document.getElementById('pomoRing').style.strokeDashoffset = offset;
  document.getElementById('pomoRing').style.stroke = color;
  document.getElementById('pomoTime').textContent  = fmtMS(s.remaining);
  document.getElementById('pomoLabel').textContent = isWork ? 'Focus' : s.phase==='longbreak' ? 'Long Break' : 'Break';
  document.getElementById('pomoLabel').style.color = color;
  document.getElementById('pomoPhase').textContent = `Cycle ${Math.min(s.completedCycles+1, s.cycleMax)}`;
  document.getElementById('pomoWorkTotal').textContent = fmtMS(s.total);
  document.getElementById('pomoSessions').textContent  = s.completedCycles;

  // Cycle dots
  const dots = document.getElementById('pomoCycles');
  dots.innerHTML = '';
  for(let i=0;i<s.cycleMax;i++){
    const d=document.createElement('div');
    d.className='pomo-dot'+(i<s.completedCycles%s.cycleMax||s.completedCycles>0&&i<s.completedCycles?' done':i===s.completedCycles%s.cycleMax?' current':'');
    dots.appendChild(d);
  }
  if(s.total > 0) document.getElementById('pomoLogBtn').style.display = s.running ? 'none' : 'block';
}

function pomoLogSession(){
  const hrs = roundToQuarter(pomoState.total / 3600);
  if(hrs <= 0){showToast('No work time to log');return;}
  pomoReset();
  openLogSheet(null, false, hrs);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STOPWATCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let swState = {
  running: false,
  elapsed: 0,      // ms
  lapStart: 0,     // ms at last lap
  laps: [],
  interval: null,
  startedAt: null,
};

function swToggle(){
  if(swState.running) swPause(); else swStart();
}

function swStart(){
  swState.running  = true;
  swState.startedAt = Date.now() - swState.elapsed;
  document.getElementById('swPlayBtn').textContent = 'â¸';
  document.getElementById('swLapBtn').style.opacity = '1';
  setNavDot(true);
  swState.interval = setInterval(swTick, 100);
}

function swPause(){
  swState.running = false;
  clearInterval(swState.interval);
  document.getElementById('swPlayBtn').textContent = 'â–¶';
  if(swState.elapsed > 0) document.getElementById('swLogBtn').style.display = 'block';
  setNavDot(false);
}

function swReset(){
  clearInterval(swState.interval);
  swState = {...swState, running:false, elapsed:0, lapStart:0, laps:[], interval:null};
  document.getElementById('swPlayBtn').textContent = 'â–¶';
  document.getElementById('swLapBtn').style.opacity = '0.3';
  document.getElementById('swLogBtn').style.display = 'none';
  document.getElementById('swLapsList').innerHTML = '';
  document.getElementById('swTime').textContent = '0:00:00';
  document.getElementById('swRing').style.strokeDashoffset = RING_CIRC;
  setNavDot(false);
}

function swLap(){
  if(!swState.running) return;
  const lapTime = swState.elapsed - swState.lapStart;
  swState.laps.push({lap:lapTime, total:swState.elapsed});
  swState.lapStart = swState.elapsed;
  swRenderLaps();
}

function swTick(){
  swState.elapsed = Date.now() - swState.startedAt;
  const secs = swState.elapsed / 1000;
  // Ring animates over 60 min
  const pct = Math.min(1, secs / 3600);
  document.getElementById('swRing').style.strokeDashoffset = RING_CIRC * (1 - pct);
  document.getElementById('swTime').textContent = fmtHMS(secs);
}

function swRenderLaps(){
  const el = document.getElementById('swLapsList');
  el.innerHTML = swState.laps.map((l,i)=>`
    <div class="lap-item">
      <span class="lap-num">Lap ${i+1}</span>
      <span class="lap-time">${fmtHMS(l.lap/1000)}</span>
      <span class="lap-total">âˆ‘ ${fmtHMS(l.total/1000)}</span>
    </div>`).reverse().join('');
}

function swLogSession(){
  const hrs = roundToQuarter(swState.elapsed / 3600000);
  if(hrs <= 0){showToast('No time to log');return;}
  swReset();
  openLogSheet(null, false, hrs);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COUNTDOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cdState = {
  running: false,
  totalSecs: 0,
  remaining: 0,
  elapsed: 0,
  interval: null,
  startedAt: null,
  done: false,
};

function cdToggle(){
  if(cdState.running) cdPause();
  else if(cdState.remaining > 0) cdResume();
  else cdStart();
}

function cdStart(){
  const h = +document.getElementById('cdHours').value || 0;
  const m = +document.getElementById('cdMins').value  || 0;
  const total = h*3600 + m*60;
  if(!total){showToast('Set a duration first');return;}
  cdState.totalSecs = total;
  cdState.remaining = total;
  cdState.elapsed   = 0;
  cdState.done      = false;
  document.getElementById('cdInputs').style.display    = 'none';
  document.getElementById('cdRingWrap').style.display  = 'flex';
  document.getElementById('cdStatRow').style.display   = 'flex';
  document.getElementById('cdTarget').textContent = fmtMS(total);
  cdResume();
}

function cdResume(){
  cdState.running   = true;
  cdState.startedAt = Date.now();
  document.getElementById('cdPlayBtn').textContent = 'â¸';
  setNavDot(true);
  cdState.interval = setInterval(cdTick, 1000);
}

function cdPause(){
  cdState.running = false;
  clearInterval(cdState.interval);
  document.getElementById('cdPlayBtn').textContent = 'â–¶';
  setNavDot(false);
  if(cdState.elapsed > 0) document.getElementById('cdLogBtn').style.display = 'block';
}

function cdReset(){
  clearInterval(cdState.interval);
  cdState = {...cdState, running:false, remaining:0, elapsed:0, totalSecs:0, done:false};
  document.getElementById('cdPlayBtn').textContent = 'â–¶';
  document.getElementById('cdLogBtn').style.display  = 'none';
  document.getElementById('cdInputs').style.display  = 'flex';
  document.getElementById('cdRingWrap').style.display = 'none';
  document.getElementById('cdStatRow').style.display  = 'none';
  document.getElementById('cdTime').textContent = '0:00';
  document.getElementById('cdElapsed').textContent = '0:00';
  document.getElementById('cdRing').style.strokeDashoffset = 0;
  setNavDot(false);
}

function cdTick(){
  const elapsed = Math.floor((Date.now() - cdState.startedAt) / 1000);
  cdState.startedAt = Date.now();
  cdState.remaining -= elapsed;
  cdState.elapsed   += elapsed;
  if(cdState.remaining <= 0){
    cdState.remaining = 0;
    cdState.done = true;
    clearInterval(cdState.interval);
    cdState.running = false;
    document.getElementById('cdPlayBtn').textContent = 'â–¶';
    document.getElementById('cdLogBtn').style.display = 'block';
    setNavDot(false);
    beep(660, 0.5); setTimeout(()=>beep(880,0.5),600);
  }
  const pct = 1 - cdState.remaining / cdState.totalSecs;
  document.getElementById('cdRing').style.strokeDashoffset = RING_CIRC * (1-pct);
  document.getElementById('cdRing').style.stroke = cdState.done ? 'var(--green)' : 'var(--accent)';
  document.getElementById('cdTime').textContent    = fmtMS(cdState.remaining);
  document.getElementById('cdElapsed').textContent = fmtMS(cdState.elapsed);
}

function cdLogSession(){
  const hrs = roundToQuarter(cdState.elapsed / 3600);
  if(hrs <= 0){showToast('No time to log');return;}
  cdReset();
  openLogSheet(null, false, hrs);
}

// â”€â”€ SHARED HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtMS(secs){
  secs = Math.max(0, Math.floor(secs));
  const m = Math.floor(secs/60), s = secs%60;
  return `${m}:${String(s).padStart(2,'0')}`;
}
function fmtHMS(secs){
  secs = Math.max(0, Math.floor(secs));
  const h=Math.floor(secs/3600), m=Math.floor((secs%3600)/60), s=secs%60;
  return h>0 ? `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` : `${m}:${String(s).padStart(2,'0')}`;
}
function roundToQuarter(hrs){ return Math.round(hrs * 4) / 4; }

function setNavDot(on){
  document.getElementById('timerNavDot').classList.toggle('show', on);
  const fab = document.getElementById('fabBtn');
  if(fab) fab.classList.toggle('timer-active', on);
}

// Keep timer alive when page visibility changes
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden) return;
  // Re-sync all running timers on return (drift correction)
  if(pomoState.running) { pomoState.startedAt = Date.now(); }
  if(swState.running)   { swState.startedAt = Date.now() - swState.elapsed; }
  if(cdState.running)   { cdState.startedAt = Date.now(); }
});

// â”€â”€ INIT POMODORO FROM CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initTimerFromConfig(){
  const w = (typeof CFG_POMODORO_WORK  !== 'undefined') ? CFG_POMODORO_WORK  : 25;
  const b = (typeof CFG_POMODORO_BREAK !== 'undefined') ? CFG_POMODORO_BREAK : 5;
  const l = (typeof CFG_POMODORO_LONG  !== 'undefined') ? CFG_POMODORO_LONG  : 15;
  const c = (typeof CFG_POMODORO_CYCLES!== 'undefined') ? CFG_POMODORO_CYCLES: 4;
  document.getElementById('pomoWorkMin').value    = w;
  document.getElementById('pomoBreakMin').value   = b;
  document.getElementById('pomoLongMin').value    = l;
  document.getElementById('pomoCycleCount').value = c;
  pomoState.workMin  = w; pomoState.breakMin = b;
  pomoState.longMin  = l; pomoState.cycleMax = c;
  pomoState.remaining = w * 60;
  pomoRenderAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRASH TALK ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLAYER = {names:['Mani','Mani Kiran','MK'], pick(){ return this.names[Math.floor(Math.random()*this.names.length)]; }};

const MSGS = {
  // â”€â”€ CRUSHED IT (â‰¥1.8Ã— target) â€” 16 messages â”€â”€
  crushed: [
    {e:'ðŸ”¥',c:'green',m:(n,h,t)=>`${h}h. That's what I'm talking about, ${n}. Now don't get cocky â€” this is what you're supposed to do every single goddamn day.`},
    {e:'âš¡',c:'green',m:(n,h,t)=>`${h}h on the board, MK. Good. Now wipe that stupid smile off your face and show up tomorrow and do it again.`},
    {e:'ðŸ’ª',c:'green',m:(n,h,t)=>`Over target. ${n} actually showed the hell up today. Your future self is cautiously optimistic. Emphasis on cautiously.`},
    {e:'ðŸ”¥',c:'green',m:(n,h,t)=>`${h}h, Mani. Respectable. But Picasso didn't become Picasso with one good day. He did this shit every single day for decades. Can you?`},
    {e:'âœŠ',c:'green',m:(n,h,t)=>`${n} put in ${h}h. This is what separates you from the lazy bastards who only dream about being artists instead of becoming one.`},
    {e:'ðŸŽ¨',c:'green',m:(n,h,t)=>`${h}h of actual work, MK. That's the version of you that's going to make it. Don't you dare lose them tomorrow.`},
    {e:'âš¡',c:'green',m:(n,h,t)=>`${n}, ${h}h. Your sketchbook is slightly less ashamed of you today. Slightly.`},
    {e:'ðŸ”¥',c:'green',m:(n,h,t)=>`${h}h done. The masters didn't get there wishing, ${n}. They got there doing exactly this, every bloody day, forever. Keep. Going.`},
    {e:'ðŸ’¥',c:'green',m:(n,h,t)=>`${n} delivered ${h}h. Don't celebrate. Don't post about it. Shut the hell up and show up tomorrow.`},
    {e:'ðŸŽ¯',c:'green',m:(n,h,t)=>`Crushed the target, Mani. Good. Now ask yourself â€” why can't you do this every damn day? What's your excuse the other days?`},
    {e:'ðŸ”¥',c:'green',m:(n,h,t)=>`${h}h, MK. That's what hunger looks like. Now prove to me it wasn't a fluke.`},
    {e:'ðŸ’ª',c:'green',m:(n,h,t)=>`${n} actually put in the work today â€” ${h}h. I'm not impressed. I'm just less disappointed than usual.`},
    {e:'âš¡',c:'green',m:(n,h,t)=>`${h}h done, ${n}. Every hour you grind while others sleep is an hour closer to being the artist you claim you want to be.`},
    {e:'ðŸ”¥',c:'green',m:(n,h,t)=>`Above target, MK. This is the standard. Not the exception. Get used to living here.`},
    {e:'ðŸ’¥',c:'green',m:(n,h,t)=>`${h}h, Mani Kiran. This is what it looks like when you take your dream seriously. Now don't stop.`},
    {e:'ðŸŽ¨',c:'green',m:(n,h,t)=>`${h}h, ${n}. Good soldier. Now go sleep and do it again tomorrow â€” no excuses, no bullshit.`},
  ],

  // â”€â”€ MET EXACTLY (100%) â€” 12 messages â”€â”€
  exactmet: [
    {e:'ðŸ˜',c:'accent',m:(n,h,t)=>`Exactly ${h}h. The bare minimum, ${n}. You punched the clock and ran. A professional artist gives more than the goddamn minimum.`},
    {e:'ðŸ™„',c:'accent',m:(n,h,t)=>`${t}h. Congratulations on doing the absolute least, ${n}. Your future self is distinctly underwhelmed.`},
    {e:'ðŸ˜‘',c:'accent',m:(n,h,t)=>`On the dot. ${n}, you're treating your art career like a factory shift. Clock in, clock out, go home. That's not how pros are made.`},
    {e:'ðŸ’¤',c:'accent',m:(n,h,t)=>`Met. Just. MK, "just enough" has never produced a single great artist in history. Where the hell is your hunger?`},
    {e:'ðŸ˜’',c:'accent',m:(n,h,t)=>`${h}h and not a second more, ${n}. You hit the target and immediately stopped. That's the mindset of someone who'll be mediocre forever.`},
    {e:'ðŸ˜¤',c:'accent',m:(n,h,t)=>`Target met, Mani. Barely. Is this really the best you've got? Because if it is, you're in the wrong bloody business.`},
    {e:'ðŸ¥±',c:'accent',m:(n,h,t)=>`${h}h, MK. Fine. You did what was required and nothing more. You know who else does that? People who never go pro.`},
    {e:'ðŸ˜‘',c:'accent',m:(n,h,t)=>`Exactly on target, ${n}. The target is the floor, not the ceiling. Start treating it that way.`},
    {e:'ðŸ¥±',c:'accent',m:(n,h,t)=>`${h}h exactly, ${n}. Your target is the bare minimum required to not be a failure. It is not an achievement. It's the starting line.`},
    {e:'ðŸ˜’',c:'accent',m:(n,h,t)=>`Met, MK. Good. But the artists making real money aren't stopping at "met." Where's your drive? Where'd it go?`},
    {e:'ðŸ˜',c:'accent',m:(n,h,t)=>`${h}h on the dot, Mani. You did the minimum. Now go think about why you stopped there instead of pushing for more.`},
    {e:'ðŸ˜¤',c:'accent',m:(n,h,t)=>`${n}, you hit ${h}h and stopped. Every minute past your target is a minute investing in your future. You just chose not to invest today.`},
  ],

  // â”€â”€ CLOSE MISS (75â€“99%) â€” 16 messages â”€â”€
  closemiss: [
    {e:'ðŸ˜¤',c:'red',m:(n,h,t)=>`${h}h out of ${t}h, ${n}. Are you kidding me? You were SO bloody close and you still couldn't be bothered. What the hell stopped you?`},
    {e:'ðŸ¤¦',c:'red',m:(n,h,t)=>`${(t-h).toFixed(1)}h short, Mani. You couldn't hold on for ${(t-h).toFixed(1)} more hours? This is exactly why you're not a pro yet.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`Almost, ${n}. ALMOST. Almost doesn't fill a portfolio. Almost doesn't pay your bills. Almost doesn't make you a pro. Almost is failure with better PR.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${h}h when ${t}h was RIGHT THERE, MK. You quit on yourself with the finish line in sight. That's not a skill issue â€” that's a character issue.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${(t-h).toFixed(1)}h short, ${n}. That's all that stood between you and your goal. And you chose not to push through. I'm genuinely pissed off at you.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}/${t}h. You saw the finish line and sat down, Mani Kiran. A real artist doesn't do that. A quitter does.`},
    {e:'ðŸ˜¤',c:'red',m:(n,h,t)=>`So damn close, ${n}. But close is just failure with a ribbon on it. You didn't hit the target. Full stop.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${n}, ${h}h is not good enough. ${(t-h).toFixed(1)}h more and you'd have made it. Instead you gave up. I hope that feels as pathetic as it looks.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`Mani, ${h}h out of ${t}h. You were ${(t-h).toFixed(1)}h from not being a disappointment today. And you blew it.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${h}h, MK. I don't care that you were close. Close doesn't count. You missed. Own it. Do better tomorrow.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${(t-h).toFixed(1)} hours. That's the gap between who you are and who you want to be today, ${n}. You chose to stay on the wrong side of it.`},
    {e:'ðŸ¤¦',c:'red',m:(n,h,t)=>`${n}, you missed by ${(t-h).toFixed(1)}h. In what universe is that acceptable for someone who wants to be a professional artist? Fix your shit.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${(t-h).toFixed(1)}h short, MK. You were RIGHT THERE. What did you do instead? Because whatever it was, it wasn't worth your dream.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${n}, ${h}h. Artists who almost make it have days exactly like this â€” where they were close and still quit. Don't be that artist.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`Almost, Mani Kiran. But almost is the most heartbreaking word in any language. It means you had the chance and you didn't take it.`},
    {e:'ðŸ˜¤',c:'red',m:(n,h,t)=>`${n}, ${(t-h).toFixed(1)}h. That's the cost of your comfort today. Was it worth it? That gap is the gap between you and who you want to be.`},
  ],

  // â”€â”€ BAD MISS (40â€“74%) â€” 18 messages â”€â”€
  badmiss: [
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}h out of ${t}h. ${n}, what the actual hell are you doing? Your dream of going pro just died a little more today.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`${h}h, MK. That's an embarrassment. Your sketchbook deserves better. Your future clients deserve better. YOU deserve better â€” so why aren't you acting like it?`},
    {e:'ðŸ˜¤',c:'red',m:(n,h,t)=>`${n}, ${h}h when you needed ${t}h? You're half-assing your own goddamn dream. Let that sink in.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${h}h? Seriously?! There are hobbyists who put in more work than this, ${n}. You WANT to be a pro artist â€” so why the fuck don't you act like it?`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`Only ${h}h today, Mani. Every hour you skip is an hour some other artist used to get ahead of you. Sleep well with that thought.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${h}h out of ${t}h, ${n}. This is not the behaviour of someone going pro. This is the behaviour of someone who likes the IDEA of being an artist without doing the actual work.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`MK, ${h}h is a joke. Your sketchbook is judging you. Your future self is furious at you. And frankly, so am I.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`${h}h, ${n}. Did you even try today? Because from where I'm standing, it looks like you quit before you even started.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${n}, ${h}h. You logged it so you wouldn't feel guilty. But you should feel guilty. This is not practice â€” it's procrastination wearing a costume.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${h}h today, MK. You know what that produces? Sweet fuck all. That's not skill-building. That's time-wasting with extra steps.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`Mani Kiran â€” ${h}h. I'm not angry. I'm disgusted. You have a goal. You have a plan. And you chose to give ${h}h. Unacceptable.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}h, ${n}. That's ${Math.round(h/t*100)}% of your target. You gave ${Math.round(h/t*100)}% of yourself to your dream today. Does that make you proud? It shouldn't.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`${n}, every successful artist has days they wanted to quit. The difference? They didn't log ${h}h and call it a fucking day.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${h}h, MK. I know you can do better. This isn't a capability problem â€” this is a discipline problem. Sort your shit out.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`Mani, ${h}h. There are 12-year-olds on YouTube with a better work ethic than this. You want to be a pro? Start practising like one.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}h, MK. Your future self just looked back at today and shook their head in shame. Don't give them more reasons to be ashamed of you.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${n}, ${h}h. Do you think your favourite artist got to where they are with days like this? Do you actually believe that?`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`Mani Kiran, ${h}h. That's not dedication â€” that's dabbling. Dabblers don't go pro. Decide which one you are and act accordingly.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${n}, your parents don't know you're doing this. They're working themselves to the bone for a future they can't even see yet. And you gave it ${h}h today. That's what their sacrifice is worth to you?`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`You came from nothing, ${n}. No connections, no money, no safety net. This art career is the only door you have. And you're leaving it half open with ${h}h. Slam it open or someone else will.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`MK, ${h}h. There are people in your hometown who never got the chance you have right now. They'd kill for it. You're wasting it.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${n}, your mother doesn't know this is your plan. Imagine her face when she finds out â€” what do you want that moment to look like? ${h}h a day builds failure. Not a reveal.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`You didn't grow up with money, ${n}. You grew up with hunger. Where the hell did that hunger go? Because ${h}h doesn't look like someone who's hungry for anything.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${n}, ${h}h. A man who came from nothing and wants to be something doesn't stop at ${h}h. He doesn't know how to stop. You're still learning how to start.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}h, MK. Be honest â€” is this how a man who's serious about his craft behaves? Or is this how someone behaves who's playing at being serious?`},
  ],

  // â”€â”€ TERRIBLE (<40%) â€” 22 messages â”€â”€
  terrible: [
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}h. ${n}, are you fucking serious? Did you open your sketchbook just to remind it you exist? Because that's all this is. Pathetic.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`${h} hours. Out of a ${t}h goal. MK, I've seen more goddamn effort from people who don't even want to be artists. What is wrong with you?`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${n}, ${h}h is an insult to the craft. An insult to your future self. An insult to every artist who ever bled for their work. Disgusting.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${h}h, ${n}? That's not practice. That's a goddamn tragedy. You cannot â€” CANNOT â€” become a pro artist with this level of output. Period.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${h} hours. ${n}, this is a disaster. This is the kind of day that defines whether you make it or not. And today? You failed. Completely.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${n}, ${h}h. You know what ${h} hours of practice produces? Absolutely fucking nothing. This is how mediocrity gets built, brick by brick.`},
    {e:'ðŸ˜¤',c:'red',m:(n,h,t)=>`MK, ${h}h. Sit with that. Is this who you are? Is this the artist you want to become? Because right now, this is exactly who you're becoming.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`${h}h out of ${t}h, ${n}. That's ${Math.round(h/t*100)}%. You gave ${Math.round(h/t*100)}% of yourself to your own dream. I hope the other ${100-Math.round(h/t*100)}% was worth it.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${n}, ${h}h is not practice. It's procrastination with extra steps. You want to go pro? Then act like a fucking professional.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h} hours, MK. The artists you look up to didn't get there by logging ${h}h days. They got there by refusing to accept it. Be better.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`Mani Kiran. ${h}h. I'm embarrassed for you. Your sketchbook is embarrassed. Your future portfolio doesn't exist yet because of days exactly like this.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${h}h, ${n}. That's your entire contribution to your dream today. Every artist who almost made it had days like this. That's why they almost made it.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${n}, ${h}h. I don't even want to look at you right now. Get out of here, think about what you did, and come back tomorrow ready to actually work.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`MK, ${h}h is a crime against your own potential. You have talent. You have a plan. And you spent today pissing it all away.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${n}, ${h}h. Write that number down. Look at it. That is the number of a hobbyist, not a pro. Not even close to a pro.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${h} pathetic hours, ${n}. You want to know why most artists never make it? Days like this. Days where they accepted less than what was required of them.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`Mani, ${h}h. Some artists would kill for the time you wasted today. Think about that before you log tomorrow.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${n}, ${h}h. I want you to be honest with yourself â€” is this the behaviour of someone going pro? Look at the number. The answer is no.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h} bloody hours, MK. That's your contribution to your dream today. ${h} hours. I'm disgusted and you should be too.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${n}, there's a version of you that works ${t}h every single day without complaint. Today you didn't even meet their shadow.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`Mani Kiran, ${h}h. The craft demands respect. The craft demands time. You gave it ${h}h today. The craft is not amused. Neither am I.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${n}, ${h}h. I'm done being shocked. This is a pattern. And patterns don't change unless YOU change. Fix it. Now.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}h, ${n}. Real men don't negotiate with their goals. They show up. ${h}h is negotiating. It's begging for just enough to feel okay about yourself.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${n}, ${h}h. You want to be the man who makes his family proud? Men who do that don't log ${h}h and call it practice. They bleed for it.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${h}h, MK. A man with nothing and everything to prove does not stop at ${h}h. He stops when it's done. You stopped early. That's not a man â€” that's a boy with excuses.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${n}, ${h}h. Your father worked with his hands for years so you could work with yours differently. He didn't raise you to log ${h}h and quit.`},
  ],

  // â”€â”€ STREAK MAINTAINED (3+ days) â€” 12 messages â”€â”€
  streakgood: [
    {e:'ðŸ”¥',c:'green',m:(n,days)=>`Day ${days} streak, ${n}. Don't you dare fucking break it now. You've come too far to throw it away for nothing.`},
    {e:'âš¡',c:'green',m:(n,days)=>`${days} days straight, Mani. This is what separates real artists from weekend hobbyists. Keep the chain alive or I swear to god.`},
    {e:'ðŸ’ª',c:'green',m:(n,days)=>`${days} day streak, MK. This consistency is going to compound into serious skill. Don't you dare ruin it.`},
    {e:'ðŸ”¥',c:'green',m:(n,days)=>`${days} days in a row, ${n}. Your future self is watching. Don't let them down. Don't let yourself down.`},
    {e:'âš¡',c:'green',m:(n,days)=>`${n}, ${days} consecutive days. You're building something real. Guard it like your life depends on it â€” because your career does.`},
    {e:'ðŸ”¥',c:'green',m:(n,days)=>`${days} days, MK. I'm watching that number. You should be too. Break it and prepare for the most brutal message you've ever received.`},
    {e:'ðŸ’€',c:'green',m:(n,days)=>`${days} day streak, ${n}. Beautiful. Now don't you dare come back tomorrow with a sob story about why you couldn't keep it going.`},
    {e:'ðŸ”¥',c:'green',m:(n,days)=>`${days} days, Mani. That's a habit forming. Protect it like it's the most important thing you own â€” because right now it is.`},
    {e:'âš¡',c:'green',m:(n,days)=>`${days} consecutive days, MK. I'm watching that number. Don't you dare be the reason it resets.`},
    {e:'ðŸ’ª',c:'green',m:(n,days)=>`${n}, ${days} days straight. This is the foundation of a career. Every day you add to it, you become harder to stop.`},
    {e:'ðŸ”¥',c:'green',m:(n,days)=>`${days} days, Mani Kiran. You've earned nothing yet â€” but you're building toward everything. Keep the chain.`},
    {e:'âš¡',c:'green',m:(n,days)=>`${days} day streak, MK. Good. Now stop reading this and go prep for tomorrow so you don't fucking break it.`},
  ],

  // â”€â”€ STREAK BROKEN â€” 14 messages â”€â”€
  streakbroken: [
    {e:'ðŸ’€',c:'red',m:(n,days)=>`You broke your ${days} day streak, ${n}. ${days} DAYS. Gone. I hope whatever the hell you did instead was worth it. It wasn't.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,days)=>`${days} days. GONE. Mani Kiran, you had something special and you threw it in the goddamn bin. For what? FOR WHAT?`},
    {e:'ðŸ¤¬',c:'red',m:(n,days)=>`Your ${days} day streak is dead, ${n}. You killed it with your own hands. I hope you're happy. You absolutely should not be.`},
    {e:'ðŸ˜¡',c:'red',m:(n,days)=>`MK, ${days} days of discipline and you just... stopped. That's not what pro artists do. That's what quitters do. Which one are you?`},
    {e:'ðŸ’¢',c:'red',m:(n,days)=>`${n}, your ${days} day streak is over. Every day you didn't practice, someone more disciplined than you was building their career. Think about that.`},
    {e:'ðŸ’€',c:'red',m:(n,days)=>`${days} days flushed, Mani. You were building real momentum and you chose to destroy it. Start over. Don't you dare waste this lesson.`},
    {e:'ðŸ¤¬',c:'red',m:(n,days)=>`Gone. Your ${days} day streak is dead and buried, ${n}. I'm not sugarcoating it â€” this is a failure. A real, actual failure. Learn from it.`},
    {e:'ðŸ˜¤',c:'red',m:(n,days)=>`Streak dead at ${days} days, MK. You know what hurts more than missing? Knowing you chose to. Because you did. You chose this.`},
    {e:'ðŸ’€',c:'red',m:(n,days)=>`${n}, ${days} days. Gone. I want you to feel every single one of those days you just threw away. Feel it. Now get the fuck back to work.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,days)=>`Mani Kiran, your ${days} day streak is finished. You had something to be proud of and you burned it to the ground. Absolutely unacceptable.`},
    {e:'ðŸ¤¬',c:'red',m:(n,days)=>`${days} days, MK. Dead. Whatever excuse you have â€” I don't want to hear it. There is no acceptable reason for killing a ${days} day streak.`},
    {e:'ðŸ’€',c:'red',m:(n,days)=>`${n}, ${days} days of your life invested in this streak. And you threw it away. I want you to rebuild it and never forget how this feels.`},
    {e:'ðŸ˜¡',c:'red',m:(n,days)=>`${days} days gone, Mani. The streak is dead. You killed it. Now the only question is: how long until you break the next one?`},
    {e:'ðŸ¤¬',c:'red',m:(n,days)=>`MK, ${days} days obliterated. Not by bad luck. Not by circumstance. By you. Own it, fix it, and don't you dare do it again.`},
    {e:'ðŸ’€',c:'red',m:(n,days)=>`${days} days gone, ${n}. Your parents are somewhere right now not knowing their son is trying to build something from nothing. You just set it back ${days} days. Rebuild. For them.`},
    {e:'ðŸ˜¡',c:'red',m:(n,days)=>`${n}, ${days} days. You broke it. You came from nothing, you have nothing to fall back on, and you broke the only thing that was working. Fix it before the gap becomes a grave.`},
    {e:'ðŸ’€',c:'red',m:(n,days)=>`${days} day streak dead, MK. Somewhere back home, people didn't get the chances you have. You got them and you wasted ${days} days of them. That should burn.`},
  ],

  // â”€â”€ COMEBACK (after gap) â€” 12 messages â”€â”€
  comeback: [
    {e:'ðŸ˜’',c:'accent',m:(n,days)=>`Oh, ${n} has returned. After ${days} days of doing god knows what. Welcome back. Now don't you dare disappear again.`},
    {e:'ðŸ™„',c:'accent',m:(n,days)=>`MK's back after ${days} days. Your sketchbook filed a missing persons report. Your future self is furious. Don't let this happen again.`},
    {e:'ðŸ˜¤',c:'accent',m:(n,days)=>`${days} days gone, ${n}. You think the artists you admire took ${days} day breaks from their craft? Get back to work and stay there.`},
    {e:'ðŸ˜‘',c:'accent',m:(n,days)=>`Back after ${days} days, Mani. I'll give you credit for returning. Barely. Now give me the performance to justify your absence.`},
    {e:'ðŸ˜’',c:'accent',m:(n,days)=>`${n}, ${days} days absent. Your art didn't miss you â€” you missed it. Now prove you deserve to call yourself an artist again.`},
    {e:'ðŸ˜¤',c:'accent',m:(n,days)=>`${days} days, MK. I don't want explanations. I want the target hit every single day from here on out. No more disappearing acts.`},
    {e:'ðŸ™„',c:'accent',m:(n,days)=>`Mani Kiran graces us with their presence after ${days} days. How generous. Now sit down and get to fucking work.`},
    {e:'ðŸ˜¤',c:'accent',m:(n,days)=>`${n}, ${days} days. You know what your competition did during those ${days} days? They practised. Every single one of them.`},
    {e:'ðŸ˜’',c:'accent',m:(n,days)=>`Back after ${days} days, MK. I'll allow it. Once. Pull this disappearing act again and we're going to have a very different conversation.`},
    {e:'ðŸ™„',c:'accent',m:(n,days)=>`${days} days absent, Mani. Your sketchbook was lonely. Your skills got rustier. Your dream got further away. Happy now? Then don't do it again.`},
    {e:'ðŸ˜‘',c:'accent',m:(n,days)=>`${n}, ${days} days. I'm not interested in the reasons. I'm only interested in whether it happens again. Make sure it doesn't.`},
    {e:'ðŸ˜¤',c:'accent',m:(n,days)=>`${days} days away, ${n}. Your craft didn't wait for you. Your competition didn't wait. And I certainly wasn't going to wait. Start logging. Now.`},
  ],

  // â”€â”€ NO STREAK â€” 8 messages â”€â”€
  nostreak: [
    {e:'ðŸ™„',c:'accent',m:(n)=>`No active streak, ${n}. You're at zero. Again. How many times are we going to reset this counter before you learn?`},
    {e:'ðŸ˜‘',c:'accent',m:(n)=>`${n}, you have no streak. Build one. Protect it. Lose it and I will be absolutely merciless.`},
    {e:'ðŸ˜’',c:'accent',m:(n)=>`Zero streak, Mani. That should make you uncomfortable. Let it. Use that discomfort.`},
    {e:'ðŸ˜¤',c:'accent',m:(n)=>`No streak, MK. Every day is a chance to start building one. Don't waste it like you have been.`},
    {e:'ðŸ˜‘',c:'accent',m:(n)=>`${n}, no streak. You know what a streak represents? Discipline. Something you clearly need more of.`},
    {e:'ðŸ™„',c:'accent',m:(n)=>`Zero streak, Mani Kiran. Build one and then be absolutely terrified of losing it. That fear is healthy. Use it.`},
    {e:'ðŸ˜’',c:'accent',m:(n)=>`No streak, MK. You have nothing to lose and everything to gain. So there is absolutely no excuse not to start one right now.`},
    {e:'ðŸ˜¤',c:'accent',m:(n)=>`${n}, zero streak days. Every master artist has a streak. Every amateur has an excuse. Which one are you going to be?`},
  ],
};

const MSGS_TE = {
  // â”€â”€ CRUSHED IT (â‰¥1.8Ã— target) â€” 16 messages â”€â”€
  crushed: [
    {e:'ðŸ”¥',c:'green',m:(n,h,t)=>`${h} gantalu, ${n}. Sari chesav. Ippudu aa stupid smile teeyyi mukhaan nundi â€” raapati kuda idi repeat cheyyaali. Ilaa prathi roju.`},
    {e:'âš¡',c:'green',m:(n,h,t)=>`${h}h chesav, Mani. Manchidi. Kani oka manci roju tho pro avutaamani anukuntunnava? Picasso decades chesaadu ee pani. Nuvvu?`},
    {e:'ðŸ’ª',c:'green',m:(n,h,t)=>`Target vadilipoyaav, ${n}. Manchidi. Nee future self cautiously happy ga undi â€” emphasis on cautiously. Raapati repeat cheyyy.`},
    {e:'ðŸ”¥',c:'green',m:(n,h,t)=>`${h}h, Mani Kiran. Idhe standard â€” exception kaadu. Ikkade live cheyyatam mà±Šdalupettu.`},
    {e:'âœŠ',c:'green',m:(n,h,t)=>`${n} ${h}h petti chesaadu. Idhee tà±‡daa nuvvu aa kalalu maatram maatlaadadam tho compare cheste. Idi real work. Continue cheyyy.`},
    {e:'ðŸŽ¨',c:'green',m:(n,h,t)=>`${h}h, MK. Nee sketch book intha varaku nee meedha thoroughly disappointed ga undi. Intha varaku maatrame. Raapati miss cheyyakuu.`},
    {e:'âš¡',c:'green',m:(n,h,t)=>`${n}, ${h}h chesav. Good soldier. Ippudu po nidra poyi raapati same energy tho raa â€” excuses lekundaa.`},
    {e:'ðŸ”¥',c:'green',m:(n,h,t)=>`${h}h, ${n}. Masters ila chesaaru â€” prathi roju, years kaalaa, without drama. Nuvvu chestunavaa ilaa? Prove cheyyy.`},
    {e:'ðŸ’¥',c:'green',m:(n,h,t)=>`${n} ${h}h deliver chesaadu. Celebrate cheyyakuu. Post cheyyakuu. Naakodaka, raapati raa ila.`},
    {e:'ðŸŽ¯',c:'green',m:(n,h,t)=>`Target crush chesav, ${n}. Manchidi. Ippudu oka question â€” migi rojulloo endi ila cheyyaleka poyaav? Ee answer nee daggare undi.`},
    {e:'ðŸ”¥',c:'green',m:(n,h,t)=>`${h}h, MK. Idhe hunger laaga untundi. Idi fluke kaadu ani prove cheyyy raapati.`},
    {e:'ðŸ’ª',c:'green',m:(n,h,t)=>`${n} today actual ga work chesaadu â€” ${h}h. Nenu impressed kaanu. Nee daggara usual kanna thoduga disappointed ga ledu â€” for now.`},
    {e:'âš¡',c:'green',m:(n,h,t)=>`${h}h, ${n}. Inkiti padukuntunnapudu nuvvu grind chesina prathi hour â€” nee dream ki closer chesindi. Adi remember cheyyy.`},
    {e:'ðŸ”¥',c:'green',m:(n,h,t)=>`Above target, MK. Idi norm avvaali â€” exception kaadu. Adjust cheyyy nee mind ni.`},
    {e:'ðŸ’¥',c:'green',m:(n,h,t)=>`${h}h, Mani. Nee dream ni seriously teesukuntunnappudu ila untundi. Ippudu aapakuu.`},
    {e:'ðŸŽ¨',c:'green',m:(n,h,t)=>`${h}h chesav, ${n}. Idhantha baagane undi. Kani raapati kuda ila chesaavante, aappudu maatrame nenu truly impressed avutaanu.`},
  ],

  // â”€â”€ MET EXACTLY (100%) â€” 12 messages â”€â”€
  exactmet: [
    {e:'ðŸ˜',c:'accent',m:(n,h,t)=>`Exactly ${h}h, ${n}. Bare minimum chesaav. Clock in chesaav, clock out chesaav, paaripoyaav. Pro artists ila cheyyaru raa.`},
    {e:'ðŸ™„',c:'accent',m:(n,h,t)=>`${t}h exactly. Congratulations on doing aa least possible, ${n}. Nee future self thoroughly underwhelmed ga undi.`},
    {e:'ðŸ˜‘',c:'accent',m:(n,h,t)=>`On the dot, Mani. Nee art career ni factory shift laaga treat chestunaav. Ila pros tiyyaraadu raa naakodaka.`},
    {e:'ðŸ’¤',c:'accent',m:(n,h,t)=>`Met. Just. MK, "just enough" tho history lo oka great artist kuda tiyyaleddu. Nee hunger ekkadiki poyindi?`},
    {e:'ðŸ˜’',c:'accent',m:(n,h,t)=>`${h}h and not a second more, ${n}. Hit chesaav, immediately aapesaav. Ee mindset tho mediocre ga undipotaav forever.`},
    {e:'ðŸ˜¤',c:'accent',m:(n,h,t)=>`Target met, Mani. Kaani barely. Ee game lo idi nee best ante, nuvvu wrong business lo unnav raa.`},
    {e:'ðŸ¥±',c:'accent',m:(n,h,t)=>`${h}h, MK. Sari. Required chesaav, more cheyyaleddu. Nuvvu enta mindset tho chesaav adi telusaa? Mediocre mindset.`},
    {e:'ðŸ˜‘',c:'accent',m:(n,h,t)=>`Target on the dot, ${n}. Target ante floor â€” ceiling kaadu. Ila treat cheyyatam mà±Šdalupettu.`},
    {e:'ðŸ¥±',c:'accent',m:(n,h,t)=>`${h}h exactly, ${n}. Nee target ante failure kaakumdaa minimum â€” achievement kaadu. It's the starting line, finish line kaadu.`},
    {e:'ðŸ˜’',c:'accent',m:(n,h,t)=>`Met, MK. Manchidi. Kaani real money chesà±‡ artists "met" daggara aaparu. Nee drive ekkadiki poyindi? Back tecchukooo.`},
    {e:'ðŸ˜',c:'accent',m:(n,h,t)=>`${h}h on the dot, Mani. Minimum chesaav. Ippudu think cheyyy â€” enduku ikkada aapesaav? Ink kaadu.`},
    {e:'ðŸ˜¤',c:'accent',m:(n,h,t)=>`${n}, ${h}h chesaav aapesaav. Target daataaka prathi minute nee future lo invest avutundi. Nuvvu today choose cheyyaleddu. Naakodaka.`},
  ],

  // â”€â”€ CLOSE MISS (75â€“99%) â€” 16 messages â”€â”€
  closemiss: [
    {e:'ðŸ˜¤',c:'red',m:(n,h,t)=>`${h}h out of ${t}h, ${n}. Nuvvu serious ga? Chaaaaaala daggaraga unnav aapesaav. Emi aapindi nee ni?`},
    {e:'ðŸ¤¦',c:'red',m:(n,h,t)=>`${(t-h).toFixed(1)}h short, Mani. Aa ${(t-h).toFixed(1)} gantalu hold cheyyaledaav? Exactly idhe reason nuvvu inka pro kaaduu.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`Almost, ${n}. ALMOST. Almost tho portfolio nadustvundaa? Bills kadutuundaa? Almost ante better PR tho failure, inka emi kaadu.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${h}h when ${t}h RIGHT THERE unnadi, MK. Finish line kanipistuunnapudu quit chesaav. Ee problem skill kaadu â€” character problem.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${(t-h).toFixed(1)}h short, ${n}. Ade nee goal ki madhya unnadi. Nuvvu push through cheyyaleddu. Naaku nee meedha genuine ga kopam vastuundi.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}/${t}h. Finish line kanipistuunnapudu kalichaav, Mani Kiran. Real artist ila cheyyadu. Quitter ila chestadu.`},
    {e:'ðŸ˜¤',c:'red',m:(n,h,t)=>`So close, ${n}. Kaani close ante ribbon tho failure maatrame. Target hit cheyyaleddu. Full stop.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${n}, ${h}h chaaladu. ${(t-h).toFixed(1)}h ekkuva chesthe avutundi. Instead give up chesaav. Adi paathara ga feel avutundaa? Avvaali.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`Mani, ${h}h out of ${t}h. ${(t-h).toFixed(1)}h matrame today failure kaakunda taapinchettindi. Nuvvu aa side choose chesaav.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${h}h, MK. Close unnav ani care cheyyanu. Miss chesaav. Own it. Tomorrow better cheyyy.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${(t-h).toFixed(1)} gantalu. Ade gap nuvvu unnav, nuvvu avvaali à°…à°¨à±kunna person ki madhya, ${n}. Nuvvu wrong side choose chesaav.`},
    {e:'ðŸ¤¦',c:'red',m:(n,h,t)=>`${n}, ${(t-h).toFixed(1)}h tho miss chesaav. Pro artist avvaali à°…à°¨à±kunna vaaduiki idhi acceptable elaaa? Fix cheyyy nee shit.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${(t-h).toFixed(1)}h short, MK. RIGHT THERE unnav. Baduluga emi chesaav? Adento, nee dream worth ledu ledaa?`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${n}, ${h}h. Pro avvaalam ante miss chesina artists ila untaaru â€” close ga unnappudu kuda quit chestaru. Aa artist avvakuu.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`Almost, Mani Kiran. Kaani almost ante chance unnadi teeskoledu ani. Adhe painful word â€” almost.`},
    {e:'ðŸ˜¤',c:'red',m:(n,h,t)=>`${n}, ${(t-h).toFixed(1)}h. Ade nee today comfort ki cost. Worth unnada? Aa gap nuvvu avvaali à°…à°¨à±kunna person madhya gap.`},
  ],

  // â”€â”€ BAD MISS (40â€“74%) â€” 18 messages â”€â”€
  badmiss: [
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}h out of ${t}h. ${n}, emi chestunnav raa? Pro avutaanam ante nee dream intha varaku intha chesindi chachindi.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`${h}h, MK. Idhi embarrassment. Nee sketch book better deserve chestuundi. Nee future clients deserve chestunaaru. NUVVU deserve chestunaav â€” enduku ila act cheyyataleddu?`},
    {e:'ðŸ˜¤',c:'red',m:(n,h,t)=>`${n}, ${t}h kavali, ${h}h chesaav? Nee own dream ni half-ass chestunaav raa. Adi okasaari sochu.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${h}h? Seriously?! Hobbists kuda intha chestunnaru, ${n}. Pro artist avvaali antunnav â€” enduku ala act cheyyataleddu, naakodaka?`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${h}h maatrame today, Mani. Nuvvu skip chesina prathi hour lo inkoka artist nee meeda advance avutunnaru. Aa thought tho nidrapo.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${h}h out of ${t}h, ${n}. Ee behaviour pro avutunna vaadidi kaadu. Artist avvataanike idea ni love chesina vaadidi, actual work chesindi kaadu.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`MK, ${h}h oka joke. Nee sketch book nee judge chestuundi. Nee future self furious ga undi. Naaku kuda kopam vastuundi.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`${h}h, ${n}. Ee roju try chesaavaa? Naaku chustey, start chesemundey quit chesaav.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${n}, ${h}h. Guilty feel avvakunda log chesaav. Kaani avvaali. Idi practice kaadu â€” disguise lo procrastination.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${h}h today, MK. Ee tho produce avyedi emi ledu. Idi skill building kaadu. Extra steps tho time waste.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${n}, ${h}h. Nee target lo half kuda ledu. Idi serious practice kaadu â€” idi nee dream ki betrayal.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`${h}h, Mani Kiran. Instagram lo pro artist laaga pose chestunaav, kaani ${h}h tho pro avutaavaa? Mathematics cheyyavaa?`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${n}, ${h}h. Nee competitors emi chestunnaru telusa ippudu? They're not logging ${h}h. They're eating your lunch.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${h}h today, MK. Nee sketch book, nee pencil, nee entire craft â€” anni nee ki waiting. Nuvvu ${h}h ichaav. Sorisipoyav.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${n}, ${h}h laaga chesaavoani feel avutundi kaani chesaavoani feel avvatadam chesyatadam kaadu. Naakodaka sala.`},
    {e:'ðŸ˜¤',c:'red',m:(n,h,t)=>`${h}h, Mani. Nee future self nee call chesthe busy signal vastundi â€” nuvvu too busy disappointing him chestunaav.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${n}, ${h}h. Oka roju ila chesthe okay. Rendu rojulu ila chesthe pattern. Moodurojulu ila chesthe â€” nuvvu fail avvadam choose chestunaav.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}h, MK. Nuvvu "artist" ani cheppukovadam band cheyyy â€” nuvvu prove chesemundi appudu maatrame adi truth.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${n}, nee amma nee gurinchi emi chestunaavo teliyadu. Adi teliyakapovadam valla inka painful â€” nuvvu aa trust ni ${h}h tho answer chestunaav. Adi worth unnada?`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`Nuvvu ekkadi nundi vacchaavo nee ki telusu, ${n}. Money ledu, backup ledu, safety net ledu. Ee oka door undi nee ki. ${h}h tho adi half open pettaav. Donga.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`MK, ${h}h. Nee hometown lo nee opportunity leeni vallu unnaru. Vaallaki ee chance ivvaledhu. Nuvvu teesukoni waste chestunaav. Sorisipoyav.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${n}, nee nanna enta kashtapaddaado nee ki full ga telidhu. Kaani aa kashta phalaalu nuvvu ${h}h tho use chestunaav. Adi deserve chesaadaa adi?`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`Nuvvu poverty nundi vacchaav, ${n}. Adi nee weakness kaadu â€” nee fire avvaali. Aa fire ippudu ekkadi undi? ${h}h lo kanipiyyataleddu.`},
  ],

  // â”€â”€ TERRIBLE (<40%) â€” 22 messages â”€â”€
  terrible: [
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}h?? ${n}, nuvvu serious ga? Ee amount tho nee dream survive cheyyatam ledu. Idi practice kaadu â€” idi insult.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`${h}h, MK. ${t}h target lo ${h}h. Nee sketch book nee chusthe "ee naakodaka naadaa?" ani anukuntundi. Sorisipoyav.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`Mani Kiran, ${h}h. Nee cat inka ekkuva work chestundi oka roju lo. CAT. Think about that.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${h}h, ${n}. Idhela "practice" antaaraa? Naaku artham kaatledu. Idi warm-up kuda ledu. Idi waste of a goddamn day.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${h}h, Mani. Sala, nee future clients nee work chusthe "ee bastard ki pay cheyyaali ana?" antaaru. Ila chesthe.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${n}, ${h}h. Nee ammoru kuda ippudu believe cheyyataleddu nee meedha. ${h}h, raa. Sorisipoyav levaraa.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`${h}h today, MK. Bekar fellow. Nee portfolio emi cheppukuntundi nee gurinchi? "Ee person ${h}h chesaadu" ani.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${n}, ${h}h. Nee target ${t}h. Nuvvu ${Math.round(h/t*100)}% chesaav. School lo idi fail. Art lo idi also fail. Naakodaka.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${h}h, Mani Kiran. Lavada, ee madhiri practice tho pro avutaanam antunnav? Nee confidence ekkadi nundi vastuundi?`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${h}h, ${n}. Idhi joke. Nee dream ni laugh track tho treat chestunaav. Ee roju nee career ki harm chesaav.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`MK, ${h}h. Nuvvu ee rojuala nee future self ki cheppedhi emi undi? "Nenu ${h}h chesaanu"? Adi hear chesukoni emi feel avutaadu?`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`${h}h, ${n}. Donga. Nee own time nundi, nee own dream nundi, nee own future nundi donga vestunaav â€” ee ${h}h tho.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${n}, ${h}h. Nee sketchbook pages empty ga unnaayi. Nee pencil crying chestuundi. Nee eraser kuda undo cheyyaleni roju idi.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${h}h, Mani. Ikkada applause ledu. Ikkada pity ledu. Ikkada unnadi oka question â€” enduku ila chestunaav?`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${n}, ${h}h. Nee target lo ${Math.round(h/t*100)}%. School percentages ki kuda idi fail avutundi. Nee art career percentage inka worse.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}h, MK. Pichi naakodaka. Nuvvu pro artist avvaali ani cheppukovadam band cheyyy â€” first prove cheyyy.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`${n}, ${h}h. Waste fellow. Ee roju nee ki jarigindi emi? Because idhi kaadu â€” idi nee career ki unna sab worst roju laaga untundi.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`${h}h, Mani Kiran. Nee future clients, nee future gallery, nee future self â€” andaram nee meedha angry ga unnaru ippudu. ${h}h valla.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${n}, ${h}h. Idi cheyyataanike nee phone petteyi, nee chair ki kalichaav, nee time waste chesaav. Idi artham kaadaa?`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${h}h, MK. Nee competitors celebrate chestunaaru intha varaku â€” nuvvu ${h}h chesaavani vinaaka. Adi hurt avvaali.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${n}, ${h}h. Ee roju nee life lo oka wasted page. Refund ledu. Redo ledu. Recycle kuda ledu. Just ${h}h of waste.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,h,t)=>`${h}h, Mani. Sala. Nee sketch book lock chesukuntundi nee nundi â€” nee protect cheyyaataanki.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${n}, nee amma nee gurinchi proud ga cheppukovaali oka roju. Adi she doesn't even know she's waiting for. ${h}h rojulu aa moment ni build cheyyavu â€” aa moment ni dà±‚ranga tostunnaayi.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${n}, ${h}h. Nee hood lo "vaadu emi avvaadu" annollu unnaaru. Nuvvu vaallaki proof istunnaav â€” ${h}h tho. Vaallani saraina chestunaav ippudu.`},
    {e:'ðŸ¤¬',c:'red',m:(n,h,t)=>`Mani, ${h}h. Money ledu, connections ledu, backup ledu â€” idi nee oka chance. Real ga nothing nundi vachchi something chesina vallu ${h}h chesaraa? Lunch mundhey ${h}h chesaaru vaalluu.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${n}, nee talli nee ee dream gurinchi teliyadu. Oka roju teliste proud avutundaa ledaa â€” adi nee meedha depend chestuundi. ${h}h aa roju ni build cheyyadu. Aa roju ni destroy chestuundi.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}h, MK. Poverty nee excuse kaadu â€” nee ki adi fuel avvaali. Nothing nundi something chesina vallu angry ga unnaaru, hungry ga unnaaru. Aa hunger ${h}h lo ekkada undi?`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${n}, oka roju nee amma discover chestuundi â€” nee son artist avvadam ki try chestunaadani. Aa roju nee eyes lo proud kaadu, tears unnaayi ani feel avvaali. ${h}h rojulu aa roju raakapovaniki karanam.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${h}h, ${n}. Magadu kaaduu nuvvu. Real Magadu ila cheyyadu â€” oka roju nee talli ki oka reason ivvaataaniki, oka roju nee nanna ki "naa koduku chesaadu" antaaniki. ${h}h tho adi jaraagadu.`},
    {e:'ðŸ˜¡',c:'red',m:(n,h,t)=>`${n}, ${h}h. Real Magadu tana goals tho negotiate cheyyadu. He shows up. ${h}h ante nuvvu negotiate chestunaav â€” nee ki okay feel cheyyataanike chaalaa. Adi Magadu kaadu.`},
    {e:'ðŸ’¢',c:'red',m:(n,h,t)=>`${h}h, MK. Nee nanna hands tho work chesaadu years ga â€” nuvvu nee hands tho differently work cheyyataanki. Vaadu nee ni ${h}h chesi quit cheyyataanki raise cheyyaledu.`},
    {e:'ðŸ’€',c:'red',m:(n,h,t)=>`${n}, ${h}h. Nothing nundi vachchi everything prove cheyyaali ante â€” aa Magadu ${h}h daggara aapadu. Pani avvovaraku aapadu. Nuvvu early aapesaav. Adi Magadu behavior kaadu.`},
  ],

  // â”€â”€ STREAK GOOD (3+ days) â€” 12 messages â”€â”€
  streakgood: [
    {e:'ðŸ”¥',c:'green',m:(n,days)=>`${days} rojulu, ${n}. Manchi. Ippudu aa number ni protect cheyyy â€” nee life lo most important thing laaga. Because right now, adi.`},
    {e:'âš¡',c:'green',m:(n,days)=>`${days} consecutive rojulu, MK. Aa number ni chustunna. Break cheyyakuu â€” naaku valla kaadu, nee ki valla.`},
    {e:'ðŸ’ª',c:'green',m:(n,days)=>`${n}, ${days} rojulu straight. Ee foundation meedha career build avutundi. Prathi roju add chesthe, aapataanki harder avutundi. Good.`},
    {e:'ðŸ”¥',c:'green',m:(n,days)=>`${days} rojulu, Mani Kiran. Inka earn cheyyaleddu â€” kaani everything ki build chestunaav. Chain ni keep cheyyy.`},
    {e:'âš¡',c:'green',m:(n,days)=>`${days} day streak, MK. Manchi. Ippudu ee message reading aapeyyi, raapati prep cheyyy so that nuvvu fucking break cheyyakuu adi.`},
    {e:'ðŸ’ª',c:'green',m:(n,days)=>`${n}, ${days} rojulu. Ee discipline nee career ki foundation. Oka roju miss chesthe â€” prathi roju adi feel chestuundi. Remember.`},
    {e:'ðŸ”¥',c:'green',m:(n,days)=>`${days} days streak, Mani. Scary ga feel avutundaa daan ni lose cheyyataanki? Avvaali. Aa fear ni use cheyyy.`},
    {e:'âš¡',c:'green',m:(n,days)=>`${n}, ${days} rojulu. Nee habits form avutunnaayi. Oka roju break chesthe â€” ee feeling ni remember cheyyy, so never do it.`},
    {e:'ðŸ’ª',c:'green',m:(n,days)=>`${days} day streak, MK. Nee competitors kuda ee same work chestunaaru. Difference â€” nuvvu more chestunaav. Keep it that way.`},
    {e:'ðŸ”¥',c:'green',m:(n,days)=>`${n}, ${days} rojulu straight. Ee streak nee best trophy ippudu. Wall meedha pettukoo â€” mind wall meedha. Break cheyyakuu.`},
    {e:'âš¡',c:'green',m:(n,days)=>`${days} days, Mani. Idhe momentum. Idi once lose chesthe teesukuravaatanki time padutundi. Protect cheyyy.`},
    {e:'ðŸ’ª',c:'green',m:(n,days)=>`${n}, ${days} day streak. Oka point vastuundi ikkada aapataanki nee ki impossible avutundi. Aa point ki reach cheyyy.`},
  ],

  // â”€â”€ STREAK BROKEN â€” 14 messages â”€â”€
  streakbroken: [
    {e:'ðŸ’€',c:'red',m:(n,days)=>`${n}, ${days} day streak break chesaav. ${days} ROJULU. Poyindi. Baduluga emi chesaav adi worth unnada? Ledu.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,days)=>`${days} rojulu. POYINDI. Mani Kiran, special ga unnadi teesukooni dustbin lo pettaav. Enduku raa?`},
    {e:'ðŸ¤¬',c:'red',m:(n,days)=>`Nee ${days} day streak dead, ${n}. Nuvve kill chesaav. Happy ga unnava? Avvaakoodadu. Absolutely avvaakoodadu.`},
    {e:'ðŸ˜¡',c:'red',m:(n,days)=>`MK, ${days} rojulu discipline, ippudu... aapesaav. Pro artists ila cheyyaru. Quitters ila chestaru. Which one?`},
    {e:'ðŸ’¢',c:'red',m:(n,days)=>`${n}, nee ${days} day streak over. Nuvvu miss chesina prathi roju oka disciplined artist nee meeda advance avvaadu. Sochu.`},
    {e:'ðŸ’€',c:'red',m:(n,days)=>`${days} rojulu flush chesaav, Mani. Real momentum unnadi, destroy chesukuntaavaa? Start over. Ee lesson waste cheyykuu.`},
    {e:'ðŸ¤¬',c:'red',m:(n,days)=>`Poyindi. Nee ${days} day streak dead and buried, ${n}. Sugar coat cheyyanu â€” idi failure. Real failure. Learn cheyyy.`},
    {e:'ðŸ˜¤',c:'red',m:(n,days)=>`Streak dead at ${days} days, MK. Miss cheyyataanki choose chesaav ani telusu. Choose chesaav. Own it.`},
    {e:'ðŸ’€',c:'red',m:(n,days)=>`${n}, ${days} rojulu. Poyindi. Aa prathi roju feel cheyyy â€” nuvvu throw away chesaav. Feel it. Ippudu work ki raa.`},
    {e:'ðŸ—‘ï¸',c:'red',m:(n,days)=>`Mani Kiran, nee ${days} day streak finished. Proud ga unna daani burn chesaav. Absolutely unacceptable raa.`},
    {e:'ðŸ¤¬',c:'red',m:(n,days)=>`${days} days, MK. Dead. Nee excuse vintaanu ledu. ${days} day streak kill chesataanki acceptable reason ledu. Emi ledu.`},
    {e:'ðŸ’€',c:'red',m:(n,days)=>`${n}, ${days} rojulu nee life invest chesaav. Throw away chesaav. Rebuild cheyyy â€” ee feeling eppudu forget cheyyakuu.`},
    {e:'ðŸ˜¡',c:'red',m:(n,days)=>`${days} rojulu gone, Mani. Streak dead. Nuvve kill chesaav. Ippudu question oka ede â€” next eppudu break chestunaav?`},
    {e:'ðŸ¤¬',c:'red',m:(n,days)=>`MK, ${days} rojulu obliterated. Bad luck valla kaadu. Circumstances valla kaadu. Nuvvu choose chesaav. Own it, fix it, inkeppudu cheyyakuu.`},
    {e:'ðŸ’€',c:'red',m:(n,days)=>`${days} rojulu gone, ${n}. Nee amma ekkadunnado nee ki telidhu â€” nee koduku oka dream build chestunaadani. Nuvvu aa ${days} rojullu set back chesaav adi. Rebuild cheyyy. Vaalla kosam.`},
    {e:'ðŸ˜¡',c:'red',m:(n,days)=>`${n}, ${days} rojulu. Nuvvu break chesaav. Nothing nundi vacchaavooo, backup ledu, oka ade door undi â€” anni telusu nee ki. Aa ${days} rojullu waste chesaav. Adi burn avvaali nee ki.`},
    {e:'ðŸ’€',c:'red',m:(n,days)=>`${days} day streak dead, MK. Nee hometown lo nee opportunities leeni vallu unnaaru. Nuvvu teesukoni ${days} rojullu waste chesaav. Aa thought tho nidrapo.`},
  ],

  // â”€â”€ COMEBACK (after gap) â€” 12 messages â”€â”€
  comeback: [
    {e:'ðŸ˜’',c:'accent',m:(n,days)=>`Oh, ${n} thirigochaadu. ${days} rojulu God knows emi chesaadu. Welcome back. Inkeppudu disappear avvakuu.`},
    {e:'ðŸ™„',c:'accent',m:(n,days)=>`MK ${days} rojula tarvata back. Nee sketch book missing persons report file chesindi. Nee future self furious. Inkeppudu ila cheyyakuu.`},
    {e:'ðŸ˜¤',c:'accent',m:(n,days)=>`${days} rojulu gone, ${n}. Nuvvu admire chesÄ“ artists ${days} roju breaks teesukuntaararaa? Po work cheyyy, ikkadey undo.`},
    {e:'ðŸ˜‘',c:'accent',m:(n,days)=>`${days} rojula tarvata back, Mani. Return chesaanik credit istunaanu. Barely. Ippudu absence justify chesÄ“ performance ivvuu.`},
    {e:'ðŸ˜’',c:'accent',m:(n,days)=>`${n}, ${days} rojulu absent. Nee art nee miss cheyyaledu â€” nuvvu miss chesaav adi ni. Ippudu artist ani call chesukodaaniki prove cheyyy.`},
    {e:'ðŸ˜¤',c:'accent',m:(n,days)=>`${days} rojulu, MK. Explanations veyyakuu. Target hit cheyyy, prathi roju, ikkadi nundi. No more disappearing acts, sala.`},
    {e:'ðŸ™„',c:'accent',m:(n,days)=>`Mani Kiran ${days} rojula tarvata graciousness chupiyinchaadu. How generous. Kaalichaav. Work cheyyy.`},
    {e:'ðŸ˜¤',c:'accent',m:(n,days)=>`${n}, ${days} rojulu. Nee competitors aa ${days} rojulloo emi chesaaru telusa? Practiced. Prathi single one of them.`},
    {e:'ðŸ˜’',c:'accent',m:(n,days)=>`${days} rojula tarvata back, MK. Allow istunaanu. Once. Inkeppudu ila disappear chesthe â€” very different conversation avutundi.`},
    {e:'ðŸ™„',c:'accent',m:(n,days)=>`${days} rojulu absent, Mani. Nee sketch book lonely ga undi. Nee skills rusty avyaayi. Nee dream further poyindi. Happy? Inkeppudu cheyyakuu.`},
    {e:'ðŸ˜‘',c:'accent',m:(n,days)=>`${n}, ${days} rojulu. Reasons interest kaadu naaku. Inkeppudu happen avutundaa ledu ani maatrame interest. Make sure ledu ani.`},
    {e:'ðŸ˜¤',c:'accent',m:(n,days)=>`${days} rojulu away, ${n}. Nee craft wait cheyyaledu. Competition wait cheyyaledu. Nenu wait cheyyaanu. Log cheyyy. Now.`},
  ],

  // â”€â”€ NO STREAK â€” 8 messages â”€â”€
  nostreak: [
    {e:'ðŸ™„',c:'accent',m:(n)=>`No streak, ${n}. Zero. Again. Ee counter enta saarllu reset cheyyistaamaa nuvvu learn avvadam mundu?`},
    {e:'ðŸ˜‘',c:'accent',m:(n)=>`${n}, streak ledu. Build cheyyy. Protect cheyyy. Lose chesthe nenu absolutely merciless ga untaanu.`},
    {e:'ðŸ˜’',c:'accent',m:(n)=>`Zero streak, Mani. Adi uncomfortable ga feel avvaali. Avvaali. Aa discomfort ni use cheyyy.`},
    {e:'ðŸ˜¤',c:'accent',m:(n)=>`No streak, MK. Prathi roju oka chance undi start chesataanki. Ila waste cheyyakuu.`},
    {e:'ðŸ˜‘',c:'accent',m:(n)=>`${n}, streak ledu. Streak ante emi telusaa? Discipline. Nee ki more kavali adi clearly.`},
    {e:'ðŸ™„',c:'accent',m:(n)=>`Zero streak, Mani Kiran. Build cheyyy, tarvata daan ni lose cheyyataanki absolutely terrified avvuu. Aa fear healthy â€” use it.`},
    {e:'ðŸ˜’',c:'accent',m:(n)=>`No streak, MK. Nuvvu lose chesataanki emi ledu, gain chesataanki everything undi. Excuse ledu start cheyyaataanki.`},
    {e:'ðŸ˜¤',c:'accent',m:(n)=>`${n}, zero streak days. Prathi master artist streak untundi. Prathi amateur daggara excuse untundi. Nuvvu entavutaav?`},
  ],
};



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GREETINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GREETINGS = {
  // bad miss streak 3+ days
  badStreak: {
    en: ["Again.","Still you.","Back to see the damage?","You again. Unfortunate.","Oh. It's you.","Witness to your own failure, again.","Still here. Still losing.","Back for more disappointment?"],
    te: ["Malli vachhaav.","Inka unnav.","Nuvvà±‡.","Oh. Nuvvu.","Thirigochhaav. Enduku?","Malli witness avvadam ki vachhaav?","Inka survive avutunnav, barely.","Vachhaav. Damage chudataanki."]
  },
  // 1-2 missed days
  recentMiss: {
    en: ["Don't make it a habit.","One more and it's a pattern.","Back. Barely counts.","Still showing up. Barely.","Don't disappear again.","You missed. Don't make it two.","One miss. That's allowed. Once.","Fix it today."],
    te: ["Habit cheyyakuu.","Inkoka miss chesthe pattern.","Vachhaav. Barely counts.","Inka show avutunnav.","Malli disappear avvakuu.","Miss chesaav. Rendu cheyyakuu.","Okasaari allowed. OkasaarÄ“.","Ippudu fix cheyyy."]
  },
  // good streak 5+ days
  goodStreakLong: {
    en: ["Don't ruin it.","Careful.","Still going. Don't stop now.","Streaks end when you relax.","One slip. That's all it takes.","Don't get comfortable.","You know how this ends if you stop.","Still alive. Keep it that way."],
    te: ["Break cheyyakuu.","Careful.","Inka continue cheyyy.","Relax chesthe streak povadam jarugtundi.","Oka slip. Adhe chaalu.","Comfortable avvakuu.","Aapthe emi jarugtundo telusu.","Inka unnav. IlÄgÄ“ undo."]
  },
  // streak 2-4 days
  goodStreakShort: {
    en: ["Something. Not enough.","Starting to look real.","Don't let it die early.","Mildly less embarrassing.","Two days. Anyone can do two days.","Keep going. Prove it's not a fluke.","Early days. Don't blow it.","It's something. Build on it."],
    te: ["Emaina chestunaav. Chaadu kaadu.","Real laaga kanipistundi. Kaani.","Chinnaga chanchoo.","Thakkuva embarrassing ippudu.","Rendu rojulu. Ellaaru cheyyagalaru.","Continue cheyyy. Fluke kaadu ani prove cheyyy.","Early days. Panikiraani cheyyakuu.","Emanna chestunaav. Build on it."]
  },
  // crushed it yesterday
  crushedYesterday: {
    en: ["Fluke.","Once means nothing.","Yesterday was decent. Today?","Don't think one good day fixes it.","Coincidence. Prove otherwise.","Yesterday happened. So what.","Good. Now do it again.","One day. The rest of your record disagrees."],
    te: ["Fluke.","Okasaari means nothing.","Ninna okay unnadi. Ippudu?","Oka roju tho fix avvaadu.","Coincidence. Prove cheyyy.","Ninna jarigindi. So what.","Manchidi. Malli cheyyy.","Oka roju. Migi record disagrees."]
  },
  // met exactly yesterday
  metYesterday: {
    en: ["Minimum. Again.","The bare minimum. As always.","Met. Not impressed.","You did the least. Again.","Target met. Barely matters.","Clock in, clock out. That's all you did.","Met. Now do more than that.","Exactly enough. Never more."],
    te: ["Minimum. Malli.","Bare minimum. Ela always.","Met. Impressed kaanu.","Least chesaav. Malli.","Target met. Barely matters.","Clock in, clock out. Adhe chesaav.","Met. Ippudu more cheyyy.","Exact ga chaalu. Ekkuva kaadu, eppudu."]
  },
  // close miss or bad miss yesterday
  missedYesterday: {
    en: ["Yesterday was a failure.","You missed. Remember that.","Yesterday happened. Fix it today.","Bad yesterday. Worse tomorrow if you don't fix it.","Failure. Don't romanticize it.","You let it slip yesterday.","It was right there. You quit.","Miss. Own it."],
    te: ["Ninna failure chesaav.","Miss chesaav. GurtuÐ¿ÐµttuÐºÐ¾.","Ninna jarigindi. Ippudu fix cheyyy.","Ninna bad. Fix cheyyakapothe inka worse.","Failure. Romanticize cheyyakuu.","Ninna slip chesaav.","Right there unnadi. Quit chesaav.","Miss. Own it."]
  },
  // no data or very early
  noData: {
    en: ["Start.","Log something.","Nothing yet. Unfortunate.","Empty. As expected.","No data. No record. Nothing.","Begin.","Zero. Make it one.","The record is blank. Fill it."],
    te: ["Start cheyyy.","Emaina log cheyyy.","Emi ledu. Unfortunate.","Empty. Expected ga.","Data ledu. Record ledu. Emi ledu.","Mà±Šdalupettu.","Zero. Oka daaniki cheyyy.","Record blank ga undi. Fill cheyyy."]
  },
  // default fallback
  default: {
    en: ["You again.","Mediocre as always.","Surviving, barely.","Still here.","Back again.","Another day.","Here we go.","As expected."],
    te: ["NuvvÄ“.","Mediocre, as always.","Inka unnav.","Inka ikkade.","Malli.","Inkoka roju.","Sari povaddam.","Expected ga."]
  }
};

function pickGreeting(state){
  const _gLang=(typeof getLangPref==='function')?getLangPref('greeting'):((typeof CFG_LANG_GREETING!=='undefined')?CFG_LANG_GREETING:'english');
  const useTe = _gLang==='telugu'||(_gLang==='mixed'&&Math.random()<0.5);
  const pool = GREETINGS[state] || GREETINGS.default;
  const arr = useTe ? pool.te : pool.en;
  return arr[Math.floor(Math.random()*arr.length)];
}

function getGreetingState(s){
  if(!data.length) return 'noData';
  const sorted=[...data].sort((a,b)=>a.date.localeCompare(b.date));
  const last=sorted[sorted.length-1];
  const now=new Date();now.setHours(0,0,0,0);
  const lastDt=new Date(last.date+'T00:00:00');
  const daysSinceLast=Math.round((now-lastDt)/864e5);

  // miss tail
  let missTail=0;
  for(let i=sorted.length-1;i>=0;i--){if(sorted[i].result==='ðŸ”´')missTail++;else break;}
  const totalMiss=missTail+Math.max(0,daysSinceLast);

  if(totalMiss>=3) return 'badStreak';
  if(totalMiss>=1) return 'recentMiss';
  if(s.current>=5) return 'goodStreakLong';
  if(s.current>=2) return 'goodStreakShort';
  // yesterday's result
  if(daysSinceLast<=1){
    const ratio=last.hours/last.target;
    if(ratio>=1.8) return 'crushedYesterday';
    if(ratio>=1.0) return 'metYesterday';
    if(ratio>=0.4) return 'missedYesterday';
    return 'missedYesterday';
  }
  return 'default';
}

function pickMsg(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

let _lastTrashMsg = '';
function getUniqueMsg(arr, n, ...args){
  let attempts=0, chosen;
  do {
    const item = pickMsg(arr);
    chosen = {e:item.e, c:item.c, text:item.m(n,...args)};
    attempts++;
  } while(chosen.text === _lastTrashMsg && attempts < 10);
  _lastTrashMsg = chosen.text;
  return chosen;
}

function showTrashTalk(entry, prevStreak){
  if(typeof CFG_TRASH_TALK !== 'undefined' && !CFG_TRASH_TALK) return;
  const lang = (typeof getLangPref==='function')?getLangPref('msgs'):((typeof CFG_LANG_MSGS!=='undefined')?CFG_LANG_MSGS:'english');
  const useTelugu = lang === 'telugu' || (lang === 'mixed' && Math.random() < 0.5);
  const ACTIVE_MSGS = useTelugu ? MSGS_TE : MSGS;
  const n = PLAYER.pick();
  const h = Math.round(entry.hours*10)/10;
  const t = entry.target;
  const pct = h/t;
  const s = computeStats();
  let chosen;

  // Determine which message pool
  if(prevStreak>=3 && s.current===0){
    chosen = getUniqueMsg(ACTIVE_MSGS.streakbroken, n, prevStreak);
  } else if(pct>=1.8){
    chosen = getUniqueMsg(ACTIVE_MSGS.crushed, n, h, t);
    if(s.current>=3){
      const sc = getUniqueMsg(ACTIVE_MSGS.streakgood, n, s.current);
      chosen.text += `

${sc.text}`;
    }
  } else if(pct>=1.0){
    chosen = getUniqueMsg(ACTIVE_MSGS.exactmet, n, h, t);
    if(s.current>=3){
      const sc = getUniqueMsg(ACTIVE_MSGS.streakgood, n, s.current);
      chosen.text += `

${sc.text}`;
    }
  } else if(pct>=0.75){
    chosen = getUniqueMsg(ACTIVE_MSGS.closemiss, n, h, t);
  } else if(pct>=0.4){
    chosen = getUniqueMsg(ACTIVE_MSGS.badmiss, n, h, t);
  } else {
    chosen = getUniqueMsg(ACTIVE_MSGS.terrible, n, h, t);
  }

  const el = document.getElementById('trashOverlay');
  const msgEl = document.getElementById('trashMsg');
  const emojiEl = document.getElementById('trashEmoji');
  const subEl = document.getElementById('trashSub');

  emojiEl.textContent = chosen.e;
  msgEl.className = `trash-msg ${chosen.c}`;
  // Split on double newline for two paragraph messages
  const parts = chosen.text.split('\n\n');
  msgEl.innerHTML = parts.map(p=>`<p style="margin-bottom:12px">${p}</p>`).join('');
  subEl.textContent = entry.result==='ðŸŸ¢' ? 'â€” Target Met' : `â€” ${h}h / ${t}h target`;

  el.classList.add('show');
  _trashHeld = false;
  clearTimeout(_trashTimer);
  _trashTimer = setTimeout(()=>dismissTrash(), 4000);
}

let _trashTimer = null;
let _trashHeld = false;

function trashHold(e){
  if(e) e.preventDefault();
  _trashHeld = true;
  clearTimeout(_trashTimer);
}

function trashRelease(){
  if(!_trashHeld) return;
  _trashHeld = false;
  dismissTrash();
}

function dismissTrash(){
  clearTimeout(_trashTimer);
  _trashHeld = false;
  const el=document.getElementById('trashOverlay');
  el.classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: HOME PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ home animation flag â”€â”€
let _homeAnimated = false;

function animateCount(el, targetVal, suffix, duration){
  const start = performance.now();
  const startVal = 0;
  function step(now){
    const p = Math.min(1,(now-start)/duration);
    const ease = p<0.5?2*p*p:(4-2*p)*p-1; // ease in-out
    const cur = startVal + (targetVal - startVal)*ease;
    el.textContent = Number.isInteger(targetVal) ? Math.round(cur)+suffix : cur.toFixed(1)+suffix;
    if(p<1) requestAnimationFrame(step);
    else el.textContent = targetVal+(Number.isInteger(targetVal)?'':'.0')+suffix;
  }
  requestAnimationFrame(step);
}

function buildCallout(s){
  // Compute all the numbers we need
  const sorted=[...data].sort((a,b)=>a.date.localeCompare(b.date));
  const _vLang=(typeof getLangPref==='function')?getLangPref('verdict'):((typeof CFG_LANG_VERDICT!=='undefined')?CFG_LANG_VERDICT:'english');
  const useTe = _vLang==='telugu'||(_vLang==='mixed'&&Math.random()<0.5);

  // Current miss tail
  let missTail=0;
  for(let i=sorted.length-1;i>=0;i--){if(sorted[i].result==='ðŸ”´')missTail++;else break;}
  const now2=new Date();now2.setHours(0,0,0,0);
  const lastDt=sorted.length?new Date(sorted[sorted.length-1].date+'T00:00:00'):now2;
  const unloggedDays=Math.max(0,Math.round((now2-lastDt)/864e5));
  const totalMiss=missTail+unloggedDays;

  // Month over month hit rate
  const moMap={};
  data.forEach(d=>{const mo=d.date.slice(0,7);if(!moMap[mo])moMap[mo]={met:0,total:0};moMap[mo].total++;if(d.result==='ðŸŸ¢')moMap[mo].met++;});
  const moKeys=Object.keys(moMap).sort();
  const moRates=moKeys.map(k=>Math.round(moMap[k].met/moMap[k].total*100));

  // Best vs current streak gap
  const streakGap=s.best-s.current;

  // Worst day of week
  const dayMap={};
  data.forEach(d=>{const dow=new Date(d.date+'T00:00:00').getDay();if(!dayMap[dow])dayMap[dow]={met:0,total:0};dayMap[dow].total++;if(d.result==='ðŸŸ¢')dayMap[dow].met++;});
  const DAYNAMES=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const DAYNAMES_TE=['Aadivaram','Somavaram','Mangalavaram','Budhavaram','Guruvaram','Shukravaram','Shanivaram'];
  let worstDay=null,worstRate=100;
  Object.entries(dayMap).forEach(([d,v])=>{if(v.total>=2){const r=Math.round(v.met/v.total*100);if(r<worstRate){worstRate=r;worstDay=+d;}}});

  // Would've been gap
  const idealTotal=sorted.reduce((sum,d)=>sum+d.target,0);
  const actualTotal=sorted.reduce((sum,d)=>sum+d.hours,0);
  const wbGap=Math.max(0,idealTotal-actualTotal);

  // Overall hit rate
  const hitRate=data.length?Math.round(data.filter(d=>d.result==='ðŸŸ¢').length/data.length*100):0;

  // Declining trend
  let declining=false,declineStr='';
  if(moRates.length>=3){
    const last3=moRates.slice(-3);
    if(last3[2]<last3[1]&&last3[1]<last3[0]){
      declining=true;
      declineStr=useTe
        ?`${moKeys.slice(-3).map((k,i)=>k.slice(5)+': '+last3[i]+'%').join(' â†’ ')}. Prathi nela worse avutundi.`
        :`${moKeys.slice(-3).map((k,i)=>k.slice(5)+': '+last3[i]+'%').join(' â†’ ')}. Every month worse than the last.`;
    }
  }

  // Pick callout â€” priority order
  let text='', stat='';

  if(totalMiss>=3){
    if(useTe){
      text=`${totalMiss} rojulu. Ippudu. Inka continue avutundi.`;
      stat=`Nuvvu ippudu miss streak lo unnav. Idi stop cheyyataanki oka roju maatrame kaavaali.`;
    } else {
      text=`${totalMiss} days. Right now. Still going.`;
      stat=`You are in an active miss streak. It takes one day to stop it. You haven't.`;
    }
  } else if(declining){
    if(useTe){
      text=`${declineStr}`;
      stat=`Idi bad patch kaadu. Idi direction.`;
    } else {
      text=declineStr;
      stat=`This is not a bad patch. This is a direction.`;
    }
  } else if(streakGap>=7&&s.best>=7){
    if(useTe){
      text=`Nee best streak ${s.best} rojulu unnadi. Last streak ${s.current} rojulu. Nuvvu worse avvaav.`;
      stat=`Aa ${s.best} roju build chesina person ekkadiki poyaadu?`;
    } else {
      text=`Best streak: ${s.best} days. Last streak: ${s.current} days. You got worse.`;
      stat=`The person who built that ${s.best} day streak â€” where did they go?`;
    }
  } else if(worstDay!==null&&worstRate<=40){
    const dn=useTe?DAYNAMES_TE[worstDay]:DAYNAMES[worstDay];
    if(useTe){
      text=`Nuvvu ${worstRate}% of ${dn}s fail chestunaav. Prathi week broken start avutundi.`;
      stat=`${dn} fix cheyyy, ledante prathi week already lost.`;
    } else {
      text=`You fail ${worstRate}% of ${dn}s. Every week starts broken.`;
      stat=`Fix ${dn} or accept that every week is already lost before it starts.`;
    }
  } else if(wbGap>=50){
    if(useTe){
      text=`${wbGap.toFixed(0)} gantalu behind. Lost kaadu. Choose chesaav.`;
      stat=`Prathi missed day oka choice â€” nee career ni aapadam choose chesaav.`;
    } else {
      text=`${wbGap.toFixed(0)} hours behind. Not lost. Chosen.`;
      stat=`Every missed day was a choice. You chose this gap.`;
    }
  } else if(hitRate<50&&data.length>=10){
    if(useTe){
      text=`More failures than successes. Adi nee record.`;
      stat=`${hitRate}% hit rate. Adi okasaari chuduu â€” ${100-hitRate}% rojulloo nuvvu fail ayyaav.`;
    } else {
      text=`More failures than successes. That is your record.`;
      stat=`${hitRate}% hit rate. ${100-hitRate}% of your days you failed. Read that.`;
    }
  } else if(moRates.length>=2&&moRates[moRates.length-1]<moRates[moRates.length-2]){
    const drop=moRates[moRates.length-2]-moRates[moRates.length-1];
    if(useTe){
      text=`Last month: ${moRates[moRates.length-2]}%. This month: ${moRates[moRates.length-1]}%. ${drop} points drop.`;
      stat=`Nuvvu improve avvatam ledu. Nuvvu decline avutunnav.`;
    } else {
      text=`Last month: ${moRates[moRates.length-2]}%. This month: ${moRates[moRates.length-1]}%. ${drop} point drop.`;
      stat=`You are not improving. You are declining.`;
    }
  } else {
    // Default â€” parents/poverty angle
    if(useTe){
      text=`Nee amma nee dream gurinchi teliyadu. Aa roju vastuundi â€” nuvvu adi elaanti ga chestunnav?`;
      stat=`Prathi roju oka answer â€” aa roju ki nuvvu ready ga unnava?`;
    } else {
      text=`Your mother doesn't know this is the plan. That day is coming. What will she see?`;
      stat=`Every day is an answer to that question.`;
    }
  }
  return {text, stat};
}

function renderHome(){
  const s=computeStats();
  const now=new Date();

  // â”€â”€ Greeting â€” personalized, left aligned â”€â”€
  const greetState=getGreetingState(s);
  document.getElementById('homeGreeting').textContent=pickGreeting(greetState);
  document.getElementById('homeDate').textContent=now.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).toUpperCase();

  // â”€â”€ Base numbers â”€â”€
  const sorted=[...data].sort((a,b)=>a.date.localeCompare(b.date));
  const idealTotal=sorted.reduce((sum,d)=>sum+d.target,0);
  const actualTotal=sorted.reduce((sum,d)=>sum+d.hours,0);
  const gap=Math.max(0,idealTotal-actualTotal);
  const hitRate=data.length?Math.round(data.filter(d=>d.result==='ðŸŸ¢').length/data.length*100):0;

  // â”€â”€ Days since last hit â”€â”€
  let daysSince=0;
  const nowD=new Date();nowD.setHours(0,0,0,0);
  for(let i=sorted.length-1;i>=0;i--){
    const d=sorted[i];
    if(d.result==='ðŸŸ¢'){
      const dt=new Date(d.date+'T00:00:00');
      daysSince=Math.round((nowD-dt)/864e5);
      break;
    }
    daysSince++;
  }
  if(!sorted.length) daysSince=0;
  const daysSinceColor=daysSince===0?'var(--green)':daysSince<=2?'var(--accent)':'var(--red)';

  // â”€â”€ Week form â€” last 7 logged days â”€â”€
  const last7=[...sorted].slice(-7);
  const weekFormEl=document.getElementById('hWeekForm');
  weekFormEl.innerHTML=last7.map(d=>d.result==='ðŸŸ¢'?'<span class="week-form-w">W</span>':'<span class="week-form-l">L</span>').join('');
  const weekWins=last7.filter(d=>d.result==='ðŸŸ¢').length;
  document.getElementById('hWeekStat').textContent=`${weekWins}W ${last7.length-weekWins}L`;

  // â”€â”€ Streak â”€â”€
  const streakEl=document.getElementById('hStreak');
  const streakLabel=document.getElementById('hStreakLabel');
  streakEl.textContent=s.current;
  document.getElementById('hStreakSub').textContent=`best ${s.best}`;
  if(s.current>=2){
    streakEl.className='home-hero-side-val streak-active';
    streakLabel.innerHTML=`<span class="streak-flame">ðŸ”¥</span> Streak`;
  } else {
    streakEl.className='home-hero-side-val accent';
    streakLabel.textContent='Streak';
  }

  // â”€â”€ Would've been â”€â”€
  document.getElementById('hWouldveSub').textContent=gap===0?'you are your ideal self':'behind your ideal self';
  document.getElementById('hWouldveActual').textContent=actualTotal.toFixed(1)+'h';
  document.getElementById('hWouldveIdeal').textContent=idealTotal.toFixed(1)+'h';
  document.getElementById('hWouldfeDays').innerHTML=`<strong style="color:var(--text)">${hitRate}%</strong> hit rate &nbsp;Â·&nbsp; <strong style="color:var(--text)">${data.length}</strong> days logged`;

  // â”€â”€ Callout â€” locked to today, one verdict per day â”€â”€
  const todayKey='verdict_'+new Date().toISOString().slice(0,10);
  let calloutText='', calloutStat='';
  try{
    const saved=localStorage.getItem('art_hours_verdict');
    const parsed=saved?JSON.parse(saved):null;
    if(parsed&&parsed.date===todayKey){
      calloutText=parsed.text; calloutStat=parsed.stat;
    } else {
      const callout=buildCallout(s);
      calloutText=callout.text; calloutStat=callout.stat;
      localStorage.setItem('art_hours_verdict',JSON.stringify({date:todayKey,text:calloutText,stat:calloutStat}));
    }
  } catch(e){
    const callout=buildCallout(s);calloutText=callout.text;calloutStat=callout.stat;
  }
  document.getElementById('calloutText').textContent=calloutText;
  document.getElementById('calloutStat').textContent=calloutStat;

  // â”€â”€ Monthly history â”€â”€
  renderMonthHistory();

  // â”€â”€ Animations â”€â”€
  const firstLoad=!_homeAnimated;
  if(firstLoad) _homeAnimated=true;

  const gapEl=document.getElementById('hWouldveGap');
  const daysEl=document.getElementById('hDaysSince');
  if(!firstLoad){
    // Return visit â€” set values instantly, callout stays visible
    daysEl.textContent=daysSince;
    daysEl.style.color=daysSinceColor;
    gapEl.textContent=gap.toFixed(1)+'h';
    document.getElementById('calloutCard').classList.add('visible');
    return;
  }

  // â”€â”€ SEQUENCED FIRST LOAD â”€â”€

  // Step 1 (100ms): days since counts up, then sonar pulse if red
  daysEl.textContent='0';
  daysEl.style.color=daysSinceColor;
  setTimeout(()=>{
    animateCount(daysEl, daysSince, '', 700);
    if(daysSince>0){
      // number pulses after count finishes
      setTimeout(()=>{
        daysEl.classList.add('pulse');
        setTimeout(()=>daysEl.classList.remove('pulse'),1100);
      },750);
    }
  },100);

  // Step 2 (600ms): streak fades + shakes if 0
  const streakCard=document.getElementById('hStreakCard');
  streakCard.style.opacity='0';
  streakCard.style.transition='opacity 0.3s ease';
  setTimeout(()=>{
    streakCard.style.opacity='1';
    if(s.current===0){
      setTimeout(()=>{streakCard.classList.add('streak-shake');setTimeout(()=>streakCard.classList.remove('streak-shake'),500);},300);
    }
  },600);

  // Step 3 (1100ms): would've been counts up
  gapEl.textContent='0h';
  const wbCard=gapEl.closest('.home-card');
  if(wbCard){wbCard.style.opacity='0';wbCard.style.transition='opacity 0.3s ease';}
  setTimeout(()=>{
    if(wbCard) wbCard.style.opacity='1';
    const dur=Math.min(2000,Math.max(800,gap*3));
    animateCount(gapEl,parseFloat(gap.toFixed(1)),'h',dur);
  },1100);

  // Step 4 (1900ms): callout slides in
  const cc=document.getElementById('calloutCard');
  cc.classList.remove('visible');
  setTimeout(()=>cc.classList.add('visible'),1900);
}

function renderMonthHistory(){
  const el=document.getElementById('monthHistoryList');
  if(!el)return;
  const months={};
  data.forEach(d=>{
    const dt=new Date(d.date+'T00:00:00');
    const key=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    if(!months[key])months[key]={year:dt.getFullYear(),month:dt.getMonth(),entries:[]};
    months[key].entries.push(d);
  });
  if(!Object.keys(months).length){el.innerHTML='<div style="color:var(--muted);font-size:0.62rem">No data yet.</div>';return;}

  // â”€â”€ Best month â”€â”€
  let bestMonthKey=null, bestMonthRate=0;
  Object.entries(months).forEach(([key,m])=>{
    const met=m.entries.filter(d=>d.result==='ðŸŸ¢').length;
    const rate=Math.round(met/m.entries.length*100);
    if(rate>bestMonthRate){bestMonthRate=rate;bestMonthKey=key;}
  });
  let bestMonthHtml='';
  if(bestMonthKey){
    const bm=months[bestMonthKey];
    bestMonthHtml=`<div style="margin-bottom:14px;font-size:0.62rem;color:var(--muted)">Best month: <strong style="color:var(--text);font-size:0.68rem">${MONTHS[bm.month]} ${bm.year}</strong> â€” <strong style="color:var(--green)">${bestMonthRate}%</strong></div>`;
  }

  const allMonthKeys=Object.keys(months).sort().reverse();
  const hasMore=allMonthKeys.length>3;
  const keysToShow=allMonthKeys.slice(0,3);

  const cardsHtml=keysToShow.map(key=>{
    const m=months[key];
    const total=m.entries.reduce((s,d)=>s+d.hours,0);
    const met=m.entries.filter(d=>d.result==='ðŸŸ¢').length;
    const rate=Math.round(met/m.entries.length*100);
    const borderCls=rate>=70?'border-green':rate>=40?'border-yellow':'border-red';
    const rateColor=rate>=70?'var(--green)':rate>=40?'var(--accent)':'var(--red)';
    let verdict,vcolor;
    if(rate>=80){verdict='Strong';vcolor='var(--green)';}
    else if(rate>=65){verdict='Decent';vcolor='var(--green)';}
    else if(rate>=50){verdict='Barely survived';vcolor='var(--accent)';}
    else if(rate>=30){verdict='Disaster';vcolor='var(--red)';}
    else{verdict='Catastrophe';vcolor='var(--red)';}
    const maxH=Math.max(...m.entries.map(d=>d.hours),1);
    const bars=m.entries.sort((a,b)=>a.date.localeCompare(b.date)).map(d=>`<div class="month-mini-bar" style="height:${Math.max(3,Math.round(d.hours/maxH*26))}px;background:${d.result==='ðŸŸ¢'?'var(--green)':'var(--red)'}"></div>`).join('');
    return `<div class="month-history-card ${borderCls}">
      <div>
        <div class="month-history-name">${MONTHS[m.month]} ${m.year}</div>
        <div class="month-history-verdict" style="color:${vcolor}">${verdict}</div>
        <div class="month-mini-chart">${bars}</div>
      </div>
      <div class="month-history-meta">
        <div style="font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:${rateColor}">${rate}%</div>
        <div>${met}/${m.entries.length} days</div>
        <div>${total.toFixed(1)}h</div>
      </div>
    </div>`;
  }).join('');

  const viewAllHtml=hasMore?`<div style="text-align:center;margin-top:10px"><button onclick="goToFullHistory()" style="background:none;border:none;color:var(--accent);font-size:0.58rem;font-family:'Space Mono',monospace;letter-spacing:1px;cursor:pointer;text-transform:uppercase;padding:8px 0;">View all ${allMonthKeys.length} months â†’</button></div>`:'';

  el.innerHTML=bestMonthHtml+cardsHtml+viewAllHtml;
}

function goToFullHistory(){
  showPage('analysis');
  switchAnalysis('chart');
  // scroll to history section after short delay for render
  setTimeout(()=>{
    const el=document.getElementById('monthHistorySection');
    if(el) el.scrollIntoView({behavior:'smooth',block:'start'});
  },200);
}

function renderFullMonthHistory(){
  const el=document.getElementById('chartMonthHistory');
  if(!el||!data.length){if(el)el.innerHTML='<div style="color:var(--muted);font-size:0.62rem">No data yet.</div>';return;}
  const months={};
  data.forEach(d=>{
    const dt=new Date(d.date+'T00:00:00');
    const key=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    if(!months[key])months[key]={year:dt.getFullYear(),month:dt.getMonth(),entries:[]};
    months[key].entries.push(d);
  });
  el.innerHTML=Object.keys(months).sort().reverse().map(key=>{
    const m=months[key];
    const total=m.entries.reduce((s,d)=>s+d.hours,0);
    const met=m.entries.filter(d=>d.result==='ðŸŸ¢').length;
    const rate=Math.round(met/m.entries.length*100);
    const borderCls=rate>=70?'border-green':rate>=40?'border-yellow':'border-red';
    const rateColor=rate>=70?'var(--green)':rate>=40?'var(--accent)':'var(--red)';
    let verdict;
    if(rate>=80)verdict='Strong';
    else if(rate>=65)verdict='Decent';
    else if(rate>=50)verdict='Barely survived';
    else if(rate>=30)verdict='Disaster';
    else verdict='Catastrophe';
    const maxH=Math.max(...m.entries.map(d=>d.hours),1);
    const bars=m.entries.sort((a,b)=>a.date.localeCompare(b.date)).map(d=>`<div class="month-mini-bar" style="height:${Math.max(3,Math.round(d.hours/maxH*26))}px;background:${d.result==='ðŸŸ¢'?'var(--green)':'var(--red)'}"></div>`).join('');
    return`<div class="month-history-card ${borderCls}">
      <div>
        <div class="month-history-name">${MONTHS[m.month]} ${m.year}</div>
        <div class="month-history-verdict" style="color:${rateColor}">${verdict}</div>
        <div class="month-mini-chart">${bars}</div>
      </div>
      <div class="month-history-meta">
        <div style="font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:${rateColor}">${rate}%</div>
        <div>${met}/${m.entries.length} days</div>
        <div>${total.toFixed(1)}h</div>
      </div>
    </div>`;
  }).join('');
}

function renderWeeklyCard(s){
  const el=document.getElementById('weeklyCard');
  const now=new Date();
  const dow=now.getDay();
  const monday=new Date(now);monday.setDate(now.getDate()-(dow===0?6:dow-1));monday.setHours(0,0,0,0);
  const dayLabels=['M','T','W','T','F','S','S'];
  const weekDays=[];
  for(let i=0;i<7;i++){
    const d=new Date(monday);d.setDate(monday.getDate()+i);
    const dateStr=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const entry=data.find(x=>x.date===dateStr);
    weekDays.push({label:dayLabels[i],dateStr,entry,isToday:d.toDateString()===now.toDateString(),isFuture:d>now});
  }
  const maxH=Math.max(...weekDays.map(d=>d.entry?d.entry.hours:0),1);
  const pct=s.weekTarget>0?Math.round(s.weekHours/s.weekTarget*100):0;
  const badge=pct>=100?'<span class="weekly-badge good">On Track</span>':pct>=70?'<span class="weekly-badge">Catching Up</span>':'<span class="weekly-badge bad">Behind</span>';

  const bars=weekDays.map(d=>{
    const h=d.entry?d.entry.hours:0;
    const t=d.entry?d.entry.target:0;
    const barH=Math.round(h/maxH*34);
    const color=d.isFuture?'var(--surface2)':d.entry?(d.entry.result==='ðŸŸ¢'?'var(--green)':'var(--red)'):'var(--surface2)';
    const dotColor=d.isToday?'var(--accent)':'transparent';
    return `<div class="weekly-day-cell">
      <div class="weekly-day-bar-wrap"><div class="weekly-day-bar" style="height:${barH}px;background:${color}"></div></div>
      <div class="weekly-day-dot" style="background:${dotColor}"></div>
      <div class="weekly-day-label">${d.label}</div>
    </div>`;
  }).join('');

  el.innerHTML=`
    <div class="weekly-header">
      <div class="weekly-title">${s.weekHours.toFixed(1)}h / ${s.weekTarget.toFixed(1)}h</div>
      ${badge}
    </div>
    <div class="weekly-days">${bars}</div>
    <div class="weekly-stats-row">
      <div class="weekly-stat"><div class="weekly-stat-val">${pct}%</div><div class="weekly-stat-label">Target Hit</div></div>
      <div class="weekly-stat"><div class="weekly-stat-val">${weekDays.filter(d=>d.entry&&d.entry.result==='ðŸŸ¢').length}</div><div class="weekly-stat-label">Days Met</div></div>
      <div class="weekly-stat"><div class="weekly-stat-val">${weekDays.filter(d=>d.entry&&d.entry.result==='ðŸ”´').length}</div><div class="weekly-stat-label">Days Missed</div></div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: SKILL SPLIT OVER TIME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSkillSplit(){
  const el=document.getElementById('skillSplitChart');
  if(!data.length){el.innerHTML='<div style="color:var(--muted);font-size:0.65rem;padding:16px 0">No data yet</div>';return;}
  // Group by month
  const months={};
  data.forEach(d=>{
    const mo=d.date.slice(0,7);
    if(!months[mo])months[mo]={};
    (d.sessions||[]).forEach(s=>{
      const cat=s.category||'General';
      months[mo][cat]=(months[mo][cat]||0)+(+s.hours||0);
    });
  });
  const moKeys=Object.keys(months).sort();
  if(moKeys.length<2){el.innerHTML='<div style="color:var(--muted);font-size:0.65rem;padding:8px 0">Need 2+ months of data</div>';return;}
  const allCats=[...new Set(data.flatMap(d=>(d.sessions||[]).map(s=>s.category||'General')))];
  const catColors={};categories.forEach(c=>{catColors[c.name]=c.color;});
  const BAR_H=12;const W=100;
  const rows=moKeys.map(mo=>{
    const total=Object.values(months[mo]).reduce((s,v)=>s+v,0)||1;
    let x=0;
    const segs=allCats.map(cat=>{
      const h=months[mo][cat]||0;const w=h/total*W;
      const seg=`<rect x="${x.toFixed(1)}" y="0" width="${w.toFixed(1)}" height="${BAR_H}" fill="${catColors[cat]||'#888'}" opacity="0.85"/>`;
      x+=w;return seg;
    }).join('');
    return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
      <div style="font-size:0.48rem;color:var(--muted);width:30px;flex-shrink:0">${mo.slice(5)}</div>
      <svg viewBox="0 0 100 ${BAR_H}" width="100%" height="${BAR_H}" preserveAspectRatio="none" style="flex:1;border-radius:1px;overflow:hidden">${segs}</svg>
      <div style="font-size:0.48rem;color:var(--muted);width:28px;text-align:right">${total.toFixed(0)}h</div>
    </div>`;
  }).join('');
  const legend=allCats.map(c=>`<div style="display:flex;align-items:center;gap:4px;font-size:0.48rem;color:var(--muted)"><div style="width:8px;height:8px;border-radius:1px;background:${catColors[c]||'#888'};opacity:0.85"></div>${c}</div>`).join('');
  el.innerHTML=`<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px">${legend}</div>${rows}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: SESSION LENGTH INTELLIGENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: DAY PATTERNS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDayPatterns(){
  const el=document.getElementById('dayPatternCard');
  if(data.length<7){el.innerHTML='<div style="color:var(--muted);font-size:0.65rem;padding:8px 0">Need more data for patterns</div>';return;}
  const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const dayMap={};
  days.forEach(d=>{dayMap[d]={met:0,missed:0,total:0,hours:0};});
  data.forEach(d=>{
    if(!dayMap[d.day])return;
    dayMap[d.day].total++;
    dayMap[d.day].hours+=d.hours;
    if(d.result==='ðŸŸ¢')dayMap[d.day].met++;else dayMap[d.day].missed++;
  });
  const sorted=days.filter(d=>dayMap[d].total>0);
  const best=sorted.reduce((b,d)=>dayMap[d].met/dayMap[d].total>dayMap[b].met/dayMap[b].total?d:b,sorted[0]);
  const worst=sorted.reduce((b,d)=>dayMap[d].met/dayMap[d].total<dayMap[b].met/dayMap[b].total?d:b,sorted[0]);
  const rows=days.map(d=>{
    const m=dayMap[d];if(!m||!m.total)return'';
    const pct=Math.round(m.met/m.total*100);
    const isBest=d===best,isWorst=d===worst;
    return`<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
      <div style="font-size:0.52rem;width:28px;color:${isBest?'var(--green)':isWorst?'var(--red)':'var(--muted)'};font-weight:${isBest||isWorst?'700':'400'}">${d}</div>
      <div style="flex:1;background:var(--surface2);border-radius:1px;height:14px;overflow:hidden">
        <div style="height:100%;width:${pct}%;background:${pct>=70?'var(--green)':pct>=40?'var(--accent)':'var(--red)'};border-radius:1px"></div>
      </div>
      <div style="font-size:0.48rem;color:var(--muted);width:28px;text-align:right">${pct}%</div>
      <div style="font-size:0.42rem;color:var(--muted);width:14px">${isBest?'ðŸ”¥':isWorst?'ðŸ’€':''}</div>
    </div>`;
  }).join('');
  el.innerHTML=`
    <div style="display:flex;gap:16px;margin-bottom:12px">
      <div><div class="home-card-label">Best Day</div><div style="font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;color:var(--green)">${best}</div><div class="home-card-sub">${Math.round(dayMap[best].met/dayMap[best].total*100)}% hit rate</div></div>
      <div><div class="home-card-label">Worst Day</div><div style="font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;color:var(--red)">${worst}</div><div class="home-card-sub">${Math.round(dayMap[worst].met/dayMap[worst].total*100)}% hit rate</div></div>
    </div>
    ${rows}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER: MONTH PATTERNS (which part of month is strongest)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMonthPatterns(){
  const el=document.getElementById('monthPatternCard');
  if(data.length<14){el.innerHTML='<div style="color:var(--muted);font-size:0.65rem;padding:8px 0">Need more data for month patterns</div>';return;}
  const thirds={early:{met:0,total:0},mid:{met:0,total:0},late:{met:0,total:0}};
  data.forEach(d=>{
    const day=parseInt(d.date.slice(8));
    const t=day<=10?'early':day<=20?'mid':'late';
    thirds[t].total++;
    if(d.result==='ðŸŸ¢')thirds[t].met++;
  });
  const labels={early:'Early (1â€“10)',mid:'Mid (11â€“20)',late:'Late (21â€“31)'};
  const rows=Object.entries(thirds).map(([k,v])=>{
    if(!v.total)return'';
    const pct=Math.round(v.met/v.total*100);
    return`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <div style="font-size:0.52rem;color:var(--muted);width:64px">${labels[k]}</div>
      <div style="flex:1;background:var(--surface2);border-radius:1px;height:14px;overflow:hidden">
        <div style="height:100%;width:${pct}%;background:${pct>=70?'var(--green)':pct>=40?'var(--accent)':'var(--red)'};border-radius:1px"></div>
      </div>
      <div style="font-size:0.52rem;color:var(--muted);width:28px;text-align:right">${pct}%</div>
    </div>`;
  }).join('');
  const best=Object.entries(thirds).filter(([,v])=>v.total>0).reduce((b,[k,v])=>v.met/v.total>thirds[b].met/thirds[b].total?k:b,'early');
  el.innerHTML=`<div style="font-size:0.58rem;color:var(--muted);margin-bottom:10px">You perform best in the <strong style="color:var(--accent)">${labels[best]}</strong> of the month.</div>${rows}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SWIPE NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const PAGES=['home','calendar','analysis','timer','settings'];
  let touchStartX=0,touchStartY=0,touchStartTime=0;
  const mainEl=document.body;

  mainEl.addEventListener('touchstart',e=>{
    touchStartX=e.touches[0].clientX;
    touchStartY=e.touches[0].clientY;
    touchStartTime=Date.now();
  },{passive:true});

  mainEl.addEventListener('touchend',e=>{
    const dx=e.changedTouches[0].clientX-touchStartX;
    const dy=e.changedTouches[0].clientY-touchStartY;
    const dt=Date.now()-touchStartTime;
    // Must be fast (<300ms), mostly horizontal (dx > 2Ã—dy), and long enough (>50px)
    if(dt>300||Math.abs(dx)<50||Math.abs(dx)<Math.abs(dy)*2)return;
    // Ignore if touch started inside a sheet overlay or timer
    if(e.target.closest('.sheet-overlay,.sheet,.trash-overlay'))return;
    const idx=PAGES.indexOf(currentPage);
    if(dx<0&&idx<PAGES.length-1) showPage(PAGES[idx+1]); // swipe left â†’ next
    if(dx>0&&idx>0)               showPage(PAGES[idx-1]); // swipe right â†’ prev
  },{passive:true});
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKGROUND SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function writePendingSync(url, dataToSync){
  try{
    const db = await new Promise((res,rej)=>{
      const r=indexedDB.open('art-hours-sw',1);
      r.onupgradeneeded=e=>e.target.result.createObjectStore('pending',{autoIncrement:true});
      r.onsuccess=e=>res(e.target.result);
      r.onerror=e=>rej(e);
    });
    const tx=db.transaction('pending','readwrite');
    tx.objectStore('pending').clear();
    tx.objectStore('pending').add({url,data:dataToSync});
  }catch(e){}
}

async function requestBackgroundSync(){
  try{
    const reg=await navigator.serviceWorker.ready;
    if(reg.sync) await reg.sync.register('sync-sheets');
  }catch(e){}
}

async function triggerBgSync(){
  const url=localStorage.getItem(SHEET_URL_KEY);
  if(!url) return;
  await writePendingSync(url, data);
  await requestBackgroundSync();
}

// Listen for SW success message
if(navigator.serviceWorker){
  navigator.serviceWorker.addEventListener('message',e=>{
    if(e.data&&e.data.type==='SYNC_SUCCESS') setSyncPill('synced','âœ“ synced');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENCRYPTION & UNLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SESSION_URL_KEY = 'art_hours_session_url';

async function deriveKey(passphrase, salt){
  const enc=new TextEncoder();
  const km=await crypto.subtle.importKey('raw',enc.encode(passphrase),'PBKDF2',false,['deriveKey']);
  return crypto.subtle.deriveKey(
    {name:'PBKDF2',salt,iterations:310000,hash:'SHA-256'},
    km,{name:'AES-GCM',length:256},false,['decrypt']
  );
}

async function decryptURL(b64, passphrase){
  const bytes=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
  const salt=bytes.slice(0,16);
  const iv=bytes.slice(16,28);
  const cipher=bytes.slice(28);
  const key=await deriveKey(passphrase,salt);
  const dec=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,cipher);
  return new TextDecoder().decode(dec);
}

async function unlockApp(){
  const pass=document.getElementById('unlockPass').value;
  const errEl=document.getElementById('unlockErr');
  const syncEl=document.getElementById('unlockSyncing');
  errEl.textContent='';
  if(!pass){errEl.textContent='Enter your passphrase';return;}

  try{
    const url=await decryptURL(CFG_ENCRYPTED_URL,pass);
    if(!url||!url.startsWith('https://')){
      errEl.textContent='Wrong passphrase â€” check caps lock and try again';return;
    }
    // Save decrypted URL to sessionStorage â€” cleared when tab closes
    sessionStorage.setItem(SESSION_URL_KEY,url);
    localStorage.setItem(SHEET_URL_KEY,url);

    // Try to sync before showing app
    syncEl.classList.add('show');
    if(navigator.onLine){
      try{
        setSyncPill('syncing','âŸ³ syncingâ€¦');
        await autoSync(url);
      }catch(e){
        setSyncPill('offline','âœ• sync failed');
        console.error('[Sync] autoSync failed after unlock:',e);
      }
    }else{
      setSyncPill('offline','âœ• offline â€” using local data');
    }
    syncEl.classList.remove('show');
    dismissUnlock();
  }catch(e){
    errEl.textContent='Wrong passphrase â€” check caps lock and try again';
    document.getElementById('unlockPass').value='';
    document.getElementById('unlockPass').focus();
  }
}

function unlockSkip(){
  dismissUnlock();
  setSyncPill('nosync','â—‹ no sync');
}

function dismissUnlock(){
  const el=document.getElementById('unlockScreen');
  el.classList.add('hide');
  setTimeout(()=>el.style.display='none',400);
}

function checkUnlock(){
  // Encryption disabled â€” skip unlock entirely
  if(!CFG_USE_ENCRYPTION||!CFG_ENCRYPTED_URL){
    // Fall back to Option A â€” use CFG_SHEET_URL or stored URL
    if(CFG_SHEET_URL&&!localStorage.getItem(SHEET_URL_KEY)){
      localStorage.setItem(SHEET_URL_KEY,CFG_SHEET_URL);
    }
    return false; // no unlock needed
  }

  // Check if URL already in sessionStorage (same tab session)
  const sessionUrl=sessionStorage.getItem(SESSION_URL_KEY);
  if(sessionUrl){
    localStorage.setItem(SHEET_URL_KEY,sessionUrl);
    return false; // already unlocked this session
  }

  // Check if URL in localStorage from previous unlock on this browser
  const storedUrl=localStorage.getItem(SHEET_URL_KEY);
  if(storedUrl){
    sessionStorage.setItem(SESSION_URL_KEY,storedUrl);
    return false; // already unlocked on this browser
  }

  // Need to unlock â€” show screen
  const el=document.getElementById('unlockScreen');
  el.style.display='flex';
  document.getElementById('unlockAppTitle').textContent=CFG_APP_NAME||'Art Hours';
  setTimeout(()=>document.getElementById('unlockPass').focus(),300);
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Check for migration
const needsMigration=migrateOldData();
if(needsMigration){
  data=loadData();
  document.getElementById('migrationOverlay').classList.add('open');
}else if(!localStorage.getItem(MIGRATED_KEY)){
  localStorage.setItem(MIGRATED_KEY,'1');
}

render();
initTimerFromConfig();

// Check unlock last â€” so app renders behind unlock screen
checkUnlock();
</script>
</body>
</html>
